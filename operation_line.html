<!-- =========================
OPERATION.HTML (copy + paste) ‚úÖ FINAL (Returning badge included)
‚úÖ Match INDEX behavior for:
- Mission Type display label (table)
- From/To mapping (including HHC_PICKUP, HHC_SEND)
- Details modal shows pins + Route buttons (Google Maps)
‚úÖ Keeps:
- Read-only dashboard + Operation stamp per mission
- Stamp Panel auto-selects pattern by typeKey
- Saves logs into localStorage (SCC_MISSIONS_V1) under mission.details.OperationStamp
- Realtime sync to index.html (BroadcastChannel + storage ping)
- ISO-8601 only (tsISO)
‚úÖ REQUIRED LOGIC (as you asked):
1) Stamp actual_departure -> mission.status = "Transporting"
2) If step matches shouldBeReturning(mm, stepKey) -> mission.status = "Returning"
3) Completed ONLY when ALL stamp steps are completed
   AND OperationStamp.status = "Completed" (auto)
========================= -->
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Operation</title>
<style>
  body{
    margin:0;
    background:#f4f6f8;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    text-align:center;
  }

  /* ===== TOPBAR + STATS (match index.html exactly) ===== */
  .topbar{
    background:white;
    box-shadow:0 4px 18px rgba(0,0,0,0.18);
    display:flex;
    align-items:center;
    gap:12px;
    padding:8px 14px;
  }

  .header{
    flex:0 0 auto;
    display:flex;
    align-items:center;
    justify-content:flex-start;
  }
  .header img{
    width:auto;
    height:70px;
    object-fit:contain;
    display:block;
  }

  .stats{
    display:flex;
    justify-content:flex-end;
    flex-wrap:wrap;
    gap:10px;
    margin-left:auto;
  }
  .stat{
    background:white;
    border-radius:12px;
    box-shadow:0 2px 8px rgba(0,0,0,0.12);
    padding:8px 14px;
    min-width:120px;
    text-align:center;
  }

  /* ===== Total (Year) = same size/typography as other stats, only soft grey bg ===== */
  .stat-year{
    background:#f3f4f6;
    box-shadow:0 2px 8px rgba(0,0,0,0.12);
  }

  /* ‚úÖ ‡∏≠‡∏¢‡πà‡∏≤ override font-size / weight ‡∏Ç‡∏≠‡∏á span,label */
  .stat-year span{ color:#006d5b; }
  .stat-year label{ color:#555; }

  .stat span{
    display:block;
    font-size:24px;
    font-weight:900;
    color:#006d5b;
    line-height:1.05;
  }
  .stat label{
    font-size:12px;
    color:#555;
  }

  .content{
  padding:6px 16px 20px;   /* ‡∏à‡∏≤‡∏Å 12 ‚Üí 6 */
  padding-bottom: calc(20px + env(safe-area-inset-bottom));
  max-width:1320px;
  margin:0 auto;
  text-align:left;
}

  h1{
    font-size:22px;
    font-weight:900;
    margin:10px 0 8px;
    text-align:center;
  }
  #clock{
    font-size:44px;
    font-weight:900;
    margin:4px 0 8px;
    text-align:center;
  }

  .actionbar{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    justify-content:space-between;
    margin:10px 0 14px;
  }
  .muted{ color:#6b7280; }

  .btn{
    appearance:none;
    border:0;
    border-radius:12px;
    padding:10px 14px;
    font-weight:900;
    cursor:pointer;
    background:#0b6b5b;
    color:white;
    box-shadow:0 3px 10px rgba(0,0,0,0.12);
  }
  .btn.secondary{ background:#111827; }
  .btn.light{
    background:#e5e7eb;
    color:#111827;
    box-shadow:none;
    font-weight:900;
  }
  .btn.tiny{
    padding:7px 10px;
    border-radius:10px;
    font-weight:900;
    font-size:12px;
    box-shadow:none;
  }
  .btn.danger{ background:#b42318; }

  /* ‚úÖ Badge-like pill buttons (same shape as status badge) */
  .btn.pill{
    padding:6px 10px;
    border-radius:999px;
    font-weight:900;
    font-size:12px;
    line-height:1;
    box-shadow:none;
    border:1px solid transparent;
  }
  /* ‚úÖ On Duty pill (green) */
  .btn.onDuty{
    background:#0b6b5b;
    color:#ffffff;
    border-color:#0b6b5b;
  }
  .btn.onDuty:hover{ filter:brightness(0.98); }

  /* ‚úÖ Time HH:MM pill (black) */
  .btn.timeDone{
    background:#111827;
    color:#ffffff;
    border-color:#111827;
  }
  .btn.timeDone:hover{ filter:brightness(0.95); }

  .card{
    background:#fff;
    border-radius:18px;
    box-shadow:0 4px 12px rgba(0,0,0,0.12);
    padding:16px;
  }
  .cardHeader{
    display:flex;
    gap:12px;
    flex-wrap:wrap;
    align-items:center;
    justify-content:space-between;
    margin-bottom:8px;
  }
  .cardTitle{
    font-size:16px;
    font-weight:900;
    color:#1f2937;
    margin:0;
  }
  .controls{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    justify-content:flex-end;
  }
  .input, .select{
    border:1px solid #e5e7eb;
    border-radius:12px;
    padding:10px 12px;
    font-size:14px;
    outline:none;
    background:#fff;
  }

  .tableWrap{
    overflow:auto;
    border-radius:14px;
    border:1px solid #eef2f7;
  }
  table{
    width:100%;
    border-collapse:separate;
    border-spacing:0;
    min-width:1200px;
    font-size:14px;
  }
  thead th{
    position:sticky;
    top:0;
    background:#f8fafc;
    color:#374151;
    text-align:left;
    padding:12px 12px;
    border-bottom:1px solid #e5e7eb;
    z-index:1;
    white-space:nowrap;
  }
  tbody td{
    padding:12px 12px;
    border-bottom:1px solid #f0f2f5;
    color:#111827;
    vertical-align:top;
  }

  /* ===== Rows: all white ===== */
  tbody tr.row-active,
  tbody tr.row-completed,
  tbody tr.row-cancelled{
    background:#ffffff;
  }

  /* ===== Hover (single rule) ===== */
  tbody tr:hover{ background:#fafcff; }
  tbody tr.group-divider:hover{ background:#ffffff; }

  /* ===== STATUS BADGES (NEW COLOR SET) ===== */
  .badge{
    display:inline-block;
    padding:6px 10px;
    border-radius:999px;
    font-weight:900;
    font-size:12px;
    border:1px solid transparent;
    white-space:nowrap;
  }

  /* Scheduled = ‡∏°‡πà‡∏ß‡∏á */
  .b-scheduled{
    background:#f3e8ff;
    color:#6b21a8;
    border-color:#d8b4fe;
  }
  /* Preparing = ‡∏ü‡πâ‡∏≤ */
  .b-preparing{
    background:#e0f2fe;
    color:#075985;
    border-color:#bae6fd;
  }
  /* Delayed = ‡πÅ‡∏î‡∏á */
  .b-delayed{
    background:#fee2e2;
    color:#991b1b;
    border-color:#fecaca;
  }
  /* Transporting = ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß */
  .b-transporting{
    background:#dcfce7;
    color:#166534;
    border-color:#86efac;
  }
  /* Returning = ‡∏™‡πâ‡∏° */
  .b-returning{
    background:#ffedd5;
    color:#9a3412;
    border-color:#fed7aa;
  }
  /* Completed = ‡πÄ‡∏ó‡∏≤‡∏≠‡πà‡∏≠‡∏ô */
  .b-completed{
    background:#f1f5f9;
    color:#334155;
    border-color:#d7dee8;
  }
  /* Cancelled = ‡πÄ‡∏ó‡∏≤‡πÄ‡∏Ç‡πâ‡∏° */
  .b-cancelled{
    background:#e5e7eb;
    color:#111827;
    border-color:#9ca3af;
  }
  /* Pending / Unknown */
  .b-pending{
    background:#f3f4f6;
    color:#374151;
    border-color:#e5e7eb;
  }

  /* Activated = ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡∏°‡∏ü‡πâ‡∏≤ (teal) */
.b-activated{ background:#d1fae5; color:#065f46; border-color:#6ee7b7; }

/* Aborted = ‡∏ä‡∏°‡∏û‡∏π‡πÅ‡∏î‡∏á (‡πÅ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å Cancelled) */
.b-aborted{ background:#ffe4e6; color:#9f1239; border-color:#fecdd3; }


  .tinyNote{ font-size:12px; color:#6b7280; margin:10px 2px 0; }

  /* ===== MODAL (Details) ===== */
  .modalOverlay{
    position:fixed;
    inset:0;
    background:rgba(17,24,39,0.55);
    display:none;
    align-items:center;
    justify-content:center;
    padding:18px;
    z-index:9999;
  }
  /* ‚úÖ Details modal = same size as On Duty (stampModal) */
.modal{
  width: min(880px, 100%);
  background: white;
  border-radius: 18px;
  box-shadow: 0 18px 50px rgba(0,0,0,0.28);
  overflow: hidden;
  text-align: left;

  max-height: 80vh;        /* üîΩ ‡∏•‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏¥‡∏° (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î) */
}

/* ‚úÖ ‡πÉ‡∏´‡πâ body ‡∏Ç‡∏≠‡∏á Details ‡∏™‡∏π‡∏á‡∏û‡∏≠ ‡πÜ ‡∏Å‡∏±‡∏ö On Duty */

  .modalHeader{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:12px;
    padding:14px 16px;
    background:#f8fafc;
    border-bottom:1px solid #e5e7eb;
  }
  .modalTitle{
    margin:0;
    font-size:18px;
    font-weight:900;
    color:#111827;
  }
  .modalSub{
    margin:4px 0 0;
    font-size:12px;
    color:#6b7280;
  }
  .modalBody{
    padding:16px;
    max-height:70vh;
    overflow:auto;
  }
  .section{
    border:1px solid #eef2f7;
    border-radius:14px;
    padding:12px;
    margin-bottom:12px;
    background:#fff;
  }
  .section h3{
    margin:0 0 8px;
    font-size:14px;
    font-weight:900;
    color:#111827;
  }
  .kv{
    display:grid;
    grid-template-columns: 220px 1fr;
    gap:8px 12px;
    font-size:13px;
  }
  .k{ color:#374151; font-weight:800; }
  .v{ color:#111827; }

  .modalFooter{
  display:flex;
  align-items:center;
  gap:10px;
  padding:12px 16px;
  border-top:1px solid #e5e7eb;
  background:#fff;
  flex-wrap:nowrap;   /* ‚ùó ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß */
}
  .footerLeft{
  display:flex;
  gap:10px;
  flex: 0 0 auto;     /* ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Ç‡∏¢‡∏≤‡∏¢ */
}
  .footerRight{
  display:flex;
  flex: 1;            /* ‚ùó ‡∏Å‡∏¥‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î */
  justify-content:flex-end;
}

.footerRight #closeModalBtn{
  width: 100%;
  max-width: 20px;   /* ‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ 200‚Äì260 */
  min-width: 180px;
}

  /* ===== STAMP PANEL ===== */
  .stampOverlay{
    position:fixed;
    inset:0;
    background:rgba(17,24,39,0.55);
    display:none;
    align-items:center;
    justify-content:center;
    padding:18px;
    z-index:10000;
  }
  .stampModal{
  width:min(880px, 100%);
  background:white;
  border-radius:18px;
  box-shadow:0 18px 50px rgba(0,0,0,0.28);
  overflow:hidden;
  text-align:left;

  max-height: 88vh;          /* ‚úÖ ‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏¥‡∏° ~92‚Äì100vh ‚Üí ‡πÄ‡∏ï‡∏µ‡πâ‡∏¢‡∏•‡∏á */
}
  .stampHeader{
    padding:14px 16px;
    background:#f8fafc;
    border-bottom:1px solid #e5e7eb;
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:12px;
  }
  .stampTitle{
    margin:0;
    font-size:16px;
    font-weight:1000;
    color:#111827;
  }
  .stampBody{
  padding:14px 14px;         /* ‚úÖ ‡∏à‡∏≤‡∏Å 16px ‚Üí 14px */
  max-height:60vh;           /* ‚úÖ ‡∏à‡∏≤‡∏Å 70vh ‚Üí 60vh */
  overflow:auto;
  -webkit-overflow-scrolling: touch;
}
  .stampGrid{
    display:grid;
    grid-template-columns: 1fr;
    gap:10px;
  }
  .stampRow{
    border:1px solid #eef2f7;
    border-radius:14px;
    padding:10px 12px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
    background:#fff;
  }
  .stampLeft{
    display:flex;
    flex-direction:column;
    gap:4px;
  }
  .stampKey{
    font-weight:1000;
    font-size:13px;
    color:#111827;
  }
  .stampTime{
    font-size:12px;
    color:#6b7280;
  }
  .stampActions{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    align-items:center;
  }
  .whoRow{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    margin-top:10px;
  }
  .whoRow input{
    flex:1;
    min-width:220px;
  }
  .stampFooter{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;

  padding:10px 14px;         /* ‚úÖ ‡∏à‡∏≤‡∏Å 12px 16px */
  border-top:1px solid #e5e7eb;
  background:#fff;
  flex-wrap:wrap;
}


  /* ===== STAMP FOOTER ACTIONS (buttons layout) ===== */
.stampFooterActions{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  justify-content:flex-end;
  align-items:center;     /* ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° */
  margin-left:auto;       /* ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° */
}

/* Save & Exit = normal / safe action */
#saveExitBtn{
  border:1px solid #d1d5db;
}

/* Mark Completed = final & important */
#markCompletedBtn{
  min-width:160px;
}

@media (max-width: 520px){
  .stampFooterActions{
    width:100%;
  }
  .stampFooterActions .btn{
    flex:1;
    width:100%;
  }
}
@media (max-width: 520px){
  .stampModal{
    max-height: 85vh;        /* ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÄ‡∏ï‡∏µ‡πâ‡∏¢‡∏•‡∏á‡∏≠‡∏µ‡∏Å‡∏ô‡∏¥‡∏î */
  }
  .stampBody{
    max-height: 56vh;
  }
}
  /* ===== Section header row inside tbody ===== */
  tr.section-header{
    background:#e9eef5;
    border-top:2px solid #c7d2e5;
    border-bottom:2px solid #c7d2e5;
  }
  tr.section-header td{
    font-weight:900;
    font-size:13px;
    color:#1f2937;
    text-transform:none;
    padding:10px 12px;
  }
  tr.section-header:hover{
    background:#e9eef5;
    cursor:default;
  }

  /* ===== CANCEL DIALOG (overlay) ===== */
  .cancelOverlay{
    position:fixed;
    inset:0;
    background:rgba(17,24,39,0.55);
    display:none;
    align-items:center;
    justify-content:center;
    padding:18px;
    z-index:10001;
  }
  .cancelModal{
    width:min(680px, 100%);
    background:#fff;
    border-radius:18px;
    box-shadow:0 18px 50px rgba(0,0,0,0.28);
    overflow:hidden;
    text-align:left;
  }
  .cancelHeader{
    padding:14px 16px;
    background:#f8fafc;
    border-bottom:1px solid #e5e7eb;
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:12px;
  }
  .cancelTitle{
    margin:0;
    font-size:16px;
    font-weight:1000;
    color:#111827;
  }
  .cancelBody{ padding:16px; }
  .cancelGroup{
    border:1px solid #eef2f7;
    border-radius:14px;
    padding:12px;
    background:#fff;
  }
  .cancelOption{
    display:flex;
    gap:10px;
    align-items:flex-start;
    padding:10px 8px;
    border-radius:12px;
  }
  .cancelOption:hover{ background:#fafcff; }
  .cancelOption label{
    font-weight:900;
    color:#111827;
    cursor:pointer;
  }
  .cancelHint{
    font-size:12px;
    color:#6b7280;
    margin-top:2px;
  }
  .cancelFooter{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    justify-content:flex-end;
    padding:12px 16px;
    border-top:1px solid #e5e7eb;
    background:#fff;
  }
  .textarea{
    width:100%;
    min-height:90px;
    resize:vertical;
    border:1px solid #e5e7eb;
    border-radius:12px;
    padding:10px 12px;
    font-size:14px;
    outline:none;
  }

  /* ===== Status Icons ===== */
  .statusCell{
    display:flex;
    align-items:center;
    gap:6px;
  }
  .statusIcons{
    display:inline-flex;
    align-items:center;
    gap:4px;
  }
  .statusIcons svg{
    width:22px !important;
    height:22px !important;
    stroke-width:2.4;
    color:currentColor;
  }

  /* ===== Group divider: thin line only ===== */
  .group-divider td{
    padding:0;
    height:0;
    background:#ffffff;
  }
  .row-active{ background:#ffffff; }
  .row-completed{ background:#ffffff; }
  .row-cancelled{ background:#ffffff; }

  tbody tr.group-divider:hover{ background:inherit; }
  .groupRow:hover{ background:inherit; }

  /* ===== Collapsible group header row ===== */
  tr.group-toggle td{
    background:#ffffff;
    border-top:1px solid #e5e7eb;
    border-bottom:1px solid #e5e7eb;
    padding:10px 12px;
  }
  .groupToggleBar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
  }
  .groupToggleLeft{
    display:flex;
    align-items:center;
    gap:10px;
    font-weight:1000;
    color:#111827;
  }
  .groupToggleCount{
    font-size:12px;
    font-weight:900;
    color:#6b7280;
    border:1px solid #e5e7eb;
    padding:2px 8px;
    border-radius:999px;
  }
  .actionCell{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    align-items:center;
  }

  /* =========================
   MOBILE / LINE IN-APP FRIENDLY (CLEAN)
   - Row 1: 2 stats (left) + Refresh (top-right)
   - Row 2: 4 stats
   - Compact height
========================= */

/* Avoid iOS text auto zoom */
html{ -webkit-text-size-adjust:100%; }
body{ text-size-adjust:100%; }

/* Safe-area (notch) */
.topbar{ padding-top: calc(8px + env(safe-area-inset-top)); }

/* Better scroll on iOS */
.tableWrap{
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: contain;
}

/* ===== Stats wrapper ===== */
.statsWrap{
  margin-left:auto;
  display:flex;
  flex-direction:column;
  gap:8px;
  width:100%;
}

/* ===== Stats row: always 4 equal columns ===== */
.statsRow{
  display:grid;
  grid-template-columns: repeat(4, minmax(0, 1fr));
  gap:8px;
}

/* ===== Stat card (shared) ===== */
.stat{
  min-width:0;
  height:56px;
  padding:6px;
  border-radius:12px;
  background:#fff;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  box-sizing:border-box;
}

/* Text sizing */
.stat span{
  font-size:18px;
  line-height:1.05;
}
.stat label{
  font-size:10px;
  line-height:1.1;
}

/* ===== Empty placeholder (Row 1, col 3) ===== */
.stat-empty{
  background:transparent;
  box-shadow:none;
}

/* ===== Refresh cell ===== */
.stat-refresh{
  padding:4px;
  background:transparent;
  box-shadow:none;
  display:flex;
  align-items:flex-start;
  justify-content:flex-end;
}

/* Small refresh button */
.refreshBtnSmall{
  padding:5px 6px;
  height:/28px;
  min-height:26px;
  font-size:12px;
  border-radius:8px;
  white-space:nowrap;
}

/* Extra small phones */
@media (max-width: 390px){
  .stat{ height:52px; }
  .stat span{ font-size:17px; }
  .stat label{ font-size:9.5px; }
  .refreshBtnSmall{
    height:28px;
    min-height:28px;
    font-size:11px;
  }
}

/* ===== Row 2: 4 stats ===== */
.statsRow2{
  display:grid;
  grid-template-columns: repeat(4, minmax(0, 1fr));
  gap:8px;
  align-items:stretch;
  min-width:0;
}

/* Stat cards: compact + equal height */
.stat{
  min-width:0;
  padding:6px 6px;
  height:56px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  box-sizing:border-box;
}
.stat span{
  font-size:18px;
  line-height:1.05;
}
.stat label{
  font-size:10px;
  line-height:1.1;
}

/* Refresh button: smaller + top-right + not too close */
.refreshTop{
  margin-left:auto;
  padding:6px 8px;
  height:32px;
  min-height:32px;
  border-radius:10px;
  font-size:12px;
  line-height:1;
  white-space:nowrap;
  margin-top:2px;
}

/* --- MOBILE --- */
@media (max-width: 520px){
  .topbar{
    flex-wrap:wrap;
    gap:10px;
    padding:10px 10px;
  }
  .header img{ height:52px; }

  h1{ font-size:18px; margin:8px 0 6px; }
  #clock{ font-size:34px; margin:6px 0 12px; }

  /* Controls stack full width */
  .controls{
    width:100%;
    justify-content:stretch;
  }
  .input, .select{
    width:100%;
    padding:12px 12px;
    border-radius:14px;
  }

  /* Buttons: easier tap */
  .btn{ min-height:44px; }
  .btn.tiny{ min-height:36px; }
  .btn.light{ padding:12px 12px; }
  .btn.pill{ padding:10px 12px; font-size:13px; }

  /* Table: reduce horizontal scroll */
  table{ min-width:880px; font-size:13px; }
  thead th, tbody td{ padding:10px 10px; }

  /* Modal as bottom sheet */
  .modalOverlay, .stampOverlay, .cancelOverlay{
    align-items:flex-end;
    padding:10px;
  }
  .modal, .stampModal, .cancelModal{
    width:100%;
    border-radius:18px;
    max-height:92vh;
  }
  .modalBody, .stampBody{
    max-height:62vh;
    overflow:auto;
    -webkit-overflow-scrolling: touch;
  }

  /* Footer buttons full-width */
  .footerLeft, .footerRight{ width:100%; }
  .footerLeft .btn,
  .footerRight .btn,
  .stampFooter .btn,
  .cancelFooter .btn{
    flex:1;
    width:100%;
  }
}

/* ===== Extra: very small phones ===== */
@media (max-width: 390px){
  .statsWrap{ gap:6px; }
  .statsRow1{ gap:10px; }
  .statsRow1 .row1Left{
    width:200px;                   /* ‚úÖ ‡πÅ‡∏Ñ‡∏ö‡∏•‡∏á‡∏≠‡∏µ‡∏Å */
    max-width:68%;
    gap:6px;
  }
  .statsRow2{ gap:6px; }
  .stat{ height:52px; padding:6px 5px; }
  .stat span{ font-size:17px; }
  .stat label{ font-size:9.5px; }
  .refreshTop{
    height:30px;
    min-height:30px;
    padding:6px 7px;
    font-size:11px;
  }
}

/* --- TABLET --- */
@media (min-width: 520px) and (max-width: 900px){
  .topbar{ flex-wrap:wrap; }
  .header img{ height:58px; }
  #clock{ font-size:38px; }
  .kv{ grid-template-columns: 1fr; }
  table{ min-width:980px; }
}
/* ===== FORCE center title + clock (robust) ===== */
.titleBlock{
  width:100%;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  text-align:center !important;

  margin:0 auto 8px;
  padding:0 !important;

  background:transparent !important;
  box-shadow:none !important;
}

/* Operation title */
.titleBlock h1{
  width:100%;
  margin:10px 0 6px;
  text-align:center !important;

  background:transparent !important;
}

/* Clock wrapper */
.clockRow{
  width:100%;
  display:flex;
  justify-content:center;
  align-items:center;

  margin:0 auto;

  background:transparent !important;
}

/* Clock itself */
#clock{
  display:block;
  width:100%;
  text-align:center !important;

  margin:6px 0 14px;

  background:transparent !important;
}

/* ===== Reduce gap between Clock and Table ===== */

/* ‡∏•‡∏î‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏ï‡πâ‡πÄ‡∏ß‡∏•‡∏≤ */
#clock{
  margin-bottom: 6px !important;   /* ‡πÄ‡∏î‡∏¥‡∏° ~16px */
}

/* ‡∏•‡∏î‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
.card{
  margin-top: 6px !important;      /* ‡πÄ‡∏î‡∏¥‡∏° implicit ‡∏à‡∏≤‡∏Å layout */
}

@media (max-width: 520px){
  #clock{ margin-bottom: 4px !important; }
  .card{ margin-top: 4px !important; }
}

/* ===== Total (Year) ‚Äî Yellow (less brown) ===== */
.stat-year{
  background:#fffbeb;        /* ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏≠‡πà‡∏≠‡∏ô */
  border:1px solid #fde68a;
}

.stat-year span{
  font-size:30px;
  font-weight:1000;
  color:#eab308;             /* ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏ä‡∏±‡∏î (amber-500) */
}

/* ===== Total (Today) ===== */
.stat-today{
  background:#ecfdf5;        /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô */
  border:1px solid #bbf7d0;  /* ‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô (optional ‡πÅ‡∏ï‡πà‡∏î‡∏π‡∏î‡∏µ) */
}

.stat-today span{
  font-size:30px;
  font-weight:1000;
  letter-spacing:0.2px;     /* ‡πÄ‡∏î‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏ô‡∏¥‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß */
  /* ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å .stat span (#006d5b) */
}

/* ===== Row 2: green outline only (no background change) ===== */
.statsRow2 .stat{
  border:1.5px solid #16a34a;   /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô */
  background:#ffffff;           /* ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏û‡∏∑‡πâ‡∏ô */
  box-shadow:0 2px 6px rgba(0,0,0,0.08); /* ‡πÄ‡∏ö‡∏≤‡∏ô‡∏¥‡∏î ‡πÜ */
}

/* ===== Widen selected table columns ===== */

/* Date */
th:nth-child(2), 
td:nth-child(2){
  min-width: 80px;
  white-space: nowrap;
}
/* Mission ID */
th:nth-child(1),
td:nth-child(1){
  min-width: 100px;        /* ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô */
  white-space: nowrap;
  font-weight: 900;
}

/* Mission Type */
th:nth-child(4),
td:nth-child(4){
  min-width: 160px;        /* ‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ 240‚Äì300 ‡∏ï‡∏≤‡∏°‡πÉ‡∏à */
}

/* From */
th:nth-child(5), 
td:nth-child(5){
  min-width: 300px;
}

/* To */
th:nth-child(6), 
td:nth-child(6){
  min-width: 300px;
}

/* Actions */
th:nth-child(8), 
td:nth-child(8){
  min-width: 260px;
  white-space: nowrap;
}

.actionCell{
  flex-wrap: nowrap;
  white-space: nowrap;
}

.actionCell .btn{
  padding:8px 10px;
  min-height:36px;
}
/* ===== Default: center everything ===== */
table th,
table td{
  text-align: center;
  vertical-align: middle;
}

/* ===== Left-align text-heavy columns ===== */
/* Mission Type */
table th:nth-child(4),
table td:nth-child(4),
/* From */
table th:nth-child(5),
table td:nth-child(5),
/* To */
table th:nth-child(6),
table td:nth-child(6){
  text-align: left;
}

/* =========================
   MOBILE ‚Äì STAMP PANEL SIZE TUNING
   (On Duty / Stamp view)
========================= */
@media (max-width: 520px){

  /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á overlay ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏¥‡∏ô padding ‡πÄ‡∏¢‡∏≠‡∏∞ */
  .stampOverlay{
    padding:10px; /* ‡πÄ‡∏î‡∏¥‡∏° ~18px */
  }

  /* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏Å: ‡πÄ‡∏ï‡∏µ‡πâ‡∏¢‡∏•‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ */
  .stampModal{
    max-height:88vh;          /* ‡πÄ‡∏î‡∏¥‡∏° ~92vh */
    border-radius:16px;
  }

  /* ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß: ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á */
  .stampHeader{
    padding:10px 14px;        /* ‡πÄ‡∏î‡∏¥‡∏° 14px 16px */
  }
  .stampTitle{
    font-size:15px;           /* ‡πÄ‡∏î‡∏¥‡∏° 16px */
  }

  /* ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤: ‡∏ï‡∏±‡∏ß‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏™‡∏π‡∏á */
  .stampBody{
    padding:12px 14px;        /* ‡πÄ‡∏î‡∏¥‡∏° 16px */
    max-height:58vh;          /* üîë ‡∏•‡∏î‡∏à‡∏≤‡∏Å ~62‚Äì70vh */
    overflow:auto;
    -webkit-overflow-scrolling: touch;
  }

  /* ‡πÅ‡∏ï‡πà‡∏•‡∏∞ row ‡∏Ç‡∏≠‡∏á stamp ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏µ‡πâ‡∏¢‡∏•‡∏á‡∏ô‡∏¥‡∏î */
  .stampRow{
    padding:8px 10px;         /* ‡πÄ‡∏î‡∏¥‡∏° 10px 12px */
    border-radius:12px;
  }

  /* footer: ‡∏î‡∏±‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤ */
  .stampFooter{
    padding:10px 14px;        /* ‡πÄ‡∏î‡∏¥‡∏° 12px 16px */
    gap:8px;
  }

  /* ‡∏õ‡∏∏‡πà‡∏° footer ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏µ‡πâ‡∏¢‡∏•‡∏á‡∏ô‡∏¥‡∏î */
  .stampFooterActions .btn{
    min-height:40px;          /* ‡πÄ‡∏î‡∏¥‡∏° ~44px */
  }
}

/* =========================
   STAMP ROW ‚Äî EN line1 / TH line2
   Button right + time under button (HH:MM only)
========================= */

.stampRow{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:10px;
  flex-wrap:nowrap;      /* ‚úÖ ‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î */
}

.stampLeft{
  flex:1 1 auto;
  min-width:0;           /* ‚úÖ ‡πÉ‡∏´‡πâ ellipsis ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô */
  display:flex;
  flex-direction:column;
  gap:3px;
}

/* EN line */
.stampEn{
  font-size:12px;        /* ‚úÖ ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á */
  font-weight:900;
  color:#111827;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* TH line */
.stampTh{
  font-size:11px;        /* ‚úÖ ‡πÄ‡∏•‡πá‡∏Å‡∏Å‡∏ß‡πà‡∏≤ EN */
  color:#6b7280;
  line-height:1.2;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* Right side fixed width so it never wraps */
.stampActions{
  flex:0 0 64px;         /* ‚úÖ ‡∏Ñ‡∏∏‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏ù‡∏±‡πà‡∏á‡∏õ‡∏∏‡πà‡∏° */
  display:flex;
  flex-direction:column; /* ‚úÖ ‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏•‡∏á‡πÉ‡∏ï‡πâ‡∏õ‡∏∏‡πà‡∏° */
  align-items:flex-end;
  gap:4px;
}

/* Ultra compact button */
.stampActions .btn.tiny{
  width:64px;            /* ‚úÖ ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Ñ‡∏ö‡∏•‡∏á‡∏°‡∏≤‡∏Å */
  padding:4px 6px;
  min-height:30px;
  font-size:10px;
  line-height:1;
  white-space:nowrap;
}

/* Time under button (after stamped) */
.stampBtnTime{
  font-size:10px;
  color:#6b7280;
  line-height:1;
  white-space:nowrap;
}


/* ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÄ‡∏•‡πá‡∏Å‡∏°‡∏≤‡∏Å */
@media (max-width: 380px){
  .stampActions{ flex-basis: 58px; }
  .stampActions .btn.tiny{ width:58px; }
  .stampEn{ font-size:11.5px; }
  .stampTh{ font-size:10.5px; }
}

/* =========================
   DETAILS (Modal) ‚Äî Mobile stacked layout
   Label on top, value below (1 column)
========================= */
@media (max-width: 520px){
  /* ‡πÉ‡∏´‡πâ‡∏Ñ‡πà‡∏≤ (‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤) ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ö‡∏µ‡∏ö */
  .kv{
    grid-template-columns: 1fr !important;
  }

  /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏π‡πà‡∏î‡∏π‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ */
  .k{
    margin-top: 10px;
    font-size: 12px;
    opacity: 0.85;
  }
  .v{
    margin-top: 2px;
    font-size: 14px;
    line-height: 1.35;
    word-break: break-word;
  }

  /* ‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ß‡πâ‡∏ô‡∏ö‡∏ô */
  .kv .k:first-child{
    margin-top: 0;
  }
}


/* ===== SAFETY: prevent invisible overlay blocking clicks ===== */
  .modalOverlay{ display:none; }
  .modalOverlay[style*="display: none"]{
    pointer-events:none;
  }
/* ===== Status Icons (color driven by CSS) ===== */
.statusIcons svg{
  width:22px !important;
  height:22px !important;
  stroke-width:2.4;
  color:currentColor; /* optional */
}

/* ‡∏™‡∏µ‡∏Ç‡∏≠‡∏á icon ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ */
.statusIcons.preparing{ color:#075985; }     /* ‡∏ü‡πâ‡∏≤ */
.statusIcons.delayed{ color:#991b1b; }       /* ‡πÅ‡∏î‡∏á */
.statusIcons.transporting{ color:#166534; }  /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß */
.statusIcons.returning{ color:#9a3412; }     /* ‡∏™‡πâ‡∏° */


</style>
</head>

<body>

  <!-- =======================
       TOPBAR
  ======================== -->
  <div class="topbar">
    <div class="header">
      <img src="header-logo.png" alt="Header Logo">
    </div>

    <div class="statsWrap">
      <!-- ===== Row 1 ===== -->
      <div class="statsRow statsRow1">
        <div class="stat stat-year">
          <span id="total">-</span>
          <label>Total (Year)</label>
        </div>

        <div class="stat stat-today">
          <span id="todayTotal">-</span>
          <label>Total (Today)</label>
        </div>

        <!-- placeholder col -->
        <div class="stat stat-empty"></div>

        <!-- Refresh -->
        <div class="stat stat-refresh">
          <button class="btn light refreshBtnSmall" id="refreshBtn">Refresh</button>
        </div>
      </div>

      <!-- ===== Row 2 ===== -->
      <div class="statsRow statsRow2">
        <div class="stat">
          <span id="activeToday">-</span>
          <label>Active</label>
        </div>
        <div class="stat">
          <span id="remainingScheduled">-</span>
          <label>Remaining</label>
        </div>
        <div class="stat">
          <span id="completedN">-</span>
          <label>Completed</label>
        </div>
        <div class="stat">
          <span id="cancelledN">-</span>
          <label>Cancelled</label>
        </div>
      </div>
    </div>
  </div>


  <!-- =======================
       CONTENT (‡∏Ñ‡∏£‡∏≠‡∏ö title+clock+table ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
  ======================== -->
  <div class="content">

    <!-- TITLE + CLOCK -->
    <div class="titleBlock">
      <h1>Operation</h1>
      <div class="clockRow">
        <div id="clock">--:--:--</div>
      </div>
    </div>

    <!-- TABLE CARD -->
    <div class="card">
      <div class="cardHeader">
        <h2 class="cardTitle" id="tableTitle">Today‚Äôs Missions</h2>

        <div class="controls">
          <input id="search" class="input" placeholder="Search: ID / type / from / to / notes">
          <select id="statusFilter" class="select">
            <option value="ALL">All status</option>
            <option value="Scheduled">Scheduled</option>
            <option value="Preparing">Preparing</option>
            <option value="Delayed">Delayed</option>
            <option value="Transporting">Transporting</option>
            <option value="Returning">Returning</option>
            <option value="Completed">Completed</option>
            <option value="Cancelled">Cancelled</option>
            <option value="Pending">Pending</option>
          </select>
          <input id="dateFilter" class="input" type="date">
        </div>
      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th style="width:140px;">Mission ID</th>
              <th style="width:120px;">Date</th>
              <th style="width:120px;">Departure</th>
              <th style="width:220px;">Mission Type</th>
              <th style="width:240px;">From</th>
              <th style="width:240px;">To</th>
              <th style="width:130px;">Status</th>
              <th style="width:220px;">Actions</th>
            </tr>
          </thead>
          <tbody id="missionBody">
            <tr><td colspan="8" class="muted">No data yet.</td></tr>
          </tbody>
        </table>
      </div>

      <div class="tinyNote" id="countNote"></div>
    </div>

  </div>
  <!-- /content -->

<!-- =======================
     DETAILS MODAL
======================== -->
<div class="modalOverlay" id="modalOverlay" role="dialog" aria-modal="true">
  <div class="modal">

    <div class="modalHeader">
      <div>
        <h2 class="modalTitle" id="modalTitle">Mission Details</h2>
        <div class="modalSub" id="modalSub"></div>
      </div>
    </div>

    <div class="modalBody" id="modalBody"></div>

    <div class="modalFooter">
      <button class="btn pill onDuty" id="openStampBtn" type="button">On Duty</button>
      <button class="btn danger" id="cancelMissionBtn" type="button">Cancel mission</button>
      <button class="btn light" id="closeModalBtn" type="button">Close</button>
    </div>

  </div>
</div>




  <!-- =======================
       STAMP PANEL
  ======================== -->
  <div class="stampOverlay" id="stampOverlay" role="dialog" aria-modal="true">
    <div class="stampModal">
      <div class="stampHeader">
        <div>
          <h3 class="stampTitle" id="stampTitle">Stamp</h3>
          <div class="modalSub" id="stampSub"></div>
        </div>
        <button class="btn light tiny" id="closeStampBtn">Close</button>
      </div>

      <div class="stampBody">
        <div class="muted" style="font-size:12px; margin-bottom:10px;">
          * ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ç‡∏±‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠ stamp ‡πÄ‡∏ß‡∏•‡∏≤ (‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á device) ‚Ä¢ ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô ISO-8601 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
        </div>

        <div class="whoRow">
          <input id="stampBy" class="input" placeholder="‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô (‡πÄ‡∏ä‡πà‡∏ô EMT A / RN B / Dr C) *">
          <input id="stampNote" class="input" placeholder="Note (optional) ‡πÄ‡∏ä‡πà‡∏ô delay/traffic/hand-off issue">
        </div>

        <div class="stampGrid" id="stampGrid" style="margin-top:12px;"></div>
      </div>

      <div class="stampFooter">
        <div class="muted" style="font-size:12px;" id="stampFooterInfo">
          Stamp progress will be saved. You can return later to continue.
        </div>

        <div class="stampFooterActions">
          <button class="btn danger tiny" id="clearStampsBtn" type="button">Clear Stamp</button>
          <button class="btn" id="markCompletedBtn" type="button">Mark Completed</button>
          <button class="btn secondary" id="saveExitBtn" type="button">Save & Exit</button>
        </div>
      </div>
    </div>
  </div>


  <!-- =======================
     CANCEL DIALOG (match index.html)
======================== -->
<div class="cancelOverlay" id="cancelOverlay" role="dialog" aria-modal="true">
  <div class="cancelModal">
    <div class="cancelHeader">
      <div>
        <h3 class="cancelTitle" id="cancelTitle">Cancel Mission</h3>
        <div class="modalSub" id="cancelSub">-</div>
      </div>
      <button class="btn light tiny" id="closeCancelBtn" type="button">Close</button>
    </div>

    <div class="cancelBody">
      <div class="field" style="gap:8px;">

        <!-- ‚úÖ Cancelled by -->
        <div class="field" style="gap:8px; margin-bottom:10px;">
          <div class="muted" style="font-size:12px; margin-bottom:6px;">Cancelled by (required)</div>
          <input class="input" id="cancelBy" type="text"
                 placeholder="e.g., Nurse A / Dr. B / CC ‡∏Ñ‡∏∏‡∏ì‡∏ã‡∏µ" required>
        </div>

        <!-- ‚úÖ Radio reasons (KEYs like index.html) -->
        <div class="muted" style="font-size:12px; margin-bottom:10px;">
          ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)
        </div>

        <label class="cancelOption" style="display:flex; gap:10px; align-items:flex-start; cursor:pointer; margin-bottom:10px;">
          <input type="radio" name="cancelReason" value="MISSED" style="margin-top:3px;">
          <div>
            <div style="font-weight:900;">Missed mission</div>
            <div class="cancelHint" style="font-size:12px; color:#6b7280;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</div>
          </div>
        </label>

        <label class="cancelOption" style="display:flex; gap:10px; align-items:flex-start; cursor:pointer; margin-bottom:10px;">
          <input type="radio" name="cancelReason" value="ABORTED" style="margin-top:3px;">
          <div>
            <div style="font-weight:900;">Aborted mission</div>
            <div class="cancelHint" style="font-size:12px; color:#6b7280;">‡∏≠‡∏≠‡∏Å‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</div>
          </div>
        </label>

        <label class="cancelOption" style="display:flex; gap:10px; align-items:flex-start; cursor:pointer;">
          <input type="radio" name="cancelReason" value="INCORRECT" style="margin-top:3px;">
          <div>
            <div style="font-weight:900;">Incorrect information</div>
            <div class="cancelHint" style="font-size:12px; color:#6b7280;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</div>
          </div>
        </label>

        <div class="muted" style="font-size:12px; margin-top:10px;">
          * ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 1 ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Confirm<br>
          * ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô Cancelled
        </div>

      </div>
    </div>

    <div class="cancelFooter" style="padding:14px 16px; border-top:1px solid #e5e7eb; display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; background:#fff;">
      <button class="btn light" id="cancelCancelBtn" type="button">Close</button>
      <button class="btn danger" id="confirmCancelBtn" type="button">Confirm Cancellation</button>
    </div>
  </div>
</div>

<script>
/* =======================
   STORAGE / HELPERS
======================= */
const STORAGE_KEY = "SCC_MISSIONS_V1";

/* =======================
   ‚úÖ UI Mission Type Label (ONLY for display)
======================= */
const TYPE_DISPLAY_LABELS = {
  "EMS_BASIC": "Basic EMS",
  "EMS_ADV": "Advance EMS",

  "IFT_BASIC_IN": "Basic IFT ‚Äì Refer In",
  "IFT_ADV_IN": "Advance IFT ‚Äì Refer In",
  "IFT_BASIC_OUT": "Basic IFT ‚Äì Refer Out",
  "IFT_ADV_OUT": "Advance IFT ‚Äì Refer Out",

  "AP_CLINIC_IFT": "Airport Clinic IFT (‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡∏™‡∏ô‡∏≤‡∏°‡∏ö‡∏¥‡∏ô)",
  "AP_ESCORT_IN": "(IN)Airport escort and transport (‡∏£‡∏±‡∏ö-‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡∏ô‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)",
  "AP_ESCORT_OUT": "(OUT)Airport escort and transport (‡∏™‡πà‡∏á-‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡∏ô‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)",
  "TARMAC_IN": "TARMAC_IN : Airport escort and transport (‡∏£‡∏±‡∏ö-‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)",
  "TARMAC_OUT": "TARMAC_OUT : Airport escort and transport (‡∏™‡πà‡∏á-‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)",

  "PROC_SEND_WAIT_PICK": "Transport for procedural appointment (‡∏™‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏£‡∏≠‡∏£‡∏±‡∏ö-‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡πÑ‡∏õ‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£)",
  "PROC_SEND": "(SEND)Transport procedural appointment (‡∏™‡πà‡∏á-‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡πÑ‡∏õ‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£)",
  "PROC_PICK": "(PICK)Transport procedural appointment (‡∏£‡∏±‡∏ö-‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÑ‡∏õ‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£)",

  "HOME_PICKUP": "Home pickup (‡∏£‡∏±‡∏ö-‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡∏à‡∏≤‡∏Å‡∏ö‡πâ‡∏≤‡∏ô)",
  "HOME_DISCH": "Discharge home (‡∏™‡πà‡∏á-‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô)",

  "HHC": "Home Health Care",
  "HHC_PICKUP": "Home Health Care",
  "HHC_SEND": "Home Health Care",

  "OTHER": "Other ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ"
};
function getTypeLabelForTable(m){
  const k = String(m?.typeKey || "").trim();
  return TYPE_DISPLAY_LABELS[k] || (m?.typeDisplay || m?.type || "-");
}

/* =======================
   REALTIME SYNC (Operation -> Index / Line)
======================= */
const SYNC_CHANNEL_NAME = "SCC_SYNC_V1";
let syncChannel = null;

function getSyncChannel(){
  try{
    if (!syncChannel && "BroadcastChannel" in window){
      syncChannel = new BroadcastChannel(SYNC_CHANNEL_NAME);
    }
  }catch{}
  return syncChannel;
}
function emitSync(eventName, payload = {}){
  const ch = getSyncChannel();
  if (ch){
    try{ ch.postMessage({ eventName, payload, at: Date.now() }); }catch{}
  }
  try{
    localStorage.setItem("__SCC_SYNC_PING__", JSON.stringify({ eventName, payload, at: Date.now() }));
  }catch{}
}

function pad2(n){ return String(n ?? 0).padStart(2, "0"); }

function toISODateLocal(d){
  const x = (d instanceof Date) ? d : new Date(d);
  if (isNaN(x.getTime())) return "";
  return `${x.getFullYear()}-${pad2(x.getMonth()+1)}-${pad2(x.getDate())}`;
}
function getTodayISO(){ return toISODateLocal(new Date()); }

function getMissionDateISO(m){
  return String(m?.date ?? "").slice(0,10) || "";
}

function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, ch => ({
    "&":"&amp;",
    "<":"&lt;",
    ">":"&gt;",
    '"':"&quot;",
    "'":"&#039;"
  }[ch]));
}

/* ‚úÖ ‡πÅ‡∏Å‡πâ bug onclick: escape ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö JS string (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà HTML) */
function jsStr(s){
  return String(s ?? "").replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/\n/g,"\\n").replace(/\r/g,"\\r");
}

function readMissions(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    return Array.isArray(arr) ? arr : [];
  }catch{ return []; }
}
function writeMissions(arr){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
  emitSync("MISSIONS_UPDATED", {});
}
function nowISO(){ return new Date().toISOString(); }

function normStatus(s){
  const x = String(s ?? "").trim();
  return x || "Scheduled";
}

/* =======================
   ‚úÖ STATUS CHANGEL O G (shared across pages)
   - stored in m.details.statusLog[]
======================= */
function ensureStatusLog(m){
  m.details = m.details || {};
  if (!Array.isArray(m.details.statusLog)) m.details.statusLog = [];
  return m;
}

function logStatusChange(m, fromStatus, toStatus, meta = {}){
  ensureStatusLog(m);
  m.details.statusLog.push({
    atISO: nowISO(),
    from: String(fromStatus || ""),
    to: String(toStatus || ""),
    by: String(meta.by || "").trim(),
    source: String(meta.source || "").trim(),   // e.g. "auto", "stamp", "cancel", "reschedule"
    note: String(meta.note || "").trim(),
    deviceId: (typeof DEVICE_ID !== "undefined") ? DEVICE_ID : ""
  });

  // ‡∏Å‡∏±‡∏ô log ‡πÇ‡∏ï‡πÄ‡∏Å‡∏¥‡∏ô (‡∏Å‡∏±‡∏ô localStorage ‡∏û‡∏±‡∏á) ‚Äî ‡∏õ‡∏£‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏î‡πâ
  const MAX = 200;
  if (m.details.statusLog.length > MAX){
    m.details.statusLog = m.details.statusLog.slice(-MAX);
  }
}

function setStatus(m, newStatus, meta = {}){
  const prev = normStatus(m.status || m.details?.status || "");
  const next = normStatus(newStatus);

  if (prev === next) return false;

  // log ‡∏Å‡πà‡∏≠‡∏ô
  logStatusChange(m, prev, next, meta);

  // set status ‡∏à‡∏£‡∏¥‡∏á
  m.status = next;
  m.details = m.details || {};
  m.details.status = next;

  return true;
}

function renderStatusLog(m){
  const logs = (m.details && Array.isArray(m.details.statusLog)) ? m.details.statusLog : [];
  if (!logs.length) return '<span class="muted">-</span>';

  // ‡πÉ‡∏´‡∏°‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÇ‡∏ä‡∏ß‡πå)
  const items = [...logs].slice().reverse().map(x => {
    const when = x.atISO ? new Date(x.atISO) : null;
    const whenTxt = when ? when.toLocaleString("th-TH") : "-";
    const by = x.by || "-";
    const src = x.source || "-";
    const note = x.note ? ` ‚Ä¢ ${escapeHtml(x.note)}` : "";

    return `
      <div style="margin:0 0 10px;">
        <div><strong>${escapeHtml(x.from || "-")} ‚Üí ${escapeHtml(x.to || "-")}</strong></div>
        <div class="muted" style="font-size:12px;">
          ${escapeHtml(whenTxt)} ‚Ä¢ by: ${escapeHtml(by)} ‚Ä¢ ${escapeHtml(src)}${note}
        </div>
      </div>
    `;
  }).join("");

  return items;
}

function badgeClassFromStatus(s){
  const x = normStatus(s).toLowerCase();
  if (x === "scheduled") return "b-scheduled";
  if (x === "preparing") return "b-preparing";
  if (x === "delayed") return "b-delayed";
  if (x === "transporting") return "b-transporting";
  if (x === "returning") return "b-returning";
  if (x === "completed") return "b-completed";
  if (x === "cancelled") return "b-cancelled";
  return "b-pending";
}

/* =======================
   ‚úÖ STATUS CHANGE LOG
   - ‡πÄ‡∏Å‡πá‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà status ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
   - ‡πÄ‡∏Å‡πá‡∏ö‡∏ó‡∏µ‡πà m.details.statusLog[]
======================= */
function ensureStatusLog(m){
  m.details = m.details || {};
  if (!Array.isArray(m.details.statusLog)) m.details.statusLog = [];
  return m;
}

function logStatusChange(m, nextStatus, meta = {}){
  ensureStatusLog(m);
  const prev = normStatus(m.status);
  const next = normStatus(nextStatus);
  if (prev === next) return;

  m.details.statusLog.push({
    atISO: nowISO(),
    from: prev,
    to: next,
    by: meta.by || "",
    source: meta.source || "",
    note: meta.note || "",
    deviceId: (typeof DEVICE_ID !== "undefined") ? DEVICE_ID : ""
  });

  // ‡πÄ‡∏Å‡πá‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 200
  if (m.details.statusLog.length > 200){
    m.details.statusLog = m.details.statusLog.slice(-200);
  }
}

function setStatus(m, nextStatus, meta = {}){
  const prev = normStatus(m.status);
  const next = normStatus(nextStatus);
  if (prev !== next){
    logStatusChange(m, next, meta);
    m.status = next;
    m.details = m.details || {};
    m.details.status = next;
  }
  return m;
}

/* =======================
   STATUS ICON SVGs
======================= */
const ICON_PREPARING_1 = `
<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clock-check-icon lucide-clock-check"><path d="M12 6v6l4 2"/><path d="M22 12a10 10 0 1 0-11 9.95"/><path d="m22 16-5.5 5.5L14 19"/></svg>
`;
const ICON_TRANSPORTING_1 = `
<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-ambulance-icon lucide-ambulance"><path d="M10 10H6"/><path d="M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2"/><path d="M19 18h2a1 1 0 0 0 1-1v-3.28a1 1 0 0 0-.684-.948l-1.923-.641a1 1 0 0 1-.578-.502l-1.539-3.076A1 1 0 0 0 16.382 8H14"/><path d="M8 8v4"/><path d="M9 18h6"/><circle cx="17" cy="18" r="2"/><circle cx="7" cy="18" r="2"/></svg>
`;
const ICON_RETURNING_1 = `
<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-big-right-icon lucide-arrow-big-right"><path d="M11 9a1 1 0 0 0 1-1V5.061a1 1 0 0 1 1.811-.75l6.836 6.836a1.207 1.207 0 0 1 0 1.707l-6.836 6.835a1 1 0 0 1-1.811-.75V16a1 1 0 0 0-1-1H5a1 1 0 0 1-1-1v-4a1 1 0 0 1 1-1z"/></svg>
`;
const ICON_RETURNING_2 = `
<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-hospital-icon lucide-hospital"><path d="M12 7v4"/><path d="M14 21v-3a2 2 0 0 0-4 0v3"/><path d="M14 9h-4"/><path d="M18 11h2a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-9a2 2 0 0 1 2-2h2"/><path d="M18 21V5a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16"/></svg>
`;
const ICON_DELAYED_1 = `
<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none"
  stroke="#e01a1a" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"
  class="lucide lucide-alarm-clock-icon lucide-alarm-clock">
  <circle cx="12" cy="13" r="8"/>
  <path d="M12 9v4l2 2"/>
  <path d="M5 3 2 6"/>
  <path d="m22 6-3-3"/>
  <path d="M6.38 18.7 4 21"/>
  <path d="M17.64 18.67 20 21"/>
</svg>
`;

function getStatusIconsHTML(status){
  const s = normStatus(status);
  if (s === "Preparing") return `<span class="statusIcons preparing">${ICON_PREPARING_1}</span>`;
  if (s === "Delayed") return `<span class="statusIcons delayed">${ICON_DELAYED_1}</span>`;
  if (s === "Transporting") return `<span class="statusIcons transporting">${ICON_TRANSPORTING_1}</span>`;
  if (s === "Returning") return `<span class="statusIcons returning">${ICON_RETURNING_1}${ICON_RETURNING_2}</span>`;
  return "";
}


function toLocalDateTime(dateISO, timeHHMM){
  if(!dateISO || !timeHHMM) return null;
  const [h,m] = String(timeHHMM).split(":").map(Number);
  const d = new Date(dateISO + "T00:00:00");
  d.setHours(h||0, m||0, 0, 0);
  return d;
}
function isoToHHMM(iso){
  if(!iso) return "";
  const d = new Date(iso);
  if (isNaN(d.getTime())) return "";
  return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}

/* =======================
   FROM/TO MAPPING
======================= */
function getFromTo(m){
  const d = m.details || {};
  const k = m.typeKey || "";

  if (["IFT_BASIC_IN","IFT_ADV_IN","IFT_BASIC_OUT","IFT_ADV_OUT"].includes(k)){
    return { from: d.referringHospital || "-", to: d.receivingHospital || "-", fromDetail: d.fromDetail || "", toDetail: d.toDetail || "" };
  }
  if (k === "AP_CLINIC_IFT"){
    return { from: d.pickupPoint || "-", to: d.receivingHospital || "-", fromDetail: d.fromDetail || "", toDetail: d.toDetail || "" };
  }
  if (["AP_ESCORT_IN","TARMAC_IN"].includes(k)){
    return { from: d.pickupPoint || "-", to: d.destinationHospital || "-", fromDetail: d.fromDetail || "", toDetail: d.toDetail || "" };
  }
  if (["AP_ESCORT_OUT","TARMAC_OUT"].includes(k)){
    return { from: d.sendingHospital || "-", to: d.dropoffPoint || "-", fromDetail: d.fromDetail || "", toDetail: d.toDetail || "" };
  }
  if (["PROC_SEND_WAIT_PICK","PROC_SEND"].includes(k)){
    return { from: d.originHospital || "-", to: d.procedureFacility || "-", fromDetail: d.fromDetail || "", toDetail: d.toDetail || "" };
  }
  if (k === "PROC_PICK"){
    return { from: d.procedureFacility || "-", to: d.returnHospital || "-", fromDetail: d.fromDetail || "", toDetail: d.toDetail || "" };
  }
  if (["HOME_PICKUP","HOME_DISCH","HHC","HHC_PICKUP","HHC_SEND","OTHER","EMS_BASIC","EMS_ADV"].includes(k)){
    return { from: d.origin || "-", to: d.destination || "-", fromDetail: d.fromDetail || "", toDetail: d.toDetail || "" };
  }
  return { from: "-", to: "-", fromDetail: d.fromDetail || "", toDetail: d.toDetail || "" };
}

/* =======================
   ROUTE (Current location -> From/To)
======================= */
function _cleanText(s){ return String(s || "").trim(); }
function _getPin(m, side){
  const d = (m && m.details) ? m.details : {};
  const lat = side === "from" ? d.fromLat : d.toLat;
  const lng = side === "from" ? d.fromLng : d.toLng;
  const la = Number(lat), lo = Number(lng);
  if (Number.isFinite(la) && Number.isFinite(lo)) return `${la},${lo}`;
  return null;
}
function _getDestinationText(m, side){
  const pin = _getPin(m, side);
  if (pin) return pin;

  const ft = getFromTo(m);
  const place = side === "from" ? _cleanText(ft.from) : _cleanText(ft.to);
  const detail = side === "from" ? _cleanText(ft.fromDetail) : _cleanText(ft.toDetail);
  const combined = [place, detail].filter(Boolean).join(" ");
  return combined || null;
}
function openRouteTo(side){
  const m = window.__detailMission;
  if (!m) return;

  const dest = _getDestinationText(m, side);
  if (!dest){
    window.open("https://www.google.com/maps", "_blank", "noopener,noreferrer");
    return;
  }
  const url = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(dest)}&travelmode=driving`;
  window.open(url, "_blank", "noopener,noreferrer");
}

/* =======================
   AUTO status (Scheduled/Preparing/Delayed only) + LOG
======================= */
function autoUpdatePreparingDelayed(missions){
  let changed = false;
  const now = new Date();

  missions.forEach(m => {
    const cur = normStatus(m.status);
    const dep = (m.details || {}).departureFromHospital;
    const dateISO = String(m.date || "").slice(0,10);
    if (!dep || !dateISO) return;

    const depDT = toLocalDateTime(dateISO, dep);
    if (!depDT) return;

    const diffMin = (depDT - now) / 60000;

    if (!["Scheduled","Preparing","Delayed"].includes(cur)) return;

    if (cur === "Scheduled" && diffMin <= 30 && diffMin > 0){
      setStatus(m, "Preparing", { by:"AUTO", source:"auto_time", note:"<=30min" });
      changed = true; return;
    }
    if ((cur === "Scheduled" || cur === "Preparing") && diffMin <= 0){
      setStatus(m, "Delayed", { by:"AUTO", source:"auto_time", note:"past_departure" });
      changed = true; return;
    }
    if (cur === "Delayed" && diffMin > 0){
      setStatus(m, "Preparing", { by:"AUTO", source:"auto_time", note:"departure_future" });
      changed = true; return;
    }
  });

  return changed;
}

/* =======================
   Departure cell (strike-through original)
======================= */
function formatDepartureCell(m){
  const d = m.details || {};
  const cur = d.departureFromHospital || "";
  const orig = d.departureOriginal || "";
  const changed = orig && cur && (orig !== cur);

  if (!cur && !orig) return `<span class="muted">-</span>`;
  if (changed){
    return `<span style="text-decoration:line-through;color:#6b7280;font-weight:900;margin-right:8px;display:inline-block;">${escapeHtml(orig)}</span>
            <span style="font-weight:1000;color:#111827;display:inline-block;">${escapeHtml(cur)}</span>`;
  }
  return `<span style="font-weight:1000;color:#111827;display:inline-block;">${escapeHtml(cur || orig)}</span>`;
}

/* =======================
   DETAILS RENDER (read-only)
======================= */
function fmt(v){ return v ? escapeHtml(v) : '<span class="muted">-</span>'; }
function section(title, rows){
  const kv = rows.map(([k,v]) => `<div class="k">${escapeHtml(k)}</div><div class="v">${v}</div>`).join("");
  return `<div class="section"><h3>${escapeHtml(title)}</h3><div class="kv">${kv}</div></div>`;
}
function renderStampHistory(m){
  const op = (m.details || {}).OperationStamp;
  if (!op || !Array.isArray(op.steps) || !op.steps.length) return '<span class="muted">-</span>';

  const items = [...op.steps]
    .sort((a,b)=> String(a.tsISO||"").localeCompare(String(b.tsISO||"")))
    .map(s => {
      const t = s.tsISO ? new Date(s.tsISO) : null;
      const tt = t ? t.toLocaleString("th-TH") : "-";
      const by = s.by || "-";
      const note = s.note ? ` ‚Ä¢ <span class="muted">${escapeHtml(s.note)}</span>` : "";
      return `<div style="margin:0 0 8px;">
        <div><strong>${escapeHtml(s.label || s.key || "-")}</strong></div>
        <div class="muted" style="font-size:12px;">${escapeHtml(tt)} ‚Ä¢ by: ${escapeHtml(by)}${note}</div>
      </div>`;
    }).join("");

  return items;
}
function renderStatusLog(m){
  const logs = (m.details || {}).statusLog;
  if (!Array.isArray(logs) || !logs.length) return '<span class="muted">-</span>';

  const items = [...logs].slice(-60).reverse().map(x => {
    const t = x.atISO ? new Date(x.atISO) : null;
    const tt = t ? t.toLocaleString("th-TH") : "-";
    const who = x.by || "-";
    const src = x.source ? ` ‚Ä¢ <span class="muted">${escapeHtml(x.source)}</span>` : "";
    const note = x.note ? ` ‚Ä¢ <span class="muted">${escapeHtml(x.note)}</span>` : "";
    return `<div style="margin:0 0 8px;">
      <div><strong>${escapeHtml(x.from)} ‚Üí ${escapeHtml(x.to)}</strong></div>
      <div class="muted" style="font-size:12px;">${escapeHtml(tt)} ‚Ä¢ by: ${escapeHtml(who)}${src}${note}</div>
    </div>`;
  }).join("");

  return items;
}

function renderDetails(m){
  window.__detailMission = m;

  const p = m.details || {};
  const blocks = [];

  blocks.push(section("Patient Information ‚Äî ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢", [
    ["Full Name", fmt(p.fullName)],
    ["Gender", fmt(p.gender)],
    ["Age (years)", fmt(p.ageYears)],
    ["Weight (kg)", fmt(p.weightKg)],
    ["Nationality", fmt(p.nationality)],
    ["HN", fmt(p.hn)],
    ["Ward", fmt(p.ward)],
    ["Diagnosis", fmt(p.diagnosis)],
    ["Purpose of Transport", fmt(p.purpose)]
  ]));

  blocks.push(section("Vehicle", [
    ["Vehicle Type", fmt(p.vehicleType)],
    ["Vehicle (free text)", fmt(m.vehicle)]
  ]));

  const ft = getFromTo(m);
  blocks.push(section("Locations ‚Äî ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà", [
    ["From", `
      ${fmt(ft.from)}
      <div style="margin-top:8px;">
        <button class="btn secondary tiny" type="button" onclick="openRouteTo('from')">Route</button>
      </div>
    `],
    ["From detail (optional)", fmt(ft.fromDetail)],
    ["To", `
      ${fmt(ft.to)}
      <div style="margin-top:8px;">
        <button class="btn secondary tiny" type="button" onclick="openRouteTo('to')">Route</button>
      </div>
    `],
    ["To detail (optional)", fmt(ft.toDetail)],
    ["From pin (lat,lng)", (p.fromLat && p.fromLng) ? fmt(`${p.fromLat}, ${p.fromLng}`) : '<span class="muted">-</span>'],
    ["To pin (lat,lng)", (p.toLat && p.toLng) ? fmt(`${p.toLat}, ${p.toLng}`) : '<span class="muted">-</span>']
  ]));

  const timeRows = [];
  if (p.baseLocation !== undefined) timeRows.push(["Base (SNH/SMCH)", fmt(p.baseLocation)]);

  const orig = p.departureOriginal || "";
  const cur = p.departureFromHospital || "";
  if (cur || orig){
    if (orig && cur && orig !== cur){
      timeRows.push(["Departure (original)", fmt(orig)]);
      timeRows.push(["Departure (current)", fmt(cur)]);
    } else {
      timeRows.push(["Departure from SNH/SMCH hospital", fmt(cur || orig)]);
    }
  }

  if (p.preDepartureBriefing) timeRows.push(["Pre-departure Briefing", fmt(p.preDepartureBriefing)]);
  if (p.schedArriveRefHosp) timeRows.push(["Scheduled Arrival at Referring Hospital", fmt(p.schedArriveRefHosp)]);
  if (p.schedArriveAirport) timeRows.push(["Scheduled Arrival at Airport", fmt(p.schedArriveAirport)]);
  if (p.schedFlightArrive) timeRows.push(["Scheduled Flight Arrival", fmt(p.schedFlightArrive)]);
  if (p.schedFlightDepart) timeRows.push(["Scheduled Flight Departure", fmt(p.schedFlightDepart)]);
  if (p.schedArriveHome) timeRows.push(["Scheduled Arrival at Home", fmt(p.schedArriveHome)]);

  blocks.push(section("Time Log ‚Äî ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤", timeRows.length ? timeRows : [["(No time log)", '<span class="muted">-</span>']]));

  blocks.push(section("Operation Stamp ‚Äî ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ stamp", [
    ["History", renderStampHistory(m)]
  ]));

  // ‚úÖ Keep only ONE Status Change Log section
  blocks.push(section("Status Change Log ‚Äî ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞", [
    ["History", renderStatusLog(m)]
  ]));

  // ‚úÖ Keep only ONE Mission section
  blocks.push(section("Mission", [
    ["Mission Group", fmt(m.missionGroup)],
    ["Mission Type (stored)", fmt(m.type)],
    ["Display Label (stored)", fmt(m.typeDisplay)],
    ["Type Key", fmt(m.typeKey)],
    ["Mission Type (table label)", fmt(getTypeLabelForTable(m))],
    ["Status", `<span class="badge ${badgeClassFromStatus(m.status)}">${escapeHtml(normStatus(m.status))}</span>`],
    ["Notes", fmt(m.notes)]
  ]));

  return blocks.join("");
}


/* =======================
   STAMP PATTERNS
======================= */
function makeSteps(list){ return list.map(x => ({ key:x.key, label:x.label })); }

const STEPS_BASE = makeSteps([
  { key:"actual_departure", label:"Actual departure : ‡∏≠‡∏≠‡∏Å‡∏ê‡∏≤‡∏ô" },
  { key:"driving", label:"Driving : ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á" },
  { key:"arriving_receiving", label:"Arriving at receiving facility: ‡∏ñ‡∏∂‡∏á ‡∏£‡∏û.‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á" },
  { key:"turnover_complete", label:"Completing turnover of care: ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à" },
  { key:"return_to_base", label:"Return to base: ‡∏ñ‡∏∂‡∏á‡∏ê‡∏≤‡∏ô" },
  { key:"back_in_service", label:"Back in service: ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô" }
]);

const STEPS_EMS = makeSteps([
  { key:"actual_departure", label:"Actual departure : ‡∏≠‡∏≠‡∏Å‡∏ê‡∏≤‡∏ô" },
  { key:"arriving_scene", label:"Arriving at scene : ‡∏ñ‡∏∂‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏" },
  { key:"initial_contact", label:"Initial patient contact : ‡∏û‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢" },
  { key:"packing_complete", label:"Complete packing : ‡πÅ‡∏û‡πá‡∏Ñ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏™‡∏£‡πá‡∏à" },
  { key:"depart_scene", label:"Departing scene: ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏" },
  { key:"driving", label:"Driving: ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á" },
  { key:"arriving_receiving", label:"Arriving at receiving facility: ‡∏ñ‡∏∂‡∏á ‡∏£‡∏û.‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á" },
  { key:"turnover_complete", label:"Completing turnover of care: ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à" },
  { key:"return_to_base", label:"Return to base: ‡∏ñ‡∏∂‡∏á‡∏ê‡∏≤‡∏ô" },
  { key:"back_in_service", label:"Back in service: ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô" }
]);

const STEPS_IFT_IN = makeSteps([
  { key:"actual_departure", label:"Actual departure: ‡∏≠‡∏≠‡∏Å‡∏ê‡∏≤‡∏ô" },
  { key:"arriving_referring", label:"Arriving at referring facility: ‡∏ñ‡∏∂‡∏á ‡∏£‡∏û.‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á" },
  { key:"initial_contact", label:"Initial patient contact: ‡∏û‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢" },
  { key:"packing_complete", label:"Complete packing: ‡πÅ‡∏û‡πá‡∏Ñ/‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏™‡∏£‡πá‡∏à" },
  { key:"depart_referring", label:"Departing referring facility: ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å ‡∏£‡∏û.‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á" },
  { key:"driving", label:"Driving: ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á" },
  { key:"arriving_receiving", label:"Arriving at receiving facility: ‡∏ñ‡∏∂‡∏á ‡∏£‡∏û.‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á" },
  { key:"turnover_complete", label:"Completing turnover of care: ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à" },
  { key:"return_to_base", label:"Return to base: ‡∏ñ‡∏∂‡∏á‡∏ê‡∏≤‡∏ô" },
  { key:"back_in_service", label:"Back in service: ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô" }
]);

const STEPS_IFT_OUT = makeSteps([
  { key:"actual_departure", label:"Actual departure: ‡∏≠‡∏≠‡∏Å‡∏ê‡∏≤‡∏ô" },
  { key:"arriving_referring", label:"Arriving at referring facility: ‡∏ñ‡∏∂‡∏á‡∏ï‡∏∂‡∏Å/‡∏´‡πâ‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢" },
  { key:"initial_contact", label:"Initial patient contact: ‡∏û‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢" },
  { key:"packing_complete", label:"Complete packing: ‡πÅ‡∏û‡πá‡∏Ñ/‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏™‡∏£‡πá‡∏à" },
  { key:"depart_hospital", label:"Departing hospital: ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å ‡∏£‡∏û.‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á" },
  { key:"driving", label:"Driving: ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á" },
  { key:"arriving_receiving", label:"Arriving at receiving facility: ‡∏ñ‡∏∂‡∏á ‡∏£‡∏û.‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á" },
  { key:"turnover_complete", label:"Completing turnover of care: ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à" },
  { key:"return_to_base", label:"Return to base: ‡∏ñ‡∏∂‡∏á‡∏ê‡∏≤‡∏ô" },
  { key:"back_in_service", label:"Back in service: ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô" }
]);

const STEPS_ESCORT_IN = makeSteps([
  { key:"actual_departure", label:"Actual departure: ‡∏≠‡∏≠‡∏Å‡∏ê‡∏≤‡∏ô" },
  { key:"arriving_airport", label:"Arriving at airport: ‡∏ñ‡∏∂‡∏á‡∏™‡∏ô‡∏≤‡∏°‡∏ö‡∏¥‡∏ô" },
  { key:"initial_contact", label:"Initial patient contact: ‡∏û‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢" },
  { key:"packing_complete", label:"Complete packing: ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏™‡∏£‡πá‡∏à" },
  { key:"depart_airport", label:"Departing airport: ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏™‡∏ô‡∏≤‡∏°‡∏ö‡∏¥‡∏ô" },
  { key:"driving", label:"Driving: ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á" },
  { key:"arriving_receiving", label:"Arriving at receiving facility: ‡∏ñ‡∏∂‡∏á ‡∏£‡∏û.‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á" },
  { key:"turnover_complete", label:"Completing turnover of care: ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à" },
  { key:"return_to_base", label:"Return to base: ‡∏ñ‡∏∂‡∏á‡∏ê‡∏≤‡∏ô" },
  { key:"back_in_service", label:"Back in service: ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô" }
]);

const STEPS_ESCORT_OUT = makeSteps([
  { key:"actual_departure", label:"Actual departure: ‡∏≠‡∏≠‡∏Å‡∏ê‡∏≤‡∏ô" },
  { key:"arriving_patient_location", label:"Arriving at patient location: ‡∏ñ‡∏∂‡∏á‡∏ï‡∏∂‡∏Å/‡∏´‡πâ‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢" },
  { key:"initial_contact", label:"Initial patient contact: ‡∏û‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢" },
  { key:"packing_complete", label:"Complete packing: ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏™‡∏£‡πá‡∏à" },
  { key:"depart_hospital", label:"Departing hospital: ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å ‡∏£‡∏û.‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á" },
  { key:"driving", label:"Driving: ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á" },
  { key:"arriving_airport", label:"Arriving at airport: ‡∏ñ‡∏∂‡∏á‡∏™‡∏ô‡∏≤‡∏°‡∏ö‡∏¥‡∏ô" },
  { key:"turnover_complete", label:"Completing turnover/hand-off: ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à" },
  { key:"return_to_base", label:"Return to base: ‡∏ñ‡∏∂‡∏á‡∏ê‡∏≤‡∏ô" },
  { key:"back_in_service", label:"Back in service: ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô" }
]);

const STEPS_PROC_SEND_WAIT_PICK = makeSteps([
  { key:"actual_departure", label:"Actual departure: ‡∏≠‡∏≠‡∏Å‡∏ê‡∏≤‡∏ô" },
  { key:"arriving_patient_location", label:"Arriving at patient location: ‡∏ñ‡∏∂‡∏á‡∏ï‡∏∂‡∏Å/‡∏´‡πâ‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢" },
  { key:"initial_contact", label:"Initial patient contact: ‡∏û‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢" },
  { key:"packing_complete", label:"Complete packing: ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏™‡∏£‡πá‡∏à" },
  { key:"depart_origin", label:"Departing origin: ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å ‡∏£‡∏û./‡∏ï‡∏∂‡∏Å‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á" },
  { key:"driving", label:"Driving: ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á" },
  { key:"arriving_procedure", label:"Arriving at procedure facility: ‡∏ñ‡∏∂‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£" },
  { key:"handoff_complete", label:"Completing hand-off: ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠/‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏ô‡∏±‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à" },
  { key:"wait_pickup", label:"Waiting for pickup: ‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢" },
  { key:"depart_procedure", label:"Departing procedure facility: ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£" },
  { key:"driving_back", label:"Driving back: ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏•‡∏±‡∏ö" },
  { key:"arriving_destination", label:"Arriving at destination: ‡∏ñ‡∏∂‡∏á‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á" },
  { key:"turnover_complete", label:"Completing turnover of care: ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à" },
  { key:"return_to_base", label:"Return to base: ‡∏ñ‡∏∂‡∏á‡∏ê‡∏≤‡∏ô" },
  { key:"back_in_service", label:"Back in service: ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô" }
]);

const STEPS_PROC_SEND = makeSteps([
  { key:"actual_departure", label:"Actual departure: ‡∏≠‡∏≠‡∏Å‡∏ê‡∏≤‡∏ô" },
  { key:"arriving_patient_location", label:"Arriving at patient location: ‡∏ñ‡∏∂‡∏á‡∏ï‡∏∂‡∏Å/‡∏´‡πâ‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢" },
  { key:"initial_contact", label:"Initial patient contact: ‡∏û‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢" },
  { key:"packing_complete", label:"Complete packing: ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏™‡∏£‡πá‡∏à" },
  { key:"depart_origin", label:"Departing origin: ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å ‡∏£‡∏û./‡∏ï‡∏∂‡∏Å‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á" },
  { key:"driving", label:"Driving: ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á" },
  { key:"arriving_procedure", label:"Arriving at procedure facility: ‡∏ñ‡∏∂‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£" },
  { key:"handoff_complete", label:"Completing hand-off: ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠/‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏ô‡∏±‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à" },
  { key:"return_to_base", label:"Return to base: ‡∏ñ‡∏∂‡∏á‡∏ê‡∏≤‡∏ô" },
  { key:"back_in_service", label:"Back in service: ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô" }
]);

const STEPS_PROC_PICK = makeSteps([
  { key:"actual_departure", label:"Actual departure: ‡∏≠‡∏≠‡∏Å‡∏ê‡∏≤‡∏ô" },
  { key:"arriving_procedure", label:"Arriving at procedure facility: ‡∏ñ‡∏∂‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£" },
  { key:"initial_contact", label:"Initial patient contact: ‡∏û‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢" },
  { key:"packing_complete", label:"Complete packing: ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏™‡∏£‡πá‡∏à" },
  { key:"depart_procedure", label:"Departing procedure facility: ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£" },
  { key:"driving", label:"Driving: ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á" },
  { key:"arriving_destination", label:"Arriving at destination: ‡∏ñ‡∏∂‡∏á ‡∏£‡∏û./‡∏ï‡∏∂‡∏Å‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á" },
  { key:"turnover_complete", label:"Completing turnover of care: ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à" },
  { key:"return_to_base", label:"Return to base: ‡∏ñ‡∏∂‡∏á‡∏ê‡∏≤‡∏ô" },
  { key:"back_in_service", label:"Back in service: ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô" }
]);

const STEPS_SERVICE_PICKUP = makeSteps([
  { key:"actual_departure", label:"Actual departure: ‡∏≠‡∏≠‡∏Å‡∏ê‡∏≤‡∏ô" },
  { key:"arriving_pickup", label:"Arriving at pickup point: ‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö (‡∏ö‡πâ‡∏≤‡∏ô/‡∏à‡∏∏‡∏î‡∏ô‡∏±‡∏î)" },
  { key:"initial_contact", label:"Initial patient contact: ‡∏û‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢" },
  { key:"packing_complete", label:"Complete packing: ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏™‡∏£‡πá‡∏à" },
  { key:"depart_pickup", label:"Departing pickup point: ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö" },
  { key:"driving", label:"Driving: ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á" },
  { key:"arriving_dropoff", label:"Arriving at drop-off: ‡∏ñ‡∏∂‡∏á ‡∏£‡∏û./‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á" },
  { key:"turnover_complete", label:"Completing turnover/hand-off: ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à" },
  { key:"return_to_base", label:"Return to base: ‡∏ñ‡∏∂‡∏á‡∏ê‡∏≤‡∏ô" },
  { key:"back_in_service", label:"Back in service: ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô" }
]);

const STEPS_SERVICE_SEND = makeSteps([
  { key:"actual_departure", label:"Actual departure: ‡∏≠‡∏≠‡∏Å‡∏ê‡∏≤‡∏ô" },
  { key:"arriving_patient_location", label:"Arriving at patient location: ‡∏ñ‡∏∂‡∏á‡∏ï‡∏∂‡∏Å/‡∏´‡πâ‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢" },
  { key:"initial_contact", label:"Initial patient contact: ‡∏û‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢" },
  { key:"packing_complete", label:"Complete packing: ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏™‡∏£‡πá‡∏à" },
  { key:"depart_origin", label:"Departing origin: ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å ‡∏£‡∏û./‡∏ï‡∏∂‡∏Å‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á" },
  { key:"driving", label:"Driving: ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á" },
  { key:"arriving_dropoff", label:"Arriving at drop-off: ‡∏ñ‡∏∂‡∏á‡∏ö‡πâ‡∏≤‡∏ô/‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á" },
  { key:"handoff_complete", label:"Completing hand-off: ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠/‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à" },
  { key:"return_to_base", label:"Return to base: ‡∏ñ‡∏∂‡∏á‡∏ê‡∏≤‡∏ô" },
  { key:"back_in_service", label:"Back in service: ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô" }
]);

function patternForTypeKey(typeKey){
  const k = String(typeKey || "").trim();

  if (k === "EMS_BASIC" || k === "EMS_ADV") return { patternKey:"EMS", title:"Operation for EMS", steps: STEPS_EMS };

  if (k === "IFT_BASIC_IN" || k === "IFT_ADV_IN" || k === "AP_CLINIC_IFT") return { patternKey:"IFT_IN", title:"Operation ‚Äì IFT (Refer In)", steps: STEPS_IFT_IN };
  if (k === "IFT_BASIC_OUT" || k === "IFT_ADV_OUT") return { patternKey:"IFT_OUT", title:"Operation ‚Äì IFT (Refer Out)", steps: STEPS_IFT_OUT };

  if (k === "AP_ESCORT_IN" || k === "TARMAC_IN") return { patternKey:"ESCORT_IN", title:"Operation ‚Äì Escort/Tarmac (In)", steps: STEPS_ESCORT_IN };
  if (k === "AP_ESCORT_OUT" || k === "TARMAC_OUT") return { patternKey:"ESCORT_OUT", title:"Operation ‚Äì Escort/Tarmac (Out)", steps: STEPS_ESCORT_OUT };

  if (k === "PROC_SEND_WAIT_PICK") return { patternKey:"PROC_SEND_WAIT_PICK", title:"Operation ‚Äì Procedure (Send & Wait & Pick)", steps: STEPS_PROC_SEND_WAIT_PICK };
  if (k === "PROC_SEND") return { patternKey:"PROC_SEND", title:"Operation ‚Äì Procedure (Send)", steps: STEPS_PROC_SEND };
  if (k === "PROC_PICK") return { patternKey:"PROC_PICK", title:"Operation ‚Äì Procedure (Pick)", steps: STEPS_PROC_PICK };

  if (k === "HOME_PICKUP" || k === "HHC" || k === "HHC_PICKUP") return { patternKey:"SERVICE_PICKUP", title:"Operation ‚Äì Service (Pickup)", steps: STEPS_SERVICE_PICKUP };
  if (k === "HOME_DISCH" || k === "HHC_SEND") return { patternKey:"SERVICE_SEND", title:"Operation ‚Äì Service (Send/Discharge)", steps: STEPS_SERVICE_SEND };

  if (k === "OTHER") return { patternKey:"OTHER", title:"Operation ‚Äì Other", steps: STEPS_SERVICE_PICKUP };

  return { patternKey:"UNKNOWN", title:"Operation", steps: STEPS_BASE };
}

/* =======================
   DEVICE ID
======================= */
function getDeviceId(){
  const key = "SCC_DEVICE_ID";
  let v = localStorage.getItem(key);
  if (!v){
    v = "dev_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
    localStorage.setItem(key, v);
  }
  return v;
}
const DEVICE_ID = getDeviceId();

/* =======================
   MAIN STATE
======================= */
let allMissions = [];
let currentMissionId = null;
let stampMissionId = null;

// default date filter = today
const todayISO = new Date().toISOString().slice(0,10);
const dateFilterEl = document.getElementById("dateFilter");
if (dateFilterEl && !dateFilterEl.value) dateFilterEl.value = todayISO;

/* =======================
   TIME FOR BUTTON = Return to base
======================= */
function getReturnToBaseISO(m){
  const op = (m.details || {}).OperationStamp;
  if (!op || !Array.isArray(op.steps)) return "";
  const s = op.steps.find(x => String(x.key) === "return_to_base");
  return s?.tsISO || "";
}

/* =======================
   Collapsible groups
======================= */
function _collapseKey(name){ return "SCC_COLLAPSE_" + String(name||"").toUpperCase(); }
function isCollapsed(name){ return localStorage.getItem(_collapseKey(name)) === "1"; }
function setCollapsed(name, v){ localStorage.setItem(_collapseKey(name), v ? "1" : "0"); }
function toggleGroup(name){ setCollapsed(name, !isCollapsed(name)); render(); }

/* =======================
   REALTIME LISTENERS
======================= */
(function bindRealtimeListeners(){
  try{
    const ch = getSyncChannel();
    if (ch){
      ch.onmessage = (ev) => {
        const msg = ev?.data || {};
        if (msg.eventName === "MISSIONS_UPDATED") render();
      };
    }
  }catch{}
  window.addEventListener("storage", (e) => {
    if (!e) return;
    if (e.key === STORAGE_KEY || e.key === "__SCC_SYNC_PING__") render();
  });
})();

/* =======================
   ‚úÖ BUGFIX: refresh detail modal if still open
======================= */
function refreshOpenDetailsIfAny(){
  const overlayEl = document.getElementById("modalOverlay");
  if (!overlayEl || overlayEl.style.display !== "flex") return;
  if (!currentMissionId) return;

  const missions = readMissions();
  const m = missions.find(x => String(x.id) === String(currentMissionId));
  if (!m){
    closeModal();
    return;
  }

  window.__detailMission = m;
  const titleEl = document.getElementById("modalTitle");
  const subEl = document.getElementById("modalSub");
  const bodyEl = document.getElementById("modalBody");

  if (titleEl) titleEl.textContent = `Mission ${m.id}`;

  const dep = (m.details||{}).departureFromHospital || (m.details||{}).departureOriginal || "";
  const sub = [
    `${getMissionDateISO(m) || "-"} ${dep||""}`.trim(),
    getTypeLabelForTable(m)
  ].filter(Boolean).join(" ‚Ä¢ ");
  if (subEl) subEl.textContent = sub;

  if (bodyEl) bodyEl.innerHTML = renderDetails(m);
  syncDetailsFooterButton();
}

/* =======================
   RENDER TABLE
======================= */
function render(){
  allMissions = readMissions();

  // auto update statuses first
  if (autoUpdatePreparingDelayed(allMissions)){
    writeMissions(allMissions);
    allMissions = readMissions();
  }

  const selectedDate = (document.getElementById("dateFilter")?.value || getTodayISO());

  // top boxes
  const elTotal = document.getElementById("total");
  const elTodayTotal = document.getElementById("todayTotal");
  const elActiveToday = document.getElementById("activeToday");
  const elRemainScheduled = document.getElementById("remainingScheduled");
  const elCompletedToday = document.getElementById("completedN");
  const elCancelledToday = document.getElementById("cancelledN");

  const totalYear = allMissions.length;
  const dayRows = allMissions.filter(m => String(m.date ?? "").slice(0,10) === selectedDate);
  const totalToday = dayRows.length;

  const activeSet = new Set(["Preparing","Delayed","Transporting","Returning"]);
  const activeToday = dayRows.filter(m => activeSet.has(normStatus(m.status))).length;
  const remainingScheduled = dayRows.filter(m => normStatus(m.status) === "Scheduled").length;
  const completedToday = dayRows.filter(m => normStatus(m.status) === "Completed").length;
  const cancelledToday = dayRows.filter(m => normStatus(m.status) === "Cancelled").length;

  if (elTotal) elTotal.innerText = totalYear;
  if (elTodayTotal) elTodayTotal.innerText = totalToday;
  if (elActiveToday) elActiveToday.innerText = activeToday;
  if (elRemainScheduled) elRemainScheduled.innerText = remainingScheduled;
  if (elCompletedToday) elCompletedToday.innerText = completedToday;
  if (elCancelledToday) elCancelledToday.innerText = cancelledToday;

  // filters
  const searchEl = document.getElementById("search");
  const statusEl = document.getElementById("statusFilter");
  const titleEl  = document.getElementById("tableTitle");
  const bodyEl   = document.getElementById("missionBody");
  const noteEl   = document.getElementById("countNote");

  const q = (searchEl?.value || "").trim().toLowerCase();
  const status = statusEl?.value || "ALL";

  const titleDate = new Date(selectedDate + "T00:00:00");
  if (titleEl){
    titleEl.innerText = `Missions: ${titleDate.toLocaleDateString("th-TH", { year:"numeric", month:"short", day:"numeric" })}`;
  }

  let rows = allMissions.filter(m => String(m.date ?? "").slice(0,10) === selectedDate);

  if (status !== "ALL"){
    rows = rows.filter(m => normStatus(m.status) === status);
  }

  if (q){
    rows = rows.filter(m => {
      const ft = getFromTo(m);
      const d = m.details || {};
      const dep = d.departureFromHospital || d.departureOriginal || "";
      const blob = [
        m.id,
        getTypeLabelForTable(m),
        m.typeDisplay, m.type, m.typeKey,
        dep,
        ft.from, ft.to, ft.fromDetail, ft.toDetail,
        m.notes, m.status
      ].join(" ").toLowerCase();
      return blob.includes(q);
    });
  }

  // sort + grouping
  function _depStr(m){
    const d = m.details || {};
    return d.departureFromHospital || d.departureOriginal || "";
  }
  function _depMinutesOfDay(m){
    const dep = _depStr(m);
    if (!dep || !String(dep).includes(":")) return 999999;
    const [h, mi] = String(dep).split(":").map(n => parseInt(n, 10));
    if (!Number.isFinite(h) || !Number.isFinite(mi)) return 999999;
    return (h * 60) + mi;
  }
  function _tierRank(status){
    const s = normStatus(status);
    if (s === "Completed") return 1;
    if (s === "Cancelled") return 2;
    return 0;
  }
  function _activeBlockRank(status){
    const s = normStatus(status);
    if (s === "Delayed") return 0;
    if (s === "Preparing") return 1;
    if (s === "Transporting") return 2;
    if (s === "Returning") return 3;
    if (s === "Scheduled") return 4;
    return 4;
  }

  rows.sort((a,b)=> {
    const ta = _tierRank(a.status);
    const tb = _tierRank(b.status);
    if (ta !== tb) return ta - tb;

    if (ta === 0){
      const ba = _activeBlockRank(a.status);
      const bb = _activeBlockRank(b.status);
      if (ba !== bb) return ba - bb;

      const ma = _depMinutesOfDay(a);
      const mb = _depMinutesOfDay(b);
      if (ma !== mb) return ma - mb;

      return String(a.id||"").localeCompare(String(b.id||""));
    }

    const ma = _depMinutesOfDay(a);
    const mb = _depMinutesOfDay(b);
    if (ma !== mb) return ma - mb;
    return String(a.id||"").localeCompare(String(b.id||""));
  });

  if (!bodyEl) return;

  if (!rows.length){
    bodyEl.innerHTML = `<tr><td colspan="8" class="muted">No missions found.</td></tr>`;
    if (noteEl) noteEl.innerText = "";
    refreshOpenDetailsIfAny();
    return;
  }

  function dividerRow(){
    return `<tr class="group-divider"><td colspan="8"></td></tr>`;
  }
  function rowBgClassByStatus(s){
    const x = normStatus(s);
    if (x === "Cancelled") return "row-cancelled";
    if (x === "Completed") return "row-completed";
    return "row-active";
  }

  const completedCollapsed = isCollapsed("completed");
  const cancelledCollapsed = isCollapsed("cancelled");
  const completedCount = rows.filter(x => _tierRank(x.status) === 1).length;
  const cancelledCount = rows.filter(x => _tierRank(x.status) === 2).length;

  function groupHeaderRow(kind, count){
    const collapsed = isCollapsed(kind);
    const title = (kind === "completed") ? "Completed" : "Cancelled";
    const btnText = collapsed ? "Show" : "Hide";
    return `
      <tr class="group-toggle">
        <td colspan="8">
          <div class="groupToggleBar">
            <div class="groupToggleLeft">
              <span>${title}</span>
              <span class="groupToggleCount">${count}</span>
            </div>
            <button class="btn light tiny" type="button" onclick="toggleGroup('${kind}')">${btnText}</button>
          </div>
        </td>
      </tr>
    `;
  }

  let html = "";
  let lastKey = null;
  let injectedCompletedHeader = false;
  let injectedCancelledHeader = false;

  rows.forEach(m => {
    const s = normStatus(m.status);
    const tier = _tierRank(s);

    if (tier === 1 && !injectedCompletedHeader){
      if (html) html += dividerRow();
      html += groupHeaderRow("completed", completedCount);
      injectedCompletedHeader = true;
      if (completedCollapsed) return;
      if (completedCount) html += dividerRow();
    }
    if (tier === 2 && !injectedCancelledHeader){
      if (html) html += dividerRow();
      html += groupHeaderRow("cancelled", cancelledCount);
      injectedCancelledHeader = true;
      if (cancelledCollapsed) return;
      if (cancelledCount) html += dividerRow();
    }

    if (tier === 1 && completedCollapsed) return;
    if (tier === 2 && cancelledCollapsed) return;

    const key = (tier === 0) ? `A-${_activeBlockRank(s)}` : `T-${tier}`;
    if (key !== lastKey){
      if (html) html += dividerRow();
      lastKey = key;
    }

    const rowClass = rowBgClassByStatus(s);
    const typeShort = getTypeLabelForTable(m);
    const ft = getFromTo(m);

    const op = (m.details||{}).OperationStamp;
    const isCompleted = (op?.status === "Completed" || s === "Completed");
    const rtbISO = getReturnToBaseISO(m);
    const hhmm = rtbISO ? isoToHHMM(rtbISO) : "--:--";
    const stampBtnClass = isCompleted ? "pill timeDone" : "pill onDuty";
    const stampBtnLabel = isCompleted ? `Time ${hhmm}` : "On Duty";

    html += `
      <tr class="${rowClass}">
        <td><strong>${escapeHtml(m.id ?? "-")}</strong></td>
        <td>${escapeHtml(String(m.date ?? "").slice(0,10) || "-")}</td>
        <td>${formatDepartureCell(m)}</td>
        <td title="${escapeHtml(typeShort)}">${escapeHtml(typeShort)}</td>
        <td>${escapeHtml(ft.from || "-")}</td>
        <td>${escapeHtml(ft.to || "-")}</td>
        <td>
          <div class="statusCell">
            <span class="badge ${badgeClassFromStatus(s)}">${escapeHtml(s)}</span>
            ${getStatusIconsHTML(s)}
          </div>
        </td>
        <td>
          <div class="actionCell">
            <button class="btn light" onclick="openDetails('${jsStr(m.id)}')">Details</button>
            <button class="btn ${stampBtnClass}" onclick="openStamp('${jsStr(m.id)}')">${stampBtnLabel}</button>
          </div>
        </td>
      </tr>
    `;
  });

  bodyEl.innerHTML = html;
  if (noteEl) noteEl.innerText = `Showing ${rows.length} mission(s)`;

  syncDetailsFooterButton();
  refreshOpenDetailsIfAny();
}

/* =======================
   DETAILS MODAL
======================= */
function syncDetailsFooterButton(){
  const modalOverlay = document.getElementById("modalOverlay");
  if (!modalOverlay || modalOverlay.style.display !== "flex" || !currentMissionId) return;

  const missions = readMissions();
  const m = missions.find(x => String(x.id) === String(currentMissionId));
  if (!m) return;

  const op = (m.details||{}).OperationStamp;
  const isCompleted = (op?.status === "Completed" || normStatus(m.status) === "Completed");
  const rtbISO = getReturnToBaseISO(m);
  const hhmm = rtbISO ? isoToHHMM(rtbISO) : "--:--";

  const openStampBtn = document.getElementById("openStampBtn");
  if (!openStampBtn) return;

  openStampBtn.className = "btn " + (isCompleted ? "pill timeDone" : "pill onDuty");
  openStampBtn.textContent = isCompleted ? `Time ${hhmm}` : "On Duty";
}

function openDetails(id){
  const missions = readMissions();
  const m = missions.find(x => String(x.id) === String(id));
  if (!m) return;

  currentMissionId = m.id;
  window.__detailMission = m;

  const titleEl = document.getElementById("modalTitle");
  const subEl = document.getElementById("modalSub");
  const bodyEl = document.getElementById("modalBody");
  const overlayEl = document.getElementById("modalOverlay");

  if (titleEl) titleEl.textContent = `Mission ${m.id}`;

  const dep = (m.details||{}).departureFromHospital || (m.details||{}).departureOriginal || "";
  const sub = [
    `${getMissionDateISO(m) || "-"} ${dep||""}`.trim(),
    getTypeLabelForTable(m)
  ].filter(Boolean).join(" ‚Ä¢ ");
  if (subEl) subEl.textContent = sub;

  if (bodyEl) bodyEl.innerHTML = renderDetails(m);
  if (overlayEl) overlayEl.style.display = "flex";

  syncDetailsFooterButton();
}

function closeModal(){
  const overlayEl = document.getElementById("modalOverlay");
  const bodyEl = document.getElementById("modalBody");
  if (overlayEl) overlayEl.style.display = "none";
  if (bodyEl) bodyEl.innerHTML = "";
  currentMissionId = null;
  window.__detailMission = null;
}

document.getElementById("closeModalBtn")?.addEventListener("click", closeModal);
document.getElementById("modalOverlay")?.addEventListener("click", (e) => {
  const overlayEl = document.getElementById("modalOverlay");
  if (e.target === overlayEl) closeModal();
});
document.getElementById("openStampBtn")?.addEventListener("click", () => {
  if (!currentMissionId) return;
  openStamp(currentMissionId);
});
document.getElementById("cancelMissionBtn")?.addEventListener("click", () => {
  openCancelDialog();
});

/* =======================
   CANCEL DIALOG
======================= */
function _getSelectedCancelReasonKey(){
  const el = document.querySelector('input[name="cancelReason"]:checked');
  return el ? String(el.value || "").trim() : "";
}
function _cancelReasonText(key){
  if (key === "MISSED") return "Missed mission";
  if (key === "ABORTED") return "Aborted mission";
  if (key === "INCORRECT") return "Incorrect information";
  return "";
}

function openCancelDialog(){
  if (!currentMissionId) return;

  const missions = readMissions();
  const m = missions.find(x => String(x.id) === String(currentMissionId));
  if (!m) return;

  const s = normStatus(m.status);
  if (s === "Completed"){ alert("Mission ‡∏ô‡∏µ‡πâ Completed ‡πÅ‡∏•‡πâ‡∏ß ‚Äî ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ Cancel ‡πÑ‡∏î‡πâ"); return; }
  if (s === "Cancelled"){ alert("Mission ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å Cancelled ‡πÅ‡∏•‡πâ‡∏ß"); return; }

  const cancelTitleEl   = document.getElementById("cancelTitle");
  const cancelSubEl     = document.getElementById("cancelSub");
  const cancelOverlayEl = document.getElementById("cancelOverlay");
  const cancelByEl      = document.getElementById("cancelBy");

  if (cancelTitleEl) cancelTitleEl.textContent = `Cancel mission ${m.id}`;
  if (cancelSubEl) cancelSubEl.textContent = `${getMissionDateISO(m) || "-"} ‚Ä¢ ${getTypeLabelForTable(m)}`;

  document.querySelectorAll('input[name="cancelReason"]').forEach(n => n.checked = false);
  const def = document.querySelector('input[name="cancelReason"][value="MISSED"]');
  if (def) def.checked = true;

  if (cancelByEl) cancelByEl.value = "";

  if (cancelOverlayEl) cancelOverlayEl.style.display = "flex";
}

function closeCancelDialog(){
  const cancelOverlayEl = document.getElementById("cancelOverlay");
  const cancelByEl      = document.getElementById("cancelBy");

  if (cancelOverlayEl) cancelOverlayEl.style.display = "none";
  document.querySelectorAll('input[name="cancelReason"]').forEach(n => n.checked = false);
  if (cancelByEl) cancelByEl.value = "";
}

function getMissionById(id){
  const missions = readMissions();
  return missions.find(x => String(x.id) === String(id)) || null;
}
function upsertMission(m){
  const missions = readMissions();
  const idx = missions.findIndex(x => String(x.id) === String(m.id));
  if (idx >= 0) missions[idx] = m;
  else missions.push(m);
  writeMissions(missions);
}

function confirmCancelMission(){
  if (!currentMissionId) return;

  const key = _getSelectedCancelReasonKey();
  if (!key){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£ Cancel"); return; }

  const cancelBy = String(document.getElementById("cancelBy")?.value || "").trim();
  if (!cancelBy){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á (Cancelled by)"); return; }

  const ok = confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£ Cancel mission ‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?\n\nReason: ${_cancelReasonText(key)}\nCancelled by: ${cancelBy}`);
  if (!ok) return;

  const m = getMissionById(currentMissionId);
  if (!m) return;

  // ‚úÖ set cancelled + log
  setStatus(m, "Cancelled", { by: cancelBy, source:"modal_cancel", note:_cancelReasonText(key) });

  // ‚úÖ store cancel record
  m.details = m.details || {};
  m.details.cancel = m.details.cancel || {};
  m.details.cancel.cancelReasonKey = key;
  m.details.cancel.cancelReason    = _cancelReasonText(key);
  m.details.cancel.cancelledAtISO  = nowISO();
  m.details.cancel.cancelledBy     = cancelBy;
  m.details.cancel.source          = "OP";
  m.details.cancel.deviceId        = DEVICE_ID;

  upsertMission(m);

  closeCancelDialog();

  // refresh modal body
  const mm = getMissionById(currentMissionId) || m;
  const bodyEl = document.getElementById("modalBody");
  if (bodyEl) bodyEl.innerHTML = renderDetails(mm);

  syncDetailsFooterButton();
  render();
}

document.getElementById("closeCancelBtn")?.addEventListener("click", closeCancelDialog);
document.getElementById("cancelCancelBtn")?.addEventListener("click", closeCancelDialog);
document.getElementById("confirmCancelBtn")?.addEventListener("click", confirmCancelMission);
document.getElementById("cancelOverlay")?.addEventListener("click", (e) => {
  const overlay = document.getElementById("cancelOverlay");
  if (e.target === overlay) closeCancelDialog();
});

/* =======================
   STAMP PANEL HELPERS
======================= */
function ensureOperationStamp(m){
  m.details = m.details || {};
  if (!m.details.OperationStamp){
    const pat = patternForTypeKey(m.typeKey);
    m.details.OperationStamp = {
      startedAt: nowISO(),
      startedBy: "",
      status: "Active",
      patternKey: pat.patternKey,
      steps: [],
      lastUpdatedAt: nowISO()
    };
  }
  const pat = patternForTypeKey(m.typeKey);
  m.details.OperationStamp.patternKey = pat.patternKey;
  m.details.OperationStamp.lastUpdatedAt = nowISO();
  return m;
}
function stepAlreadyStamped(opStamp, stepKey){
  return (opStamp.steps || []).some(s => String(s.key) === String(stepKey));
}

/* =======================
   Returning rules helper
======================= */
function shouldBeReturning(mm, stepKey){
  const pk = String(mm?.details?.OperationStamp?.patternKey || patternForTypeKey(mm?.typeKey).patternKey || "").trim();
  const k  = String(stepKey || "").trim();

  if (pk === "IFT_IN" && k === "driving") return true;
  if (pk === "IFT_OUT" && k === "turnover_complete") return true;
  if (pk === "ESCORT_IN" && k === "driving") return true;
  if (pk === "PROC_SEND" && k === "handoff_complete") return true;
  if (pk === "PROC_PICK" && k === "driving") return true;
  if (pk === "SERVICE_PICKUP" && k === "driving") return true;
  if (pk === "SERVICE_SEND" && k === "handoff_complete") return true;

  if (pk === "PROC_SEND_WAIT_PICK"){
    if (k === "turnover_complete") return true;

    if (k === "driving"){
      const keys = new Set((mm.details?.OperationStamp?.steps || []).map(s => String(s.key)));
      if (keys.has("depart_procedure")) return true;
    }
    if (k === "driving_back") return true;
  }

  return false;
}

/* =======================
   Completed only when ALL steps stamped
======================= */
function hasAllStepsStamped(mm){
  const op = mm?.details?.OperationStamp;
  if (!op) return false;

  const pat = patternForTypeKey(mm.typeKey);
  const needed = new Set((pat.steps || []).map(s => String(s.key)));
  const stamped = new Set((op.steps || []).map(s => String(s.key)));

  for (const k of needed){
    if (!stamped.has(k)) return false;
  }
  return needed.size > 0;
}

/* =======================
   OPEN STAMP PANEL
======================= */
function openStamp(id){
  const m = getMissionById(id);
  if (!m) return;

  stampMissionId = m.id;

  const pat = patternForTypeKey(m.typeKey);
  document.getElementById("stampTitle").textContent = `${pat.title}`;
  const ft = getFromTo(m);
  const dep = (m.details||{}).departureFromHospital || (m.details||{}).departureOriginal || "";
  document.getElementById("stampSub").textContent = [
    `Mission ${m.id}`,
    `${String(m.date||"").slice(0,10)} ${dep || ""}`.trim(),
    getTypeLabelForTable(m),
    `${ft.from} ‚Üí ${ft.to}`
  ].filter(Boolean).join(" ‚Ä¢ ");

  const mm = ensureOperationStamp(m);
  upsertMission(mm);

  const op = mm.details.OperationStamp;
  document.getElementById("stampBy").value = op.startedBy || "";
  document.getElementById("stampNote").value = "";

  renderStampGrid(mm);
  document.getElementById("stampOverlay").style.display = "flex";
  updateStampFooter(mm);
}

function updateStampFooter(m){
  const op = (m.details||{}).OperationStamp;
  if (!op) { document.getElementById("stampFooterInfo").textContent = "-"; return; }
  const started = op.startedAt ? new Date(op.startedAt).toLocaleString("th-TH") : "-";
  const by = op.startedBy || "-";
  const st = op.status || "Active";
  document.getElementById("stampFooterInfo").textContent = `Started: ${started} ‚Ä¢ By: ${by} ‚Ä¢ Status: ${st} ‚Ä¢ Device: ${DEVICE_ID}`;
}

function closeStamp(){
  document.getElementById("stampOverlay").style.display = "none";
  document.getElementById("stampGrid").innerHTML = "";
  stampMissionId = null;
}
document.getElementById("closeStampBtn")?.addEventListener("click", closeStamp);
document.getElementById("stampOverlay")?.addEventListener("click", (e)=> {
  const overlay = document.getElementById("stampOverlay");
  if (e.target === overlay) closeStamp();
});

function renderStampGrid(m){
  const pat = patternForTypeKey(m.typeKey);
  const op = (m.details||{}).OperationStamp || { steps:[] };

  const rows = pat.steps.map(step => {
    const found = (op.steps || []).find(s => String(s.key) === String(step.key));
    const disabled = !!found || op.status === "Completed";
    const btnLabel = found ? "Done" : "Stamp";

    const rawLabel = String(step.label || "");
    let en = rawLabel, th = "";
    if (rawLabel.includes(":")){
      const parts = rawLabel.split(":");
      en = (parts[0] || "").trim();
      th = parts.slice(1).join(":").trim();
    }

    const hhmm = found?.tsISO ? isoToHHMM(found.tsISO) : "";

    return `
      <div class="stampRow">
        <div class="stampLeft">
          <div class="stampEn" title="${escapeHtml(rawLabel)}">${escapeHtml(en || rawLabel)}</div>
          ${th ? `<div class="stampTh">${escapeHtml(th)}</div>` : ``}
        </div>

        <div class="stampActions">
          <button class="btn ${found ? "light":"secondary"} tiny"
            ${disabled ? "disabled style='opacity:0.5;cursor:not-allowed;'" : ""}
            onclick="stampStep('${jsStr(m.id)}','${jsStr(step.key)}')">${btnLabel}</button>

          ${found ? `<div class="stampBtnTime">${escapeHtml(hhmm || "")}</div>` : ``}
        </div>
      </div>
    `;
  }).join("");

  document.getElementById("stampGrid").innerHTML = rows || `<div class="muted">No steps.</div>`;
}

/* =======================
   CORE LOGIC (STAMP)
======================= */
function stampStep(missionId, stepKey){
  const by = String(document.getElementById("stampBy").value || "").trim();
  const note = String(document.getElementById("stampNote").value || "").trim();
  if (!by){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô (‡∏ú‡∏π‡πâ‡∏Å‡∏î stamp)"); return; }

  const m = getMissionById(missionId);
  if (!m) return;

  const mm = ensureOperationStamp(m);
  const op = mm.details.OperationStamp;

  if (!op.startedBy) op.startedBy = by;

  if (op.status === "Completed"){
    alert("‡πÄ‡∏Ñ‡∏™‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å Completed ‡πÅ‡∏•‡πâ‡∏ß");
    return;
  }

  const pat = patternForTypeKey(mm.typeKey);
  const stepMeta = pat.steps.find(s => String(s.key) === String(stepKey));
  if (!stepMeta) return;

  if (stepAlreadyStamped(op, stepKey)){
    alert("Step ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å stamp ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß");
    return;
  }

  op.steps.push({
    key: stepMeta.key,
    label: stepMeta.label,
    tsISO: nowISO(),
    note: note || "",
    by,
    source: "OP",
    deviceId: DEVICE_ID
  });
  op.lastUpdatedAt = nowISO();

  if (String(stepMeta.key) === "actual_departure"){
    setStatus(mm, "Transporting", { by, source:"stamp", note:"actual_departure" });
  }

  if (shouldBeReturning(mm, stepMeta.key) && normStatus(mm.status) !== "Completed"){
    setStatus(mm, "Returning", { by, source:"stamp", note:`return_rule:${stepMeta.key}` });
  }

  if (hasAllStepsStamped(mm)){
    setStatus(mm, "Completed", { by, source:"stamp", note:"all_steps_stamped" });
    op.status = "Completed";
    op.lastUpdatedAt = nowISO();
  } else {
    op.status = "Active";
  }

  upsertMission(mm);

  renderStampGrid(mm);
  updateStampFooter(mm);

  refreshOpenDetailsIfAny();
  render();
}

/* =======================
   Clear stamps
======================= */
document.getElementById("clearStampsBtn")?.addEventListener("click", () => {
  if (!stampMissionId) return;
  if (!confirm("Clear stamps ‡∏Ç‡∏≠‡∏á mission ‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?")) return;

  const m = getMissionById(stampMissionId);
  if (!m) return;

  if (m.details && m.details.OperationStamp){
    delete m.details.OperationStamp;
  }

  upsertMission(m);

  const mm = ensureOperationStamp(m);
  upsertMission(mm);

  renderStampGrid(mm);
  updateStampFooter(mm);

  refreshOpenDetailsIfAny();
  render();
});

/* =======================
   Mark Completed button
======================= */
document.getElementById("markCompletedBtn")?.addEventListener("click", () => {
  if (!stampMissionId) return;

  const by = String(document.getElementById("stampBy")?.value || "").trim();
  if (!by){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô (‡∏ú‡∏π‡πâ‡∏Å‡∏î stamp)"); return; }

  const m = getMissionById(stampMissionId);
  if (!m) return;

  const mm = ensureOperationStamp(m);
  const op = mm.details.OperationStamp;

  if (!op.startedBy) op.startedBy = by;

  if (!hasAllStepsStamped(mm)){
    alert("‡∏¢‡∏±‡∏á stamp ‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á ‚Äî ‡∏ï‡πâ‡∏≠‡∏á stamp ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å step ‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡∏à‡∏∞ Completed ‡πÑ‡∏î‡πâ");
    return;
  }

  op.status = "Completed";
  op.lastUpdatedAt = nowISO();
  op.lastUpdatedBy = by;

  setStatus(mm, "Completed", { by, source:"mark_completed", note:"manual_button" });

  upsertMission(mm);

  closeStamp();
  refreshOpenDetailsIfAny();
  render();
});

/* =======================
   Save & Exit button
======================= */
document.getElementById("saveExitBtn")?.addEventListener("click", () => {
  if (!stampMissionId) return;

  const by = String(document.getElementById("stampBy")?.value || "").trim();
  if (!by){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô (‡∏ú‡∏π‡πâ‡∏Å‡∏î stamp)"); return; }

  const m = getMissionById(stampMissionId);
  if (!m) return;

  const mm = ensureOperationStamp(m);
  const op = mm.details.OperationStamp;

  if (!op.startedBy) op.startedBy = by;

  op.lastUpdatedAt = nowISO();
  op.lastUpdatedBy = by;
  if (op.status !== "Completed") op.status = "Active";

  upsertMission(mm);

  closeStamp();
  refreshOpenDetailsIfAny();
  render();
});

/* =======================
   Keyboard shortcuts
======================= */
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape"){
    if (document.getElementById("stampOverlay")?.style.display === "flex"){
      closeStamp();
    } else if (document.getElementById("modalOverlay")?.style.display === "flex"){
      closeModal();
    }
  }
});

/* =======================
   INIT
======================= */
(function init(){
  const clockEl = document.getElementById("clock");
  function tick(){
    const d = new Date();
    if (clockEl) clockEl.textContent = `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
  }
  tick();
  setInterval(tick, 500);

  document.getElementById("refreshBtn")?.addEventListener("click", render);
  document.getElementById("search")?.addEventListener("input", render);
  document.getElementById("statusFilter")?.addEventListener("change", render);
  document.getElementById("dateFilter")?.addEventListener("change", render);

  render();
})();
</script>

</body>
</html>