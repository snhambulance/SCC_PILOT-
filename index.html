<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Samitivej Communication Center</title>

<style>
  body{
    margin:0;
    background:#f4f6f8;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    text-align:center;
  }

  .topbar{
    background:white;
    box-shadow:0 4px 18px rgba(0,0,0,0.18);
    display:flex;
    align-items:center;
    gap:12px;
    padding:8px 14px;
  }

  .header{
    flex:0 0 auto;
    display:flex;
    align-items:center;
    justify-content:flex-start;
  }
  .header img{
    width:auto;
    height:70px;
    object-fit:contain;
    display:block;
  }

  .stats{
    display:flex;
    justify-content:flex-end;
    flex-wrap:wrap;
    gap:10px;
    margin-left:auto;
  }
  .stat{
    background:white;
    border-radius:12px;
    box-shadow:0 2px 8px rgba(0,0,0,0.12);
    padding:8px 14px;
    min-width:120px;
    text-align:center;
  }

  /* ===== Total (Year) = same size/typography as other stats, only soft grey bg ===== */
  .stat-year{
    background:#f3f4f6;
    box-shadow:0 2px 8px rgba(0,0,0,0.12);
  }
  .stat-year span{ color:#006d5b; }
  .stat-year label{ color:#555; }

  .stat span{
    display:block;
    font-size:24px;
    font-weight:900;
    color:#006d5b;
    line-height:1.05;
  }
  .stat label{
    font-size:12px;
    color:#555;
  }
.pageHeader{
  text-align:center;
  margin-bottom:16px;
}

.pageHeader h1{
  margin:10px 0 8px;
}

#clock{
  font-size:44px;
  font-weight:900;
}

  .content{
  padding:18px 16px 34px;
  max-width:1620px;
  margin:0 auto;
  text-align:left;
}


  h1{
    font-size:28px;
    font-weight:800;
    margin:10px 0 6px;
  }
  #clock{
    font-size:54px;
    font-weight:900;
    margin:10px 0 18px;
  }

  .actionbar{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    justify-content:space-between;
    margin:10px 0 14px;
  }
  .btn{
    appearance:none;
    border:0;
    border-radius:12px;
    padding:10px 14px;
    font-weight:800;
    cursor:pointer;
    background:#0b6b5b;
    color:white;
    box-shadow:0 3px 10px rgba(0,0,0,0.12);
  }
  .btn.secondary{ background:#111827; }
  .btn.danger{ background:#b42318; }
  .btn.light{
    background:#e5e7eb;
    color:#111827;
    box-shadow:none;
    font-weight:900;
  }
  .btn.tiny{
    padding:7px 10px;
    border-radius:10px;
    font-weight:900;
    font-size:12px;
    box-shadow:none;
  }

  .card{
    background:#fff;
    border-radius:18px;
    box-shadow:0 4px 12px rgba(0,0,0,0.12);
    padding:16px;
    text-align:left;
    margin-bottom:14px;
  }
  .cardHeader{
    display:flex;
    gap:12px;
    flex-wrap:wrap;
    align-items:center;
    justify-content:space-between;
    margin-bottom:12px;
  }
  .cardTitle{
    font-size:18px;
    font-weight:800;
    color:#1f2937;
    margin:0;
  }
  .controls{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    justify-content:flex-end;
  }
  .input, .select{
    border:1px solid #e5e7eb;
    border-radius:12px;
    padding:10px 12px;
    font-size:14px;
    outline:none;
    background:#fff;
  }

  .tableWrap{
    overflow-x:hidden;
    overflow-y:auto;
    border-radius:14px;
    border:1px solid #eef2f7;
  }
  table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  min-width:0;                /* ✅ เอา 1620px ออก ไม่งั้นยังไงก็ล้น */
  table-layout:fixed;         /* ✅ บังคับให้คอลัมน์หดตามจอ */
  font-size:14px;
}

  thead th{
  position:sticky;
  top:0;
  background:#f8fafc;
  color:#374151;
  text-align:left;
  padding:12px 12px;
  border-bottom:1px solid #e5e7eb;
  z-index:1;
  white-space:nowrap;         /* header ไม่แตกบรรทัด */
  overflow:hidden;
  text-overflow:ellipsis;
}

  tbody td{
  padding:12px 12px;
  border-bottom:1px solid #f0f2f5;
  color:#111827;
  vertical-align:top;
  overflow:hidden;
  text-overflow:ellipsis;
}

  tbody tr:hover{ background:#fafcff; }
  .muted{ color:#6b7280; }

  .badge{
    display:inline-block;
    padding:6px 10px;
    border-radius:999px;
    font-weight:800;
    font-size:12px;
    border:1px solid transparent;
    white-space:nowrap;
  }
  /* Scheduled = ม่วง */
.b-scheduled{ background:#f3e8ff; color:#6b21a8; border-color:#d8b4fe; }
/* Preparing = ฟ้า */
.b-preparing{ background:#e0f2fe; color:#075985; border-color:#bae6fd; }
/* Delayed = แดง */
.b-delayed{ background:#fee2e2; color:#991b1b; border-color:#fecaca; }
/* Transporting = เขียว */
.b-transporting{ background:#dcfce7; color:#166534; border-color:#86efac; }
/* Returning = ส้ม */
.b-returning{ background:#ffedd5; color:#9a3412; border-color:#fed7aa; }
/* Completed = เทาอ่อน */
.b-completed{ background:#f1f5f9; color:#334155; border-color:#d7dee8; }
/* Cancelled = เทาเข้ม */
.b-cancelled{ background:#e5e7eb; color:#111827; border-color:#9ca3af; }
/* Pending / Unknown */
.b-pending{ background:#f3f4f6; color:#374151; border-color:#e5e7eb; }
/* Activated = เขียวอมฟ้า (teal) */
.b-activated{ background:#dbeafe; color:#1e40af; border-color:#93c5fd;}

 /* ===== Status Icons ===== */
.statusCell{
  display:flex;
  align-items:center;
  gap:6px;
}
.statusIcons{
  display:inline-flex;
  align-items:center;
  gap:4px;
}
.statusIcons svg{
  width:22px !important;
  height:22px !important;
  stroke-width:2.4;
  color:currentColor;
}
  .tinyNote{
    font-size:12px;
    color:#6b7280;
    margin:10px 2px 0;
  }

  .strike{
    text-decoration:line-through;
    color:#6b7280;
    font-weight:900;
    margin-right:8px;
    display:inline-block;
  }
  .newTime{
    font-weight:900;
    color:#111827;
    display:inline-block;
  }
  .depCell{
    display:flex;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
  }
  .depWrap{
    display:inline-flex;
    align-items:center;
    gap:8px;
    flex-wrap:wrap;
  }

  /* ===== MODAL ===== */
  .modalOverlay{
    position:fixed;
    inset:0;
    background:rgba(17,24,39,0.55);
    display:none;
    align-items:center;
    justify-content:center;
    padding:18px;
    z-index:9999;
  }
  .modal{
    width:min(980px, 100%);
    background:white;
    border-radius:18px;
    box-shadow:0 18px 50px rgba(0,0,0,0.28);
    overflow:hidden;
    text-align:left;
  }
  .modalHeader{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:12px;
    padding:14px 16px;
    background:#f8fafc;
    border-bottom:1px solid #e5e7eb;
  }
  .modalTitle{
    margin:0;
    font-size:18px;
    font-weight:900;
    color:#111827;
  }
  .modalSub{
    margin:4px 0 0;
    font-size:12px;
    color:#6b7280;
  }
  .modalBody{
    padding:16px;
    max-height:70vh;
    overflow:auto;
  }
  .section{
    border:1px solid #eef2f7;
    border-radius:14px;
    padding:12px;
    margin-bottom:12px;
    background:#fff;
  }
  .section h3{
    margin:0 0 8px;
    font-size:14px;
    font-weight:900;
    color:#111827;
  }
  .kv{
    display:grid;
    grid-template-columns: 220px 1fr;
    gap:8px 12px;
    font-size:13px;
  }
  .k{ color:#374151; font-weight:800; }
  .v{ color:#111827; }

  .modalFooter{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding:12px 16px;
    border-top:1px solid #e5e7eb;
    background:#fff;
    flex-wrap:wrap;
  }
  .footerLeft{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    justify-content:flex-start;
  }
  .footerRight{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    justify-content:flex-end;
    margin-left:auto;
  }
  .editedPill{
    display:inline-block;
    padding:3px 8px;
    border-radius:999px;
    background:#fff7ed;
    border:1px solid #fed7aa;
    color:#9a3412;
    font-weight:900;
    font-size:11px;
    line-height:1;
  }

  /* ===== EDIT DEPARTURE MODAL ===== */
  .editOverlay{
    position:fixed;
    inset:0;
    background:rgba(17,24,39,0.55);
    display:none;
    align-items:center;
    justify-content:center;
    padding:18px;
    z-index:10000;
  }
  .editModal{
    width:min(560px, 100%);
    background:white;
    border-radius:18px;
    box-shadow:0 18px 50px rgba(0,0,0,0.28);
    overflow:hidden;
    text-align:left;
  }
  .editHeader{
    padding:14px 16px;
    background:#f8fafc;
    border-bottom:1px solid #e5e7eb;
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:12px;
  }
  .editTitle{
    margin:0;
    font-size:16px;
    font-weight:900;
    color:#111827;
  }
  .editBody{
    padding:16px;
  }
  .editGrid{
    display:grid;
    grid-template-columns:1fr;
    gap:12px;
  }
  .field{
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .field label{
    font-size:13px;
    font-weight:900;
    color:#374151;
  }
  .field input{
    border:1px solid #e5e7eb;
    border-radius:12px;
    padding:10px 12px;
    font-size:14px;
    outline:none;
    background:#fff;
  }
  .editHint{
    font-size:12px;
    color:#6b7280;
    margin-top:8px;
  }

  @media (max-width: 900px){
    .topbar{ flex-wrap:wrap; }
    .stats{ width:100%; justify-content:center; margin-left:0; }
    .header img{ height:62px; }
    #clock{ font-size:44px; }
    .kv{ grid-template-columns: 1fr; }
  }

  /* ===== CANCEL MODAL (like operation_line) ===== */
  .cancelOverlay{
    position:fixed;
    inset:0;
    background:rgba(17,24,39,0.55);
    display:none;
    align-items:center;
    justify-content:center;
    padding:18px;
    z-index:10001;
  }
  .cancelModal{
    width:min(560px, 100%);
    background:white;
    border-radius:18px;
    box-shadow:0 18px 50px rgba(0,0,0,0.28);
    overflow:hidden;
    text-align:left;
  }
  .cancelHeader{
    padding:14px 16px;
    background:#f8fafc;
    border-bottom:1px solid #e5e7eb;
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:12px;
  }
  .cancelTitle{
    margin:0;
    font-size:16px;
    font-weight:900;
    color:#111827;
  }
  .cancelBody{
    padding:16px;
  }
  .radioList{
    display:grid;
    gap:10px;
    margin-top:8px;
  }
  .radioItem{
    border:1px solid #e5e7eb;
    border-radius:14px;
    padding:12px;
    display:flex;
    gap:10px;
    align-items:flex-start;
    cursor:pointer;
    background:#fff;
  }
  .radioItem:hover{ background:#fafcff; }
  .radioItem input{ margin-top:3px; }
  .radioMain{
    font-weight:900;
    color:#111827;
    line-height:1.2;
  }
  .radioSub{
    font-size:12px;
    color:#6b7280;
    margin-top:4px;
    line-height:1.25;
  }
  .cancelActions{
    padding:14px 16px;
    border-top:1px solid #e5e7eb;
    display:flex;
    gap:10px;
    justify-content:flex-end;
    flex-wrap:wrap;
    background:#fff;
  }

/* ===== Status Icons (color driven by CSS) ===== */
.statusIcons svg{
  width:22px !important;
  height:22px !important;
  stroke-width:2.4;
  color:currentColor; /* optional */
}

/* สีของ icon แต่ละสถานะ */
.statusIcons.preparing{ color:#075985; }     /* ฟ้า */
.statusIcons.delayed{ color:#991b1b; }       /* แดง */
.statusIcons.transporting{ color:#166534; }  /* เขียว */
.statusIcons.returning{ color:#9a3412; }     /* ส้ม */

/* ===== clamp helpers ===== */
.clamp1{
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.clamp2{
  white-space:normal;
  line-height:1.25;
  display:-webkit-box;
  -webkit-box-orient:vertical;
  -webkit-line-clamp:2;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* ✅ allow wrapping in these columns (2 lines) */
td.col-type,
td.col-from,
td.col-to{
  white-space: normal !important;
  line-height: 1.25;
}


/* ✅ Apply only where needed */
td.col-type{ white-space:normal !important; }  /* allow clamp2 inside */


/* +1 tag (look-ahead) — same feel as operation.html */
.tinyTag{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:2px 8px;
  border-radius:999px;
  font-weight:900;
  font-size:11px;
  line-height:1;
  background:#e0f2fe;   /* ฟ้าอ่อน */
  color:#075985;        /* ฟ้าเข้ม */
  border:1px solid #bae6fd;
  vertical-align:middle;
}


</style>
</head>

<body>

<div class="topbar">
  <div class="header">
    <img src="header-logo.png" alt="Header Logo">
  </div>

  <div class="stats statsgrid">
    <div class="stat stat-year"><span id="total">-</span><label>Total (Year)</label></div>
    <div class="stat"><span id="todayTotal">-</span><label>Total (Today)</label></div>
    <div class="stat"><span id="activeToday">-</span><label>Active</label></div>
    <div class="stat"><span id="remainingScheduled">-</span><label>Remaining Scheduled</label></div>
    <div class="stat"><span id="completedN">-</span><label>Completed</label></div>
    <div class="stat"><span id="cancelledN">-</span><label>Cancelled</label></div>
  </div>
</div>

<div class="content">
  <div class="pageHeader">
    <h1>Samitivej Communication Center</h1>
    <div id="clock">--:--:--</div>
  </div>


  <div class="actionbar">
    <div class="muted">Data source:(form.html)</div>
    <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
      <button class="btn" onclick="location.href='form.html'">+ Add Mission</button>
      <button class="btn secondary" id="exportMonthBtn">Export CSV (This Month)</button>
      <button class="btn secondary" id="exportYearBtn">Export CSV (This Year)</button>

    </div>
  </div>

  <!-- ✅ TABLE 1: Today Missions -->
  <div class="card">
    <div class="cardHeader">
      <h2 class="cardTitle" id="tableTitle">Today Missions</h2>

      <div class="controls">
        <input id="search" class="input" placeholder="Search: Mission No. / HN / type / from / to / notes">
        <select id="statusFilter" class="select">
          <option value="ALL">All status</option>
          <option value="Activated">Activated</option>
          <option value="Scheduled">Scheduled</option>
          <option value="Preparing">Preparing</option>
          <option value="Delayed">Delayed</option>
          <option value="Transporting">Transporting</option>
          <option value="Completed">Completed</option>
          <option value="Cancelled">Cancelled</option>
          <option value="Pending">Pending</option>
        </select>
        <input id="dateFilter" class="input" type="date">
      </div>
    </div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th style="width:140px;">CODE</th>
            <th style="width:110px;">Date</th>
            <th style="width:110px;">Departure</th>
            <th style="width:260px; white-space: normal; word-break: break-word;">
  Mission Type
</th>
            <th>From</th>
            <th>To</th>
            <th style="width:150px;">Status</th>
            <th style="width:120px;">Details</th>
          </tr>
        </thead>
        <tbody id="missionBody">
          <tr><td colspan="8" class="muted">No data yet. Click “Add Mission”.</td></tr>
        </tbody>
      </table>
    </div>

    <div class="tinyNote" id="countNote"></div>
  </div>

  <!-- ✅ TABLE 2: Active Follow-Up Missions -->
  <div class="card">
    <div class="cardHeader">
      <h2 class="cardTitle" id="followTitle">Active Follow-Up Missions</h2>
      <div class="muted" style="font-size:12px;">
        Activated/Delayed/Overdue (moved from previous days), excluding Cancelled/Completed/Aborted
      </div>
    </div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th style="width:80px;">CODE</th>
            <th style="width:100px;">Request Date</th>
            <th style="width:140px;">Scheduled (if any)</th>
            <th style="width:260px;">Mission Type</th>
            <th>From</th>
            <th>To</th>
            <th style="width:150px;">Status</th>
            <th style="width:220px;">Action</th>
          </tr>
        </thead>
        <tbody id="followBody">
          <tr><td colspan="8" class="muted">No follow-up missions.</td></tr>
        </tbody>
      </table>
    </div>

    <div class="tinyNote" id="followCountNote"></div>
  </div>
</div>

<!-- DETAILS MODAL -->
<div class="modalOverlay" id="modalOverlay" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="modalHeader">
      <div>
        <h2 class="modalTitle" id="modalTitle">Mission Details</h2>
        <div class="modalSub" id="modalSub"></div>
      </div>
    </div>

    <div class="modalBody" id="modalBody"></div>

    <div class="modalFooter">
  <div class="footerLeft">
    <button class="btn secondary" id="editTimeBtn">Edit Departure Time</button>
    <button class="btn secondary" id="editBtn">Edit in Form</button>

    <!-- ✅ NEW: Cancel button (opens same cancel dialog as follow-up) -->
    <button class="btn" id="cancelBtn">Cancel</button>

    <button class="btn danger" id="deleteBtn">Delete</button>
  </div>

  <div class="footerRight">
    <button class="btn light" id="closeModalBtn">Close</button>
  </div>
</div>
  </div>
</div>

<!-- EDIT DEPARTURE MODAL -->
<div class="editOverlay" id="editOverlay" role="dialog" aria-modal="true">
  <div class="editModal">
    <div class="editHeader">
      <div>
        <h3 class="editTitle" id="editTitle">Edit Departure Time</h3>
        <div class="modalSub" id="editSub"></div>
      </div>
      <button class="btn light tiny" id="closeEditBtn">Close</button>
    </div>
    <div class="editBody">
      <div class="editGrid">
        <div class="field">
          <label>New Departure Time (HH:MM) *</label>
          <input id="newDeparture" type="time" required>
        </div>
        <div class="field">
          <label>Received update from (รับแจ้งจากใคร) *</label>
          <input id="reportedBy" type="text" placeholder="e.g., Nurse PICU A / Dr. B / Call center คุณซี" required>
        </div>
      </div>
      <div class="editHint">
        * แก้ได้เฉพาะ status: Scheduled / Preparing / Delayed<br>
        * ถ้าข้อมูลอื่นผิด แนะนำ Cancel แล้ว Add new mission
      </div>
      <div class="modalActions" style="padding:14px 0 0; border-top:0; display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;">
        <button class="btn light" id="cancelEditBtn">Cancel</button>
        <button class="btn" id="saveEditBtn">Save</button>
      </div>
    </div>
  </div>
</div>



<!-- CANCEL MODAL (Follow-up Cancel) -->
<div class="cancelOverlay" id="cancelOverlay" role="dialog" aria-modal="true">
  <div class="cancelModal">
    <div class="cancelHeader">
      <div>
        <h3 class="cancelTitle" id="cancelTitle">Cancel Mission</h3>
        <div class="modalSub" id="cancelSub"></div>
      </div>
      <button class="btn light tiny" id="closeCancelBtn">Close</button>
    </div>

    <div class="cancelBody">
  <div class="field" style="gap:8px;">

    <!-- ✅ ADD: Cancelled by -->
    <div class="field" style="gap:8px; margin-bottom:10px;">
      <label style="font-size:13px;font-weight:900;color:#374151;">Cancelled by (ชื่อผู้แจ้ง) *</label>
      <input id="cancelBy" type="text" placeholder="e.g., Nurse A / Dr. B / CC คุณซี" required>
    </div>

    <!-- ✅ EXISTING: Cancel reason -->
    <label style="font-size:13px;font-weight:900;color:#374151;">Cancel reason *</label>

    <div class="radioList" id="cancelRadioList">
      <label class="radioItem">
        <input type="radio" name="cancelReason" value="MISSED" />
        <div>
          <div class="radioMain">Missed mission</div>
          <div class="radioSub">ยกเลิกก่อนออกเดินทาง</div>
        </div>
      </label> 
        

          <label class="radioItem">
            <input type="radio" name="cancelReason" value="ABORTED" />
            <div>
              <div class="radioMain">Aborted mission</div>
              <div class="radioSub">ออกเดินทางแล้ว และถูกยกเลิก</div>
            </div>
          </label>

          <label class="radioItem">
            <input type="radio" name="cancelReason" value="INCORRECT" />
            <div>
              <div class="radioMain">Incorrect information</div>
              <div class="radioSub">ข้อมูลผิดพลาด</div>
            </div>
          </label>
        </div>

        <div class="editHint" style="margin-top:10px;">
          * เลือก 1 ตัวเลือก แล้วกด Confirm<br>
          * ไม่ว่าเลือกเหตุผลอะไร ระบบจะตั้งสถานะเป็น Cancelled ของวันนั้น
        </div>
      </div>
    </div>

    <div class="cancelActions">
  <button class="btn light" id="cancelCancelBtn">Close</button>
  <button class="btn danger" id="confirmCancelBtn">Confirm Cancellation</button>
</div>
  </div>
</div>

<!-- RESCHEDULE MODAL (Follow-up Reschedule) -->
<div class="editOverlay" id="reschedOverlay" role="dialog" aria-modal="true">
  <div class="editModal">
    <div class="editHeader">
      <div>
        <h3 class="editTitle" id="reschedTitle">Reschedule Mission</h3>
        <div class="modalSub" id="reschedSub"></div>
      </div>
      <button class="btn light tiny" id="closeReschedBtn">Close</button>
    </div>

    <div class="editBody">
      <div class="editGrid">
        <div class="field">
  <label>Rescheduled by (ชื่อผู้แจ้ง) *</label>
  <input id="reschedBy" type="text" placeholder="e.g., Nurse A / Dr. B / CC คุณซี" required>
</div>
        
        <div class="field">
          <label>Date (YYYY-MM-DD) *</label>
          <input id="reschedDate" type="date" required>
        </div>

        <div class="field">
          <label>Departure Time (HH:MM) *</label>
          <input id="reschedTime" type="time" required>
        </div>

        <div class="editHint">
          This action will:<br>
          • Change status to <strong>Scheduled</strong><br>
          • Move mission to <strong>Today Missions</strong><br>
          • Auto-update to <strong>Preparing</strong> if within 30 minutes (per Today rule)
        </div>

        <div style="display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;">
          <button class="btn light" id="cancelReschedBtn">Cancel</button>
          <button class="btn" id="confirmReschedBtn">Reschedule to Today</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================================================
   GLOBAL DATA SOURCE FLAGS (Option B ready)
========================================================= */
window.DATA_SOURCE = "firestore";
window.FIRESTORE_MISSIONS = Array.isArray(window.FIRESTORE_MISSIONS) ? window.FIRESTORE_MISSIONS : [];

/* =========================================================
   SHOW JS ERRORS ON SCREEN
========================================================= */
(function(){
  function showErr(msg){
    let box = document.getElementById("__errbox");
    if (!box){
      box = document.createElement("div");
      box.id="__errbox";
      box.style.cssText =
        "position:fixed;left:10px;right:10px;bottom:10px;z-index:999999;" +
        "background:#111827;color:#fff;padding:10px 12px;border-radius:12px;" +
        "font:12px/1.3 system-ui;box-shadow:0 10px 30px rgba(0,0,0,.35);" +
        "max-height:35vh;overflow:auto;text-align:left;white-space:pre-wrap;";
      document.body.appendChild(box);
    }
    box.textContent = msg + "\n\n" + box.textContent;
  }
  window.addEventListener("error", (e)=> showErr(
    "JS Error: " + (e?.message||e) + "\n@ " + (e?.filename||"") + ":" + (e?.lineno||"") + ":" + (e?.colno||"")
  ));
  window.addEventListener("unhandledrejection", (e)=> showErr(
    "Promise Rejection: " + (e?.reason?.message || e?.reason || e)
  ));
})();

/* =========================================================
   BASIC TIME HELPERS (กันพังจาก nowISO/clock)
========================================================= */
function nowISO(){ return new Date().toISOString(); }
function pad2(n){ return String(n).padStart(2,"0"); }
function toISODateLocal(d){
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
}
function getTodayISO(){ return toISODateLocal(new Date()); }

/* =========================================================
   ✅ GOOGLE SHEET WEBAPP (LOG SENDER) — FINAL (ANTI-DUP)
   - ปลอดภัยขึ้น: ไม่มีการเรียก render ตรง ๆ แบบไม่เช็ค
   - ไม่มี clock undefined
========================================================= */
const STORAGE_KEY      = "SCC_MISSIONS_V1";
const SHEET_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzav0HGGsblLPw46w2fnjSnjOLAymJP9xnTQAD_xgexiGbI5NFDmEfEG2V0WUL6dk-tAw/exec";
const LOG_QUEUE_KEY    = "__SCC_LOG_QUEUE__";
const SENT_KEY         = "__SCC_SENT_EVENT_IDS__"; // ✅ กันซ้ำฝั่ง client

// ====== event id ======
function makeEventId_(){
  return "EVT-" + Date.now() + "-" + Math.random().toString(16).slice(2);
}
function ensureEventId_(eventObj){
  if (!eventObj) return "";
  if (!eventObj.eventId) eventObj.eventId = makeEventId_();
  return eventObj.eventId;
}

// ====== device id ======
function getDeviceId(){
  const k = "__SCC_DEVICE_ID__";
  let id = localStorage.getItem(k);
  if (!id){
    id = "DEV-" + Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);
    localStorage.setItem(k, id);
  }
  return id;
}

// ====== base payload ======
function buildLogBase(m){
  return {
    eventAtISO: nowISO(),
    deviceId: getDeviceId(),
    mission: m
  };
}

// ====== sent cache (with prune) ======
const SENT_TTL_MS = 7 * 24 * 60 * 60 * 1000; // 7 วัน
const SENT_MAX    = 2000;

function readSentMap_(){
  try{ return JSON.parse(localStorage.getItem(SENT_KEY) || "{}"); }
  catch(_){ return {}; }
}
function writeSentMap_(map){
  try{ localStorage.setItem(SENT_KEY, JSON.stringify(map)); }catch(_){}
}
function pruneSent_(map){
  const now = Date.now();
  for (const [eid, ts] of Object.entries(map)){
    if (!ts || (now - ts) > SENT_TTL_MS) delete map[eid];
  }
  const entries = Object.entries(map);
  if (entries.length > SENT_MAX){
    entries.sort((a,b)=> (a[1]||0) - (b[1]||0));
    const toDel = entries.length - SENT_MAX;
    for (let i=0;i<toDel;i++) delete map[entries[i][0]];
  }
  return map;
}
function markSent_(eventId){
  if (!eventId) return;
  const map = pruneSent_(readSentMap_());
  map[eventId] = Date.now();
  writeSentMap_(map);
}
function isSent_(eventId){
  if (!eventId) return false;
  const map = pruneSent_(readSentMap_());
  writeSentMap_(map);
  return !!map[eventId];
}

// ====== queue ======
function readQueue_(){
  try{ return JSON.parse(localStorage.getItem(LOG_QUEUE_KEY) || "[]"); }
  catch(_){ return []; }
}
function writeQueue_(q){
  try{ localStorage.setItem(LOG_QUEUE_KEY, JSON.stringify(q)); }catch(_){}
}

function queueLog_(eventObj){
  ensureEventId_(eventObj);
  const eid = eventObj?.eventId || "";
  const q = readQueue_();

  if (eid && isSent_(eid)) return;
  if (eid && q.some(x => x?.eventObj?.eventId === eid)) return;

  q.push({ t: Date.now(), eventObj });
  writeQueue_(q);
}

// ====== push ======
async function pushLogToSheet(eventObj, opts = {}){
  ensureEventId_(eventObj);
  const { skipQueue = false } = opts;
  const eid = eventObj?.eventId || "";

  if (eid && isSent_(eid)) return { ok:true, skipped:true };

  const form = new URLSearchParams();
  form.set("payload", JSON.stringify(eventObj));

  const maxTry = 2;

  for (let attempt=1; attempt<=maxTry; attempt++){
    const controller = new AbortController();
    const timeoutMs = 8000;
    const timer = setTimeout(()=> controller.abort(), timeoutMs);

    try{
      const res = await fetch(SHEET_WEBAPP_URL, {
        method: "POST",
        mode: "cors",
        headers: { "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" },
        body: form.toString(),
        signal: controller.signal
      });
      clearTimeout(timer);

      const txt = await res.text();
      let data = null;
      try{ data = JSON.parse(txt); }catch(_){}

      if (!res.ok) throw new Error(`HTTP_${res.status}: ${txt}`);
      if (data && data.ok === false) throw new Error(`WEBAPP_ERROR: ${data.error || txt}`);

      if (eid) markSent_(eid);
      return data || { ok:true };

    }catch(err){
      clearTimeout(timer);

      if (attempt === maxTry){
        // fallback no-cors
        try{
          await fetch(SHEET_WEBAPP_URL, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" },
            body: form.toString()
          });
          if (eid) markSent_(eid);
          return { ok:true, fallback:"no-cors" };
        }catch(_fallbackErr){
          if (!skipQueue){
            if (!(eid && isSent_(eid))) queueLog_(eventObj);
          }
          throw err;
        }
      }

      await new Promise(r => setTimeout(r, 400));
    }
  }
}

// ====== flush queue ======
async function flushLogQueue_(){
  const q = readQueue_();
  if (!q.length) return;

  const keep = [];
  for (const item of q){
    const ev = item?.eventObj;
    ensureEventId_(ev);
    const eid = ev?.eventId || "";

    if (eid && isSent_(eid)) continue;

    try{
      await pushLogToSheet(ev, { skipQueue: true });
    }catch(_){
      keep.push(item);
    }
  }
  writeQueue_(keep);
}

// ====== auto flush triggers ======
window.addEventListener("online", flushLogQueue_);
window.addEventListener("focus", flushLogQueue_);
setInterval(flushLogQueue_, 60 * 1000);

// ✅ prune sent cache เป็นระยะ
setInterval(()=>{ writeSentMap_(pruneSent_(readSentMap_())); }, 10 * 60 * 1000);

/* =========================================================
   SAFE CLOCK + SAFE RENDER LOOP (กัน undefined)
========================================================= */
function __tickClockSafe(){
  const el = document.getElementById("clock");
  if (!el) return;
  el.innerText = new Date().toLocaleTimeString("th-TH");
}
setInterval(__tickClockSafe, 1000);
__tickClockSafe();

// ✅ สำคัญ: อย่าเรียก render ตรง ๆ ถ้าในไฟล์คุณใช้ safeRender เป็นหลัก
function __safeRenderCall(){
  try{
    if (typeof safeRender === "function") safeRender();
    else if (typeof render === "function") render();
  }catch(e){
    console.error(e);
  }
}
setInterval(__safeRenderCall, 60 * 1000);
window.addEventListener("focus", __safeRenderCall);

/* =======================
   ✅ UI Mission Type Label (FULL label like form.html)
   - DO NOT change stored values
======================= */
const TYPE_DISPLAY_LABELS = {
  "EMS_BASIC": "Basic EMS",
  "EMS_ADV":   "Advance EMS",
  "IFT_BASIC_IN":  "Basic IFT – Refer In",
  "IFT_ADV_IN":    "Advance IFT – Refer In",
  "IFT_BASIC_OUT": "Basic IFT – Refer Out",
  "IFT_ADV_OUT":   "Advance IFT – Refer Out",
  "AP_CLINIC_IFT": "Airport Clinic IFT (รับผู้ป่วยจากคลินิกสนามบิน)",
  "AP_ESCORT_IN":  "Airport escort and transport (รับ-คนไข้นอกเครื่อง)",
  "AP_ESCORT_OUT": "Airport escort and transport (ส่ง-คนไข้นอกเครื่อง)",
  "TARMAC_IN":     "TARMAC : Airport escort and transport (รับ-คนไข้ข้างเครื่อง)",
  "TARMAC_OUT":    "TARMAC : Airport escort and transport (ส่ง-คนไข้ข้างเครื่อง)",
  "PROC_SEND_WAIT_PICK": "Transport for procedural appointment (ส่งและรอรับ-คนไข้ไปทำหัตถการ)",
  "PROC_SEND":           "Transport procedural appointment (ส่ง-คนไข้ไปทำหัตถการ)",
  "PROC_PICK":           "Transport procedural appointment (รับ-คนไข้จากการไปทำหัตถการ)",
  "HOME_PICKUP": "Home pickup (รับ-คนไข้จากบ้าน)",
  "HOME_DISCH":  "Discharge home (ส่ง-คนไข้กลับบ้าน)",
  "HHC_PICKUP": "6.1 Home Health Care (รับ-คนไข้จากบ้าน)",
  "HHC_SEND":   "6.2 Home Health Care (ส่ง-คนไข้กลับบ้าน)",
  "OTHER": "7. Other (เขียนหมายเหตุเพิ่มได้)"
};

function getTypeLabelForTable(m){
  const k = String(m?.typeKey || "").trim();
  return TYPE_DISPLAY_LABELS[k] || (m?.type || m?.typeDisplay || "-");
}

/* =======================
   REALTIME SYNC (Index <-> Operation)
======================= */
const SYNC_CHANNEL_NAME = "SCC_SYNC_V1";
let syncChannel = null;

function getSyncChannel(){
  try{
    if (!syncChannel && "BroadcastChannel" in window){
      syncChannel = new BroadcastChannel(SYNC_CHANNEL_NAME);
    }
  }catch{ /* ignore */ }
  return syncChannel;
}

function emitSync(eventName, payload = {}){
  const ch = getSyncChannel();
  if (ch){
    try{ ch.postMessage({ eventName, payload, at: Date.now() }); }catch{}
  }
  // ✅ ping storage ให้แท็บอื่นรู้ (ใช้ key เดียวกับ form.html)
  try{
    localStorage.setItem("__SCC_SYNC_PING__", JSON.stringify({ t: Date.now(), eventName, payload }));
  }catch{}
}


function onSyncMessage(handler){
  const ch = getSyncChannel();
  if (ch){
    ch.onmessage = (e) => {
      const msg = e?.data;
      if (msg?.eventName) handler(msg.eventName, msg.payload || {});
    };
  }
  window.addEventListener("storage", (e) => {
    if (e.key === STORAGE_KEY || e.key === "__SCC_SYNC_PING__"){
      handler("STORAGE_CHANGED", {});
    }
  });
}

/* ✅ Robust mission date getter */
function getMissionDateISO(m){
  const candidates = [
    m?.date,
    m?.dateISO,
    m?.missionDate,
    m?.details?.date,
    m?.details?.dateISO,
    m?.details?.missionDate,
    m?.details?.missionDateISO,
  ];
  for (const v of candidates){
    const s = String(v ?? "").trim();
    if (s && /^\d{4}-\d{2}-\d{2}/.test(s)) return s.slice(0,10);
  }
  return "";
}

/* ===== helpers ===== */

function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}
function nowHHMM(){
  const d = new Date();
  return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}

// ✅ เลือกแหล่งข้อมูล: "firestore" หรือ "local"
// แนะนำตั้งเป็น "firestore" เมื่อเริ่มใช้ Firebase แล้ว


function normalizeMissionInPlace_(m){
  if (!m) return;
  m.details = m.details || {};

  const today = getTodayISO();

  // ดึง status จากหลายที่ แล้ว normalize
  const st = m.status || m.details.status || m.details.Status || "";
  m.status = normStatus(st);
  m.details.status = m.status; // ✅ keep in sync

  // date กันหลุด
  m.date = m.date || getMissionDateISO(m) || today;
}

function readMissions(){
  // ✅ Firestore mode: ใช้ข้อมูลจาก listener
  if ((window.DATA_SOURCE || "local") === "firestore"){
    return Array.isArray(window.FIRESTORE_MISSIONS) ? window.FIRESTORE_MISSIONS : [];
  }

  // ✅ Local mode (เดิม)
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    const missions = Array.isArray(arr) ? arr : [];

    for (const m of missions){
      normalizeMissionInPlace_(m);
    }
    return missions;
  }catch{
    return [];
  }
}

async function readMissionsSourceOfTruth(){

  // 1️⃣ Firestore first
  if (window.DB?.loadAllMissions){
    try{
      const arr = await window.DB.loadAllMissions();
      window.DATA_SOURCE = "firestore";
      return Array.isArray(arr) ? arr : [];
    }catch(err){
      console.error("Firestore load failed:", err);
    }
  }

  // 2️⃣ fallback localStorage
  window.DATA_SOURCE = "local";
  return readMissions();
}


/**
 * ✅ ใช้กับข้อมูลที่มาจาก Firestore:
 * เรียกฟังก์ชันนี้เพื่อ normalize missions ก่อนส่งเข้า render เดิมของคุณ
 */
function normalizeMissionsFromFirestore(missions){
  const arr = Array.isArray(missions) ? missions : [];
  for (const m of arr){
    // แปลง field จาก Firestore ให้เข้าของเดิม
    // - missionId (doc) -> id / m.id
    if (m && m.missionId && !m.id) m.id = String(m.missionId);

    // - statusCurrent -> status
    if (m && m.statusCurrent && !m.status) m.status = String(m.statusCurrent);

    // - missionDateISO -> date (YYYY-MM-DD)
    //   (ถ้าคุณใช้ date แบบวันอย่างเดียว)
    if (m && m.missionDateISO && !m.date){
      m.date = String(m.missionDateISO).slice(0, 10);
    }

    normalizeMissionInPlace_(m);
  }
  return arr;
}


// helper เดิมของคุณ
function hydrateMissionForSave_(m){
  if (!m) return;
  m.details = m.details || {};

  const today = getTodayISO();

  // ✅ hydrate status
  m.status = normStatus(m.status || m.details.status || m.details.Status || "");
  m.details.status = m.status; // ✅ keep in sync

  // ✅ hydrate date
  m.date = m.date || getMissionDateISO(m) || today;
}


function normStatus(s){
  const raw = String(s ?? "").trim();
  if (!raw) return "Scheduled";

  const k = raw.toLowerCase();

  if (k === "activated") return "Activated";
  if (k === "scheduled") return "Scheduled";
  if (k === "preparing") return "Preparing";
  if (k === "delayed") return "Delayed";
  if (k === "transporting") return "Transporting";
  if (k === "returning") return "Returning";
  if (k === "completed") return "Completed";
  if (k === "cancelled" || k === "canceled") return "Cancelled";
  if (k === "aborted") return "Aborted";
  if (k === "pending") return "Pending";

  // ถ้าเป็นค่าอื่น ๆ ให้คืนค่าเดิม
  return raw;
}


/* ===== ICON SVGs ===== */
const ICON_PREPARING_1 = `
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
  <path d="M12 6v6l4 2"/>
  <path d="M22 12a10 10 0 1 0-11 9.95"/>
  <path d="m22 16-5.5 5.5L14 19"/>
</svg>
`;

const ICON_DELAYED_1 = `
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
  <circle cx="12" cy="13" r="8"/>
  <path d="M12 9v4l2 2"/>
  <path d="M5 3 2 6"/>
  <path d="m22 6-3-3"/>
  <path d="M6.38 18.7 4 21"/>
  <path d="M17.64 18.67 20 21"/>
</svg>
`;

const ICON_TRANSPORTING_1 = `
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
  <path d="M10 10H6"/>
  <path d="M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2"/>
  <path d="M19 18h2a1 1 0 0 0 1-1v-3.28a1 1 0 0 0-.684-.948l-1.923-.641a1 1 0 0 1-.578-.502l-1.539-3.076A1 1 0 0 0 16.382 8H14"/>
  <path d="M8 8v4"/>
  <path d="M9 18h6"/>
  <circle cx="17" cy="18" r="2"/>
  <circle cx="7" cy="18" r="2"/>
</svg>
`;

const ICON_RETURNING_1 = `
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
  <path d="M11 9a1 1 0 0 0 1-1V5.061a1 1 0 0 1 1.811-.75l6.836 6.836a1.207 1.207 0 0 1 0 1.707l-6.836 6.835a1 1 0 0 1-1.811-.75V16a1 1 0 0 0-1-1H5a1 1 0 0 1-1-1v-4a1 1 0 0 1 1-1z"/>
</svg>
`;

const ICON_RETURNING_2 = `
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
  <path d="M12 7v4"/>
  <path d="M14 21v-3a2 2 0 0 0-4 0v3"/>
  <path d="M14 9h-4"/>
  <path d="M18 11h2a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-9a2 2 0 0 1 2-2h2"/>
  <path d="M18 21V5a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16"/>
</svg>
`;

function getStatusIconsHTML(status){
  const s = normStatus(status);
  if (s === "Preparing") return `<span class="statusIcons preparing">${ICON_PREPARING_1}</span>`;
  if (s === "Delayed") return `<span class="statusIcons delayed">${ICON_DELAYED_1}</span>`;
  if (s === "Transporting") return `<span class="statusIcons transporting">${ICON_TRANSPORTING_1}</span>`;
  if (s === "Returning") return `<span class="statusIcons returning">${ICON_RETURNING_1}${ICON_RETURNING_2}</span>`;
  return "";
}

function getAutoStatusForDisplay(m){
  const cur = normStatus(getRawStatus(m));

  // สถานะพวกนี้ห้าม auto เปลี่ยน (และไม่แตะ Firestore)
  if (["Activated","Transporting","Returning","Completed","Cancelled"].includes(cur)) return cur;
  if (!["Scheduled","Preparing","Delayed"].includes(cur)) return cur;

  const d = m.details || {};
  const dep = d.departureFromHospital || d.departureOriginal || "";
  const dateISO = getMissionDateISO(m);
  if (!dep || !dateISO) return cur;

  const depDT = toLocalDateTime(dateISO, dep);
  if (!depDT) return cur;

  const diffMin = (depDT - new Date()) / 60000;

  if (cur === "Scheduled" && diffMin <= 30 && diffMin > 0) return "Preparing";
  if ((cur === "Scheduled" || cur === "Preparing") && diffMin <= 0) return "Delayed";
  if (cur === "Delayed" && diffMin > 0) return "Preparing";

  return cur;
}


function getRawStatus(m){
  const d = (m && m.details) ? m.details : {};
  const candidates = [
    m?.status,
    d?.status,
    d?.Status,          // ✅ เผื่อ form เก็บเป็น S ใหญ่
    d?.missionStatus,   // ✅ เผื่อมี field อื่น
    d?.statusText,
    d?.statusKey
  ];
  for (const v of candidates){
    const s = String(v ?? "").trim();
    if (s) return s;
  }
  return "";
}

function isActivated(m){
  return normStatus(getRawStatus(m)) === "Activated";
}

function isCancelled(m){
  return getRawStatus(m).toLowerCase() === "cancelled";
}

// ✅ status สำหรับ “แสดงผล” = ถ้าเป็น Activated ให้คงไว้ ห้ามโดน logic เวลาเปลี่ยน
function getDisplayStatus(m){
  const raw = getRawStatus(m);
  if (!raw) return "Scheduled";
  if (raw.toLowerCase() === "activated") return "Activated";
  return normStatus(raw);
}

function badgeClassFromStatus(sOrMission){
  const raw = (typeof sOrMission === "object")
    ? getRawStatus(sOrMission)
    : String(sOrMission ?? "");

  const x = normStatus(raw).toLowerCase();

  if (x === "activated") return "b-activated";
  if (x === "scheduled") return "b-scheduled";
  if (x === "preparing") return "b-preparing";
  if (x === "delayed") return "b-delayed";
  if (x === "transporting") return "b-transporting";
  if (x === "returning") return "b-returning";   // ✅ อย่าให้ returning ไปใช้ transporting
  if (x === "completed") return "b-completed";
  if (x === "cancelled") return "b-cancelled";
  if (x === "aborted") return "b-aborted";
  return "b-pending";
}


function toLocalDateTime(dateISO, timeHHMM){
  if(!dateISO || !timeHHMM) return null;
  const [h,m] = String(timeHHMM).split(":").map(Number);
  const d = new Date(dateISO + "T00:00:00");
  d.setHours(h||0, m||0, 0, 0);
  return d;
}

function isoToISODate(iso){
  if(!iso) return "";
  const d = new Date(iso);
  if (isNaN(d.getTime())) return "";
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
}

/* =======================
   ✅ Status Change Log helpers
======================= */
function ensureStatusLog(m){
  m.details = m.details || {};
  if (!Array.isArray(m.details.statusChangeLog)){
    m.details.statusChangeLog = [];
  }
}

function logStatusChange(m, nextStatus, meta = {}){
  if (!m) return false;
  m.details = m.details || {};

  const prev = normStatus(getRawStatus(m) || m.status || m.details.status || "");
  const next = normStatus(nextStatus || "");

  if (!next || prev === next) return false;

  ensureStatusLog(m);

  m.details.statusChangeLog.push({
    from: prev,
    to: next,
    at: nowISO(),
    by: meta.by || "",           // optional
    source: meta.source || "",   // e.g. "followup_cancel", "modal_cancel", "auto_today", "reschedule"
    note: meta.note || ""        // optional
  });

  // ✅ also keep a direct pointer for "statusChangedAt"
  m.details.statusChangedAt = nowISO();

  return true;
}

function renderStatusChangeHistory(m){
  const d = m.details || {};
  const log = Array.isArray(d.statusChangeLog) ? d.statusChangeLog : [];
  if (!log.length) return '<span class="muted">-</span>';

  return [...log].reverse().map(x => {
    const at = x.at ? new Date(x.at) : null;
    const atTxt = at ? at.toLocaleString("th-TH") : "-";
    const from = x.from || "-";
    const to = x.to || "-";

    // ✅ by = ตัวหนา
    const by = x.by
      ? ` • by: <strong>${escapeHtml(x.by)}</strong>`
      : "";

    const src = x.source
      ? ` • <span class="muted">${escapeHtml(x.source)}</span>`
      : "";

    // ✅ note: ทำ "2026-02-04 23:40" ให้ตัวหนา (pattern YYYY-MM-DD HH:MM)
    let note = "";
    if (x.note){
      const highlighted = escapeHtml(x.note).replace(
        /(\d{4}-\d{2}-\d{2}\s\d{2}:\d{2})/g,
        "<strong>$1</strong>"
      );
      note = ` • <span class="muted">${highlighted}</span>`;
    }

    return `
      <div style="margin:0 0 8px;">
        <div><strong>${escapeHtml(from)} → ${escapeHtml(to)}</strong></div>
        <div class="muted" style="font-size:12px;">
          ${escapeHtml(atTxt)}${by}${src}${note}
        </div>
      </div>
    `;
  }).join("");
}

/* =======================
   ✅ scheduledAt (kept for existing features)
   - NOT used as source-of-truth for grouping anymore
   - still used by applyAutoStatusForTodayMission
======================= */
function getScheduledAtDateObj(m){
  const d = m?.details || {};
  const dateISO = getMissionDateISO(m) || String(m?.date || "").slice(0,10);
  const t = String(d.departureFromHospital || d.departureOriginal || "").trim();
  if (!dateISO || !t) return null;
  const dt = toLocalDateTime(dateISO, t);
  return dt && !isNaN(dt.getTime()) ? dt : null;
}
function getScheduledAtISODate(m){
  const dt = getScheduledAtDateObj(m);
  return dt ? toISODateLocal(dt) : "";
}
function getScheduledAtTimeHHMM(m){
  const d = m?.details || {};
  const t = String(d.departureFromHospital || d.departureOriginal || "").trim();
  return t || "";
}
function getRequestDateISO(m){
  return getMissionDateISO(m) || String(m?.date || "").slice(0,10) || "";
}

function applyAutoStatusForTodayMission(m, selectedDayISO){
  if (!m) return false;
  m.details = m.details || {};

  // ✅ Activated ห้าม auto เปลี่ยน (กันเคส activated/Activated)
  const rawStatus = String(m.status || m.details.status || "").trim();
  const st = normStatus(rawStatus);
  if (st === "Activated") return false;

  // ✅ ถ้าเป็นสถานะที่ไม่ควรถูก auto แล้ว ก็ไม่แตะ
  // (ถ้าคุณอยากให้ Scheduled/Preparing เท่านั้นที่โดน auto ก็พอ)
  if (["Transporting","Returning","Completed","Cancelled","Aborted"].includes(st)) return false;

  // ✅ ต้องมี scheduled time (departure) ถึงจะคำนวณได้
  const dt = getScheduledAtDateObj(m);
  if (!dt) return false;

  // ✅ ใช้กฎเฉพาะ mission ที่ scheduled day == selected day
  const day = toISODateLocal(dt);
  if (day !== selectedDayISO) return false;

  const now = new Date();
  const diffMin = (dt - now) / 60000; // dt อยู่อนาคต = บวก, เลยเวลาแล้ว = ติดลบ

  // -------------------------
  // ✅ RULES:
  // >30 นาที  -> Scheduled
  // 0–30 นาที -> Preparing
  // เลยเวลา    -> Delayed
  // -------------------------

  let next = null;

  if (diffMin > 30){
    next = "Scheduled";
  } else if (diffMin > 0){
    next = "Preparing";
  } else {
    next = "Delayed";
  }

  // ✅ ถ้าไม่เปลี่ยนจริง ไม่ต้องทำอะไร
  if (normStatus(m.status) === next) return false;

  // ✅ log + set status
  logStatusChange(m, next, {
    source: "auto_today",
    note: "Auto change by schedule time"
  });

  m.status = next;
  m.details.status = next;
  return true;
}


/* =======================
   ✅ Location resolver (fallback) (unchanged)
======================= */
function _firstNonEmpty(...vals){
  for (const v of vals){
    const s = String(v ?? "").trim();
    if (s) return s;
  }
  return "";
}
function getFromTo(m){
  const d = m.details || {};
  const k = String(m.typeKey || "").trim();

  const genericFrom = _firstNonEmpty(
    d.origin, d.from, d.fromText, d.pickupPoint, d.referringHospital, d.sendingHospital, d.originHospital, d.procedureFacility, d.homeAddress
  );
  const genericTo = _firstNonEmpty(
    d.destination, d.to, d.toText, d.dropoffPoint, d.receivingHospital, d.destinationHospital, d.returnHospital, d.procedureFacility, d.homeAddress
  );

  const fromDetail = _firstNonEmpty(d.fromDetail, d.pickupDetail, d.originDetail, d.from_note, d.fromNotes);
  const toDetail   = _firstNonEmpty(d.toDetail, d.dropoffDetail, d.destinationDetail, d.to_note, d.toNotes);

  if (["IFT_BASIC_IN","IFT_ADV_IN","IFT_BASIC_OUT","IFT_ADV_OUT"].includes(k)){
    return {
      from: _firstNonEmpty(d.referringHospital, d.origin, d.fromText, genericFrom) || "-",
      to:   _firstNonEmpty(d.receivingHospital, d.destination, d.toText, genericTo) || "-",
      fromDetail, toDetail
    };
  }
  if (k === "AP_CLINIC_IFT"){
    return {
      from: _firstNonEmpty(d.pickupPoint, d.origin, d.fromText, genericFrom) || "-",
      to:   _firstNonEmpty(d.receivingHospital, d.destination, d.toText, genericTo) || "-",
      fromDetail, toDetail
    };
  }
  if (["AP_ESCORT_IN","TARMAC_IN"].includes(k)){
    return {
      from: _firstNonEmpty(d.pickupPoint, d.origin, d.fromText, genericFrom) || "-",
      to:   _firstNonEmpty(d.destinationHospital, d.destination, d.toText, genericTo) || "-",
      fromDetail, toDetail
    };
  }
  if (["AP_ESCORT_OUT","TARMAC_OUT"].includes(k)){
    return {
      from: _firstNonEmpty(d.sendingHospital, d.origin, d.fromText, genericFrom) || "-",
      to:   _firstNonEmpty(d.dropoffPoint, d.destination, d.toText, genericTo) || "-",
      fromDetail, toDetail
    };
  }
  if (["PROC_SEND_WAIT_PICK","PROC_SEND"].includes(k)){
    return {
      from: _firstNonEmpty(d.originHospital, d.origin, d.fromText, genericFrom) || "-",
      to:   _firstNonEmpty(d.procedureFacility, d.destination, d.toText, genericTo) || "-",
      fromDetail, toDetail
    };
  }
  if (k === "PROC_PICK"){
    return {
      from: _firstNonEmpty(d.procedureFacility, d.origin, d.fromText, genericFrom) || "-",
      to:   _firstNonEmpty(d.returnHospital, d.destination, d.toText, genericTo) || "-",
      fromDetail, toDetail
    };
  }

  return {
    from: genericFrom || "-",
    to: genericTo || "-",
    fromDetail, toDetail
  };
}

//* ===== Departure cell (highlight edited time) ===== */
function formatDepartureCell(m, selectedDay){
  const d = m.details || {};
  const cur  = String(d.departureFromHospital || "").trim();
  const orig = String(d.departureOriginal || "").trim();
  const changed = !!(orig && cur && orig !== cur);

  const baseTime = (cur || orig);
  if (!baseTime) return `<span class="muted">-</span>`;

  // ✅ +1 tag เฉพาะเคสพรุ่งนี้ที่ถูก look-ahead มาโชว์ใน Today
  const isLookAhead = (typeof isLookAheadMission === "function" && isLookAheadMission(m, selectedDay));
  const plus1 = isLookAhead ? ` <span class="tinyTag">+1</span>` : "";

  if (changed){
    return `
      <span class="depWrap">
        <span class="strike">${escapeHtml(orig)}</span>
        <span class="newTime">${escapeHtml(cur)}${plus1}</span>
      </span>
    `;
  }

  return `
    <span class="depWrap">
      <span class="newTime">${escapeHtml(baseTime)}${plus1}</span>
    </span>
  `;
}



function canEditDeparture(m){
  const s = normStatus(m.status);
  return ["Scheduled","Preparing","Delayed"].includes(s);
}

/* ===== Details modal rendering (unchanged) ===== */
function fmt(v){ return v ? escapeHtml(v) : '<span class="muted">-</span>'; }
function section(title, rows){
  const kv = rows.map(([k,v]) => `<div class="k">${escapeHtml(k)}</div><div class="v">${v}</div>`).join("");
  return `<div class="section"><h3>${escapeHtml(title)}</h3><div class="kv">${kv}</div></div>`;
}

/* ... (renderDetails / route helpers / CSV export / follow-up actions) — unchanged ... */

function renderDepartureHistory(m){
  const d = m.details || {};
  const log = Array.isArray(d.departureChangeLog) ? d.departureChangeLog : [];
  if (!log.length) return '<span class="muted">-</span>';

  return [...log].reverse().map(x => {
    const at = x.at ? new Date(x.at) : null;
    const atTxt = at ? at.toLocaleString("th-TH") : "-";
    const from = x.from || "-";
    const to = x.to || "-";
    const who = x.reportedBy || "-";
    return `<div style="margin:0 0 8px;">
      <div><strong>${escapeHtml(from)} → ${escapeHtml(to)}</strong></div>
      <div class="muted" style="font-size:12px;">${escapeHtml(atTxt)} • รับแจ้งจาก: ${escapeHtml(who)}</div>
    </div>`;
  }).join("");
}

/* ✅ Operation Stamp Log (read-only) */
function renderOperationStampLog(m){
  const d = m.details || {};

  const op = d.OperationStamp;
  if (op && Array.isArray(op.steps) && op.steps.length){
    const sorted = [...op.steps].sort((a,b)=> String(a.tsISO||"").localeCompare(String(b.tsISO||"")));
    return sorted.map(s => {
      const atTxt = s.tsISO ? new Date(s.tsISO).toLocaleString("th-TH") : "-";
      const label = s.label || s.key || "-";
      const by = s.by ? ` • by: ${escapeHtml(s.by)}` : "";
      const note = s.note ? ` • <span class="muted">${escapeHtml(s.note)}</span>` : "";
      return `
        <div style="margin:0 0 8px;">
          <div><strong>${escapeHtml(label)}</strong></div>
          <div class="muted" style="font-size:12px;">${escapeHtml(atTxt)}${by}${note}</div>
        </div>
      `;
    }).join("");
  }

  const ed = d.edStamp;
  if (ed && Array.isArray(ed.steps) && ed.steps.length){
    const sorted = [...ed.steps].sort((a,b)=> String(a.tsISO||"").localeCompare(String(b.tsISO||"")));
    return sorted.map(s => {
      const atTxt = s.tsISO ? new Date(s.tsISO).toLocaleString("th-TH") : "-";
      const label = s.label || s.key || "-";
      const by = s.by ? ` • by: ${escapeHtml(s.by)}` : "";
      const note = s.note ? ` • <span class="muted">${escapeHtml(s.note)}</span>` : "";
      return `
        <div style="margin:0 0 8px;">
          <div><strong>${escapeHtml(label)}</strong></div>
          <div class="muted" style="font-size:12px;">${escapeHtml(atTxt)}${by}${note}</div>
        </div>
      `;
    }).join("");
  }

  const log = Array.isArray(d.timeStampLog) ? d.timeStampLog : [];
  if (!log.length) return '<span class="muted">-</span>';

  const sorted = [...log].sort((a,b)=> String(a.at||"").localeCompare(String(b.at||"")));
  return sorted.map(x => {
    const atTxt = x.at ? new Date(x.at).toLocaleString("th-TH") : "-";
    const label = x.stepLabel || x.stepKey || "-";
    return `
      <div style="margin:0 0 8px;">
        <div><strong>${escapeHtml(label)}</strong></div>
        <div class="muted" style="font-size:12px;">${escapeHtml(atTxt)}</div>
      </div>
    `;
  }).join("");
}

/* ===== Route buttons (unchanged) ===== */
function _cleanText(s){ return String(s || "").trim(); }
function _getPin(m, side){
  const d = (m && m.details) ? m.details : {};
  const lat = side === "from" ? d.fromLat : d.toLat;
  const lng = side === "from" ? d.fromLng : d.toLng;
  const la = Number(lat), lo = Number(lng);
  if (Number.isFinite(la) && Number.isFinite(lo)) return `${la},${lo}`;
  return null;
}
function _getDestinationText(m, side){
  const pin = _getPin(m, side);
  if (pin) return pin;

  const ft = getFromTo(m);
  const place = side === "from" ? _cleanText(ft.from) : _cleanText(ft.to);
  const detail = side === "from" ? _cleanText(ft.fromDetail) : _cleanText(ft.toDetail);
  const combined = [place, detail].filter(Boolean).join(" ");
  return combined || null;
}
function openRouteTo(side){
  const m = window.__detailMission;
  if (!m) return;

  const dest = _getDestinationText(m, side);
  if (!dest){
    window.open("https://www.google.com/maps", "_blank", "noopener,noreferrer");
    return;
  }
  const url = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(dest)}&travelmode=driving`;
  window.open(url, "_blank", "noopener,noreferrer");
}

/* ===== renderDetails (unchanged) ===== */
function renderDetails(m){

  const p = m.details || {};
  const blocks = [];

  blocks.push(section("Patient Information — ข้อมูลผู้ป่วย", [
    ["Full Name", fmt(p.fullName)],
    ["Gender", fmt(p.gender)],
    ["Age (years)", fmt(p.ageYears)],
    ["Weight (kg)", fmt(p.weightKg)],
    ["Nationality", fmt(p.nationality)],
    ["HN", fmt(p.hn)],
    ["Ward", fmt(p.ward)],
    ["Diagnosis", fmt(p.diagnosis)],
    ["Purpose of Transport", fmt(p.purpose)]
  ]));

  blocks.push(section("Vehicle", [
    ["Vehicle Type", fmt(p.vehicleType)],
    ["Vehicle (free text)", fmt(m.vehicle)]
  ]));

  const ft = getFromTo(m);
  blocks.push(section("Locations — สถานที่", [
    ["From", `
      ${fmt(ft.from)}
      <div style="margin-top:8px;">
        <button class="btn secondary tiny" type="button" onclick="openRouteTo('from')">Route</button>
      </div>
    `],
    ["From detail (optional)", fmt(ft.fromDetail)],
    ["To", `
      ${fmt(ft.to)}
      <div style="margin-top:8px;">
        <button class="btn secondary tiny" type="button" onclick="openRouteTo('to')">Route</button>
      </div>
    `],
    ["To detail (optional)", fmt(ft.toDetail)],
    ["From pin (lat,lng)", (p.fromLat && p.fromLng) ? fmt(`${p.fromLat}, ${p.fromLng}`) : '<span class="muted">-</span>'],
    ["To pin (lat,lng)", (p.toLat && p.toLng) ? fmt(`${p.toLat}, ${p.toLng}`) : '<span class="muted">-</span>']
  ]));

  const timeRows = [];
  if (p.baseLocation !== undefined) timeRows.push(["Base (SNH/SMCH)", fmt(p.baseLocation)]);

  const orig = p.departureOriginal || "";
  const cur = p.departureFromHospital || "";
  if (cur || orig){
    if (orig && cur && orig !== cur){
      timeRows.push(["Departure (original)", fmt(orig)]);
      timeRows.push(["Departure (current)", fmt(cur)]);
    } else {
      timeRows.push(["Departure from SNH/SMCH hospital", fmt(cur || orig)]);
    }
  }

  if (p.preDepartureBriefing) timeRows.push(["Pre-departure Briefing", fmt(p.preDepartureBriefing)]);
  if (p.schedArriveRefHosp) timeRows.push(["Scheduled Arrival at Referring Hospital", fmt(p.schedArriveRefHosp)]);
  if (p.schedArriveAirport) timeRows.push(["Scheduled Arrival at Airport", fmt(p.schedArriveAirport)]);
  if (p.schedFlightArrive) timeRows.push(["Scheduled Flight Arrival", fmt(p.schedFlightArrive)]);
  if (p.schedFlightDepart) timeRows.push(["Scheduled Flight Departure", fmt(p.schedFlightDepart)]);
  if (p.schedArriveHome) timeRows.push(["Scheduled Arrival at Home", fmt(p.schedArriveHome)]);

  blocks.push(section("Time Log — บันทึกเวลา", timeRows.length ? timeRows : [["(No time log)", '<span class="muted">-</span>']]));

  blocks.push(section("Operation Stamp — ประวัติ stamp", [
    ["History", renderOperationStampLog(m)]
  ]));

  blocks.push(section("Status Change Log — ประวัติการเปลี่ยนสถานะ", [
  ["History", renderStatusChangeHistory(m)]
]));

  blocks.push(section("Mission", [
    ["Mission Group", fmt(m.missionGroup)],
    ["Mission Type (stored)", fmt(m.type)],
    ["Display Label (stored)", fmt(m.typeDisplay)],
    ["Type Key", fmt(m.typeKey)],
    ["Status", `<span class="badge ${badgeClassFromStatus(m.status)}">${escapeHtml(normStatus(m.status))}</span>`],
    ["Notes", fmt(m.notes)]
  ]));

  return blocks.join("");
}

/* ===== CSV export (unchanged) ===== */
function csvEscape(v){
  const s = String(v ?? "");
  if (/[",\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
  return s;
}
function downloadCSV(filename, rows){
  const csv = rows.map(r => r.map(csvEscape).join(",")).join("\n");
  const bom = "\uFEFF"; // ✅ UTF-8 BOM for Excel
  const blob = new Blob([bom + csv], { type:"text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function exportCSV(range){
  const missions = readMissions();
  const now = new Date();
  const y = now.getFullYear();
  const mo = now.getMonth(); // 0-11

  // ===== 1) filter by range (same behavior as your original) =====
  const filtered = missions.filter(ms => {
    const d = String(ms.date || "").slice(0,10);
    if (!d) return false;
    const dt = new Date(d + "T00:00:00");
    if (range === "month") return dt.getFullYear() === y && dt.getMonth() === mo;
    if (range === "year")  return dt.getFullYear() === y;
    return true; // "all"
  });

  // ===== 2) sort by uid (recommended) =====
  const sorted = filtered.slice().sort((a,b) => String(a?.uid||"").localeCompare(String(b?.uid||"")));

  // ===== 3) build dynamic details columns (ALL keys in ms.details) =====
  const detailKeys = new Set();
  sorted.forEach(ms => {
    const d = ms?.details || {};
    Object.keys(d).forEach(k => detailKeys.add(k));
  });

  // กัน key ที่ซ้ำกับ core ที่เรามีอยู่แล้ว (ไม่บังคับ แต่ช่วยไม่ให้คอลัมน์รก)
  const reserved = new Set([
    // already mapped in core below
    "status","requestDateISO","createdAtISO",
    "departureOriginal","departureFromHospital",
    "vehicleType",
    "fromLat","fromLng","toLat","toLng",
    "fromDetail","toDetail",
    "fullName","hn","diagnosis","ward",

    // logs / nested big objects (จะไปอยู่ใน D_... ได้อยู่แล้ว แต่ปกติจะใหญ่)
    // ถ้าคุณอยาก “รวม” ก็เอาออกจาก reserved ได้
    // "departureChangeLog","statusChangeLog","locationChangeLog","formEditLog","OperationStamp","cancel"
  ]);

  const autoDetailsCols = [...detailKeys]
    .filter(k => !reserved.has(k))
    .sort((a,b)=> a.localeCompare(b))
    .map(k => "D_" + k);

  // ===== 4) header (UID first + MissionNo + your original columns + dynamic details) =====
  const header = [
    "UID",          // ✅ sort key / primary key in firestore
    "MissionNo",    // ✅ ms.id (what user typed)

    "Date","RequestDate","CreatedAtISO",

    "DepartureOriginal","DepartureCurrent","Status",
    "MissionGroup","TypeKey","MissionType","DisplayLabel",

    "VehicleType","VehicleFreeText",

    "From","FromDetail","To","ToDetail",
    "FromLat","FromLng","ToLat","ToLng",

    "LastDepartureChangeBy","LastDepartureChangeAt",

    "PatientName","HN","Diagnosis","Ward","Notes",

    "OperationStatus","OperationPattern","OperationLastUpdatedAt",

    "CancelReasonKey","CancelReason","CancelledAtISO","CancelFrom",

    "LastStatusFrom","LastStatusTo","LastStatusChangedAtISO","LastStatusSource",

    "CancelledBy",

    // ✅ ALL details keys (auto)
    ...autoDetailsCols,

    // ✅ optional: keep full details JSON for audit/export
    "DETAILS_JSON"
  ];

  // helper: stringify safely for CSV cell
  function cell(v){
    if (v === undefined || v === null) return "";
    if (typeof v === "object") {
      try { return JSON.stringify(v); } catch { return String(v); }
    }
    return String(v);
  }

  // ===== 5) data rows =====
  const data = sorted.map(ms => {
    const p = ms.details || {};
    const ft = getFromTo(ms);

    const dLog = Array.isArray(p.departureChangeLog) ? p.departureChangeLog : [];
    const lastDep = dLog.length ? dLog[dLog.length - 1] : null;

    const op = p.OperationStamp || null;
    const cancel = p.cancel || {};

    const sLog = Array.isArray(p.statusChangeLog) ? p.statusChangeLog : [];
    const sLast = sLog.length ? sLog[sLog.length - 1] : null;

    const coreRow = [
      // ===== UID + MissionNo =====
      cell(ms.uid || ""),
      cell(ms.id || ""),

      // ===== dates =====
      cell(String(ms.date || "").slice(0,10)),
      cell(String(p.requestDateISO || "").slice(0,10)),
      cell(p.createdAtISO || ""),

      // ===== mission core =====
      cell(p.departureOriginal || ""),
      cell(p.departureFromHospital || ""),
      cell(normStatus(ms.status)),

      cell(ms.missionGroup || ""),
      cell(ms.typeKey || ""),
      cell(ms.type || ""),
      cell(ms.typeDisplay || ""),

      // ===== vehicle =====
      cell(p.vehicleType || ""),
      cell(ms.vehicle || ""),

      // ===== location =====
      cell(ft.from || ""),
      cell(ft.fromDetail || ""),
      cell(ft.to || ""),
      cell(ft.toDetail || ""),
      cell(p.fromLat || ""),
      cell(p.fromLng || ""),
      cell(p.toLat || ""),
      cell(p.toLng || ""),

      // ===== departure change (last) =====
      cell(lastDep ? (lastDep.reportedBy || "") : ""),
      cell(lastDep ? (lastDep.at || "") : ""),

      // ===== patient =====
      cell(p.fullName || ""),
      cell(p.hn || ""),
      cell(p.diagnosis || ""),
      cell(p.ward || ""),
      cell(ms.notes || ""),

      // ===== operation =====
      cell(op ? (op.status || "") : ""),
      cell(op ? (op.patternKey || op.pattern || "") : ""),
      cell(op ? (op.lastUpdatedAt || "") : ""),

      // ===== cancel =====
      cell(cancel.cancelReasonKey || ""),
      cell(cancel.cancelReason || ""),
      cell(cancel.cancelledAtISO || ""),
      cell(cancel.from || ""),

      // ===== status change (last) =====
      cell(sLast ? (sLast.from || "") : ""),
      cell(sLast ? (sLast.to || "") : ""),
      cell(sLast ? (sLast.at || "") : ""),
      cell(sLast ? (sLast.source || "") : ""),

      // ===== cancelled by =====
      cell(cancel.cancelledBy || "")
    ];

    // auto details row: D_<key>
    const autoRow = autoDetailsCols.map(col => {
      const key = col.slice(2); // remove "D_"
      return cell(p[key]);
    });

    const detailsJSON = cell(p);

    return [...coreRow, ...autoRow, detailsJSON];
  });

  // ===== 6) filename =====
  const stamp = (range === "month") ? `${y}-${pad2(mo+1)}`
              : (range === "year")  ? `${y}`
              : `${y}-${pad2(mo+1)}-${pad2(now.getDate())}`;

  downloadCSV(`SCC_Missions_${range}_${stamp}.csv`, [header, ...data]);
}


/* =======================
   ✅ Follow-Up actions
   - Cancel uses modal dialog (radio reasons)
   - Reschedule unchanged
======================= */

/* =========================================================
   ✅ Firestore write helpers (Stable / Permanent)
   - Prefer window.DB.* (firestore_bridge.js)
   - Fallback to legacy window.__* if still present
   - ✅ Minimal change: ไม่ยุ่งกับ function อื่น
========================================================= */
async function fsUpdateMission(missionId, eventType, by, note, patch){
  // ✅ NEW: prefer stable bridge
  if (window.DB && typeof window.DB.updateMission === "function"){
    return await window.DB.updateMission(String(missionId), eventType, by, note, patch || {});
  }

  // fallback legacy
  if (typeof window.__addEventAndUpdateMission === "function"){
    const ev = {
      eventType: String(eventType || "UPDATE"),
      by: String(by || ""),
      note: String(note || ""),
      eventAtISO: new Date().toISOString()
    };
    return await window.__addEventAndUpdateMission(String(missionId), ev, patch || {});
  }

  throw new Error("Firestore bridge not ready: DB.updateMission / __addEventAndUpdateMission missing");
}

async function fsDeleteMission(missionId){
  // ✅ NEW: prefer stable bridge
  if (window.DB && typeof window.DB.deleteMission === "function"){
    return await window.DB.deleteMission(String(missionId));
  }

  // fallback legacy
  if (typeof window.__deleteMission === "function"){
    return await window.__deleteMission(String(missionId));
  }

  throw new Error("Firestore bridge not ready: DB.deleteMission / __deleteMission missing");
}

/* =======================
   ✅ ELEMENT REFS (INDEX.HTML)  << ต้องอยู่ก่อน wire event
======================= */

// ===== Detail Modal =====
const modalOverlay  = document.getElementById("modalOverlay");
const modalTitle    = document.getElementById("modalTitle");
const modalSub      = document.getElementById("modalSub");
const modalBody     = document.getElementById("modalBody");
const closeModalBtn = document.getElementById("closeModalBtn");

// ===== Edit Departure Modal refs =====
const editOverlay    = document.getElementById("editOverlay");
const closeEditBtn   = document.getElementById("closeEditBtn");
const cancelEditBtn  = document.getElementById("cancelEditBtn");
const saveEditBtn    = document.getElementById("saveEditBtn");
const newDeparture   = document.getElementById("newDeparture");
const reportedBy     = document.getElementById("reportedBy");
const editTitle      = document.getElementById("editTitle");
const editSub        = document.getElementById("editSub");

// Footer buttons
const editTimeBtn = document.getElementById("editTimeBtn");
const editBtn     = document.getElementById("editBtn");
const deleteBtn   = document.getElementById("deleteBtn");

// ✅ Cancel button inside detail modal
const cancelBtn   = document.getElementById("cancelBtn");

// ===== Cancel Dialog =====
const cancelOverlay    = document.getElementById("cancelOverlay");
const cancelTitleEl    = document.getElementById("cancelTitle");
const cancelSubEl      = document.getElementById("cancelSub");
const closeCancelBtn   = document.getElementById("closeCancelBtn");
const cancelCancelBtn  = document.getElementById("cancelCancelBtn");
const confirmCancelBtn = document.getElementById("confirmCancelBtn");
const cancelByEl       = document.getElementById("cancelBy");

// ===== Reschedule Dialog =====
const reschedOverlay    = document.getElementById("reschedOverlay");
const reschedTitleEl    = document.getElementById("reschedTitle");
const reschedSubEl      = document.getElementById("reschedSub");
const closeReschedBtn   = document.getElementById("closeReschedBtn");
const cancelReschedBtn  = document.getElementById("cancelReschedBtn");
const confirmReschedBtn = document.getElementById("confirmReschedBtn");
const reschedDateEl     = document.getElementById("reschedDate");
const reschedTimeEl     = document.getElementById("reschedTime");
const reschedByEl       = document.getElementById("reschedBy");

// ===== Top stats =====
const total              = document.getElementById("total");
const todayTotal         = document.getElementById("todayTotal");
const activeToday        = document.getElementById("activeToday");
const remainingScheduled = document.getElementById("remainingScheduled");
const completedN         = document.getElementById("completedN");
const cancelledN         = document.getElementById("cancelledN");

// ===== Main controls =====
const search       = document.getElementById("search");
const statusFilter = document.getElementById("statusFilter");
const dateFilter   = document.getElementById("dateFilter");

// ===== Buttons =====
const clearBtn       = document.getElementById("clearBtn");
const exportMonthBtn = document.getElementById("exportMonthBtn");
const exportYearBtn  = document.getElementById("exportYearBtn");

// ===== Clock =====
const clock = document.getElementById("clock");

// ===== Table titles + bodies =====
const tableTitle      = document.getElementById("tableTitle");
const followTitle     = document.getElementById("followTitle");
const missionBody     = document.getElementById("missionBody");
const followBody      = document.getElementById("followBody");
const countNote       = document.getElementById("countNote");
const followCountNote = document.getElementById("followCountNote");

/* ===== Debug warnings (optional) ===== */
if (!modalOverlay)  console.warn("modalOverlay not found");
if (!cancelOverlay) console.warn("cancelOverlay not found");
if (!cancelTitleEl) console.warn("cancelTitle not found");
if (!cancelSubEl)   console.warn("cancelSub not found");

// ✅ Rename button label (Edit Departure Time -> Reschedule)
if (editTimeBtn) editTimeBtn.textContent = "Reschedule";

/* =======================
   ✅ Helpers (ย้ายออกจาก render เพื่อกัน function ซ้อน/ประกาศซ้ำ)
   ✅ KEY FIX: กัน Completed/Cancelled โผล่ใน Follow-up "ทุกกรณี"
======================= */

// ✅ helper: exclude deleted missions (รองรับทั้ง hard-delete และ soft-delete)
function isDeletedMission(m){
  if (!m) return true;
  const d = m.details || {};
  return !!(
    m.isDeleted || m._deleted || m.deleted || m.deletedAt ||
    d.isDeleted || d._deleted || d.deleted || d.deletedAt
  );
}

function getSelectedDayISO(){
  const todayISO = toISODateLocal(new Date());
  const picked = String(dateFilter?.value || "").trim();
  return picked || todayISO;
}

function getRawStatusLocal(m){
  const s1 = (m && m.status != null) ? String(m.status).trim() : "";
  const s2 = (m && m.details && m.details.status != null) ? String(m.details.status).trim() : "";
  return s1 || s2;
}

/* ✅ Robust status normalizer (ครอบคลุม legacy/case/space/synonyms)
   - ไม่ไปแก้ normStatus เดิมของระบบอื่น
   - ใช้เฉพาะในก้อนนี้ เพื่อกัน Done หลุดเข้า Follow-up
*/
function normStatusX(v){
  const raw = String(v ?? "").trim();
  // try existing normStatus first
  let s = (typeof normStatus === "function") ? String(normStatus(raw) || "").trim() : raw;

  const t = s.toLowerCase().replace(/\s+/g, " ").trim();

  // Done / Abort (ครอบคลุมสะกดต่างๆ)
  if (["complete","completed","done","finish","finished","สำเร็จ","เสร็จ","จบ"].includes(t)) return "Completed";
  if (["cancel","cancelled","canceled","ยกเลิก","ยกเลิกเคส","ยกเลิกภารกิจ"].includes(t)) return "Cancelled";
  if (["abort","aborted","ยุติ","ยุติภารกิจ"].includes(t)) return "Aborted";

  // Others (กันสะกดเพี้ยน/ภาษาผสม)
  if (["schedule","scheduled","นัด","นัดหมาย"].includes(t)) return "Scheduled";
  if (["prepare","preparing","เตรียม","เตรียมพร้อม"].includes(t)) return "Preparing";
  if (["delay","delayed","ล่าช้า","ช้า"].includes(t)) return "Delayed";
  if (["activate","activated","เริ่ม","active"].includes(t)) return "Activated";
  if (["transport","transporting","enroute","en route","กำลังส่ง","กำลังเดินทาง"].includes(t)) return "Transporting";
  if (["return","returning","กลับ","กำลังกลับ"].includes(t)) return "Returning";
  if (["pending","รอ"].includes(t)) return "Pending";

  return s || raw;
}

function getStatusCandidates(m){
  return [m?.status, m?.details?.status].map(normStatusX).filter(Boolean);
}

function isDoneStatus(st){
  const s = normStatusX(st);
  return s === "Completed" || s === "Cancelled";
}

// ✅ FINAL GUARD: Completed/Cancelled/Aborted "ห้ามเข้าทั้ง filter และ render" ของ Follow-up
function isDoneMission(m){
  const cands = getStatusCandidates(m);
  return cands.some(s => s === "Completed" || s === "Cancelled" || s === "Aborted");
}

function getStatusChangedAtISO(m){
  const d = m?.details || {};

  // 1) explicit statusChangedAt
  const direct = String(m?.statusChangedAt || d?.statusChangedAt || "").trim();
  if (direct) return direct;

  // 2) Cancelled
  const c = d.cancel || {};
  const cancelledISO = String(c.cancelledAtISO || d.cancelledAtISO || d.cancelledAt || "").trim();
  if (cancelledISO) return cancelledISO;

  // 3) Completed (best-effort)
  const completedDirect = String(d.completedAtISO || d.completedAt || "").trim();
  if (completedDirect) return completedDirect;

  const op = d.OperationStamp || {};
  const opLast = String(op.lastUpdatedAt || "").trim();
  if (opLast) return opLast;

  if (Array.isArray(op.steps) && op.steps.length){
    const lastStep = [...op.steps]
      .filter(x => x && x.tsISO)
      .sort((a,b)=> String(a.tsISO).localeCompare(String(b.tsISO)))
      .pop();
    if (lastStep?.tsISO) return String(lastStep.tsISO);
  }

  const log = Array.isArray(d.timeStampLog) ? d.timeStampLog : [];
  if (log.length){
    const last = [...log]
      .filter(x => x && x.at)
      .sort((a,b)=> String(a.at).localeCompare(String(b.at)))
      .pop();
    if (last?.at) return String(last.at);
  }

  return "";
}

function getStatusChangedDayISO(m){
  const iso = getStatusChangedAtISO(m);
  return isoToISODate(iso) || "";
}

/* =======================
   ✅ Cancel Modal State
======================= */
let cancelTargetId = null;

function getSelectedCancelReasonKey(){
  const el = document.querySelector('input[name="cancelReason"]:checked');
  return el ? String(el.value) : "";
}

function cancelReasonText(key){
  if (key === "MISSED") return "Missed mission";
  if (key === "ABORTED") return "Aborted mission";
  if (key === "INCORRECT") return "Incorrect information";
  return "";
}

function openCancelFromFollowUp(id){
  const missions = readMissions();
  const m = missions.find(x => String(x.id) === String(id));
  if (!m) return;

  cancelTargetId = m.id;

  // header text
  if (cancelTitleEl) cancelTitleEl.textContent = "Cancel Mission";
  const dep = (m.details||{}).departureFromHospital || (m.details||{}).departureOriginal || "";
  if (cancelSubEl) cancelSubEl.textContent =
    `Mission ${m.id} • ${getMissionDateISO(m) || "-"} ${dep || ""}`.trim();

  // button labels
  if (confirmCancelBtn) confirmCancelBtn.textContent = "Confirm Cancellation";
  if (closeCancelBtn) closeCancelBtn.textContent = "Close";
  if (cancelCancelBtn) cancelCancelBtn.textContent = "Close";

  // default select = MISSED
  const radios = [...document.querySelectorAll('input[name="cancelReason"]')];
  radios.forEach(r => r.checked = false);
  const def = radios.find(r => r.value === "MISSED");
  if (def) def.checked = true;

  if (cancelByEl) cancelByEl.value = "";
  if (cancelOverlay) cancelOverlay.style.display = "flex";
}

function closeCancelModal(){
  if (cancelOverlay) cancelOverlay.style.display = "none";
  cancelTargetId = null;
  if (cancelByEl) cancelByEl.value = "";
}

/* ✅ keep existing button calls working */
function cancelFromFollowUp(id){
  openCancelFromFollowUp(id);
}

/* =======================
   ✅ Reschedule Modal State
======================= */
let reschedTargetId = null;

function openRescheduleFromFollowUp(id){
  const missions = readMissions();
  const m = missions.find(x => String(x.id) === String(id));
  if (!m) return;

  reschedTargetId = m.id;

  // header
  if (reschedTitleEl) reschedTitleEl.textContent = "Reschedule to Today";
  const dep = (m.details||{}).departureFromHospital || (m.details||{}).departureOriginal || "";
  if (reschedSubEl) reschedSubEl.textContent =
    `Mission ${m.id} • ${getMissionDateISO(m) || "-"} ${dep || ""}`.trim();

  // default date = selected day / today
  const selectedDay = getSelectedDayISO();
  if (reschedDateEl) reschedDateEl.value = selectedDay;

  // ✅ default time = NOW
  if (reschedTimeEl) reschedTimeEl.value = nowHHMM();

  if (reschedByEl) reschedByEl.value = "";

  // show
  if (reschedOverlay) reschedOverlay.style.display = "flex";
}

// ✅ alias for old call sites (prevent ReferenceError)
function openRescheduleModal(id){
  openRescheduleFromFollowUp(id);
}

function closeRescheduleModal(){
  if (reschedOverlay) reschedOverlay.style.display = "none";
  reschedTargetId = null;
  if (reschedDateEl) reschedDateEl.value = "";
  if (reschedTimeEl) reschedTimeEl.value = "";
  if (reschedByEl) reschedByEl.value = "";
}

/* ✅ SINGLE SOURCE OF TRUTH — Reschedule uses modal only */
function rescheduleFromFollowUp(id){
  openRescheduleFromFollowUp(id);
}

/* =======================
   ✅ Wire Cancel/Reschedule dialog buttons
======================= */
if (closeCancelBtn)  closeCancelBtn.addEventListener("click", closeCancelModal);
if (cancelCancelBtn) cancelCancelBtn.addEventListener("click", closeCancelModal);

if (cancelOverlay){
  cancelOverlay.addEventListener("click", (e)=>{ if (e.target === cancelOverlay) closeCancelModal(); });
}

if (closeReschedBtn)  closeReschedBtn.addEventListener("click", closeRescheduleModal);
if (cancelReschedBtn) cancelReschedBtn.addEventListener("click", closeRescheduleModal);

if (reschedOverlay){
  reschedOverlay.addEventListener("click", (e)=>{ if (e.target === reschedOverlay) closeRescheduleModal(); });
}

/* =======================
   ✅ Wire Confirm Cancel
======================= */
if (confirmCancelBtn){
  confirmCancelBtn.addEventListener("click", async () => {
    if (!cancelTargetId) return;

    const key = getSelectedCancelReasonKey();
    if (!key){
      alert("กรุณาเลือกเหตุผลการ Cancel");
      return;
    }

    const who = String(cancelByEl?.value || "").trim();
    if (!who){
      alert("กรุณาใส่ชื่อผู้แจ้ง (Cancelled by)");
      return;
    }

    const missions = readMissions();
    const idx = missions.findIndex(x => String(x.id) === String(cancelTargetId));
    if (idx < 0) return;

    const m = missions[idx];
    const hadScheduledAt = !!getScheduledAtDateObj(m);

    m.details = m.details || {};
    m.details.cancel = m.details.cancel || {};

    m.details.cancel.cancelReasonKey = key;
    m.details.cancel.cancelReason    = cancelReasonText(key);
    m.details.cancel.cancelledAtISO  = nowISO();
    m.details.cancel.from            = hadScheduledAt ? "Scheduled" : "Activated";
    m.details.cancel.cancelledBy     = who;

    const nextStatus = "Cancelled";

    logStatusChange(m, nextStatus, {
      by: who,
      source: (cancelTargetId === currentMissionId) ? "modal_cancel" : "followup_cancel",
      note: m.details.cancel.cancelReason
    });

    m.status = nextStatus;
    m.details.status = nextStatus;

    // ✅ Log to Sheet
    pushLogToSheet({
      eventId: makeEventId_(),
      ...buildLogBase(m),
      eventType: "STATUS_CHANGE",
      by: who,
      note: `Cancel: ${m.details.cancel.cancelReasonKey || ""} - ${m.details.cancel.cancelReason || ""}`,
    }).catch(err => console.warn("log send failed (ignored)", err));

    // ✅ Firestore write (source of truth)
    await fsUpdateMission(m.id, "STATUS_CHANGE", who, `Cancel: ${key}`, {
      statusCurrent: "Cancelled",
      status: "Cancelled",
      details: m.details,
      missionDateISO: getMissionDateISO(m),
      date: getMissionDateISO(m)
    });

    closeCancelModal();
    if (typeof closeModal === "function") closeModal();
    // ไม่ต้อง render(); listener จะดึงใหม่เอง
  });
}

/* =======================
   ✅ Wire "Cancel" button inside detail modal
======================= */
if (cancelBtn){
  cancelBtn.addEventListener("click", () => {
    if (!currentMissionId) return;
    openCancelFromFollowUp(currentMissionId);
  });
}

/* =======================
   ✅ Wire Confirm Reschedule
======================= */
if (confirmReschedBtn){
  confirmReschedBtn.addEventListener("click", async () => {
    if (!reschedTargetId) return;

    const newDate = String(reschedDateEl?.value || "").trim();
    const newTime = String(reschedTimeEl?.value || "").trim();

    if (!/^\d{4}-\d{2}-\d{2}$/.test(newDate)){
      alert("รูปแบบวันที่ไม่ถูกต้อง (ต้องเป็น YYYY-MM-DD)");
      return;
    }
    if (!/^\d{2}:\d{2}$/.test(newTime)){
      alert("รูปแบบเวลาไม่ถูกต้อง (ต้องเป็น HH:MM)");
      return;
    }

    const who = String(reschedByEl?.value || "").trim();
    if (!who){
      alert("กรุณาใส่ชื่อผู้แจ้ง (Rescheduled by)");
      return;
    }

    const missions = readMissions();
    const idx = missions.findIndex(x => String(x.id) === String(reschedTargetId));
    if (idx < 0) return;

    const m = missions[idx];
    m.details = m.details || {};

    const cur = String(m.details.departureFromHospital || m.details.departureOriginal || "").trim();
    if (!m.details.departureOriginal && cur) m.details.departureOriginal = cur;

    m.date = newDate;
    m.details.departureFromHospital = newTime;

    const nextStatus = "Scheduled";
    logStatusChange(m, nextStatus, {
      by: who,
      source: "reschedule",
      note: `Reschedule to ${newDate} ${newTime}`
    });

    m.status = nextStatus;
    m.details.status = nextStatus;

    applyAutoStatusForTodayMission(m, newDate);

    await fsUpdateMission(m.id, "RESCHEDULE", who, `Reschedule to ${newDate} ${newTime}`, {
      missionDateISO: newDate,
      date: newDate,
      statusCurrent: m.status,
      status: m.status,
      details: m.details
    });

    closeRescheduleModal();
  });
}

/* =======================
   ✅ Main state/render
======================= */
let allMissions = [];
let currentMissionId = null;

/* ===== realtime refresh open details ===== */
function refreshOpenDetailsIfAny(){
  if (!currentMissionId) return;

  const missions = readMissions();
  const m = missions.find(x => String(x.id) === String(currentMissionId));
  if (!m) return;

  window.__detailMission = m;

  if (modalTitle) modalTitle.textContent = `Mission ${m.id}`;
  const dep = (m.details||{}).departureFromHospital || (m.details||{}).departureOriginal || "";
  const sub = [
    `${getMissionDateISO(m) || "-"} ${dep||""}`.trim(),
    (m.typeDisplay || m.type || "").trim()
  ].filter(Boolean).join(" • ");
  if (modalSub) modalSub.textContent = sub;

  if (modalBody) modalBody.innerHTML = renderDetails(m);

  // ✅ allow reschedule for almost all (including Activated)
  const st = normStatusX(getRawStatus(m));
  const allow = !["Completed","Cancelled","Aborted"].includes(st);

  if (editTimeBtn){
    editTimeBtn.disabled = !allow;
    editTimeBtn.style.opacity = allow ? "1" : "0.45";
    editTimeBtn.style.cursor = allow ? "pointer" : "not-allowed";
    editTimeBtn.title = allow ? "" : "Not allowed for Completed/Cancelled/Aborted";
  }
}

/* =======================
   ✅ Render (จัดให้ชัด, ไม่มี function ซ้อน/ประกาศซ้ำ)
======================= */

function statusRankToday(st){
  st = normStatusX(st);
  if (st === "Preparing") return 1;
  if (st === "Delayed") return 2;
  if (st === "Transporting" || st === "Returning") return 3;
  if (st === "Scheduled") return 4;
  if (st === "Pending") return 5;
  if (st === "Activated") return 6;
  if (st === "Completed") return 7;
  if (st === "Cancelled") return 8;
  return 99;
}

function timeKeyHHMM(m){
  const t = getScheduledAtTimeHHMM(m) || "";
  return /^\d{2}:\d{2}$/.test(t) ? t : "99:99";
}

function applyCommonFilters(list){
  let rows = list;

  const q = String(search?.value || "").trim().toLowerCase();
  const status = String(statusFilter?.value || "ALL");

  if (status !== "ALL"){
    rows = rows.filter(m => normStatusX(m.status) === status);
  }
  if (q){
    rows = rows.filter(m => {
      const ft = getFromTo(m);
      const d = m.details || {};
      const dep = d.departureFromHospital || d.departureOriginal || "";
      const hn = String((m.details || {}).hn || "").trim();

      const blob = [
        m.id,
        hn, // ✅ เพิ่ม HN ให้ search เจอ
        getTypeLabelForTable(m),
        m.type, m.typeDisplay, m.typeKey,
        dep,
        ft.from, ft.to,
        m.notes, m.status
      ].join(" ").toLowerCase();

      return blob.includes(q);
    });
  }

  return rows;
}

function followSortKey(m){
  const dt = getScheduledAtDateObj(m);
  if (!dt){
    const rd = getRequestDateISO(m) || "9999-12-31";
    return { day: rd, time: "" };
  }
  return { day: toISODateLocal(dt), time: getScheduledAtTimeHHMM(m) || "" };
}
/* =========================================================
   ✅ OPERATIONAL GROUPING (PERMANENT) — FINAL
   Today table = Operational view:
   - missions on selectedDay
   - carry-over active from previous days
   - look-ahead (tomorrow <01:00) only after 22:30 and only when selectedDay = real-today
   - Completed/Cancelled show only on statusChangedDay

   Follow-up table = carry-over/overdue from previous days:
   - exclude Completed/Cancelled/Aborted always
   - NOT “all previous days”; only overdue/active signals
   - can overlap with Today BEFORE action
   - MUST disappear from Follow-up after stamp/reschedule/cancel (manual action)
========================================================= */

const LOOKAHEAD_SHOW_AFTER_HHMM = "22:30";
const LOOKAHEAD_CUTOFF_HHMM     = "01:00"; // tomorrow < 01:00

function addDaysISO(dayISO, days){
  const d = new Date(dayISO + "T00:00:00");
  d.setDate(d.getDate() + (days || 0));
  return toISODateLocal(d);
}

function toDT(dayISO, hhmm){
  if(!dayISO || !hhmm) return null;
  const m = /^(\d{2}):(\d{2})$/.exec(String(hhmm).trim());
  if(!m) return null;
  const d = new Date(dayISO + "T00:00:00");
  d.setHours(Number(m[1]), Number(m[2]), 0, 0);
  return d;
}

function getDepartureHHMM(m){
  const d = m?.details || {};
  const t = String(d.departureFromHospital || d.departureOriginal || "").trim();
  return /^\d{2}:\d{2}$/.test(t) ? t : "";
}

function isActiveOpsStatus(st){
  const s = normStatusX(st);
  return ["Scheduled","Preparing","Delayed","Transporting","Returning","Pending","Activated"].includes(s);
}

function isDoneStatusStrict(st){
  const s = normStatusX(st);
  return (s === "Completed" || s === "Cancelled" || s === "Aborted");
}

function getManualActionAtISO(m){
  const d = m?.details || {};

  // 1) CANCEL = details.cancel.cancelledAtISO (ชัวร์สุด)
  const cISO = String(d?.cancel?.cancelledAtISO || "").trim();
  if (cISO) return cISO;

  // 2) RESCHEDULE = หาใน statusChangeLog ที่ source === "reschedule"
  const sLog = Array.isArray(d?.statusChangeLog) ? d.statusChangeLog : [];
  if (sLog.length){
    // เอาอันล่าสุดก่อน
    const lastResched = [...sLog]
      .filter(x => x && String(x.source || "") === "reschedule" && x.at)
      .sort((a,b)=> String(a.at).localeCompare(String(b.at)))
      .pop();

    if (lastResched?.at) return String(lastResched.at);
  }

  // 3) STAMP = OperationStamp.lastUpdatedAt หรือ steps[].tsISO
  const opISO = String(d?.OperationStamp?.lastUpdatedAt || "").trim();
  if (opISO) return opISO;

  const steps = Array.isArray(d?.OperationStamp?.steps) ? d.OperationStamp.steps : [];
  if (steps.length){
    const last = [...steps]
      .filter(x => x?.tsISO)
      .sort((a,b)=> String(a.tsISO).localeCompare(String(b.tsISO)))
      .pop();
    if (last?.tsISO) return String(last.tsISO);
  }

  return "";
}

function hasManualActionOnDay(m, dayISO){
  const iso = getManualActionAtISO(m);
  const dd = isoToISODate(iso);
  return !!(dd && dd === dayISO);
}


function isLookAheadAllowed(selectedDay){
  // ✅ look-ahead ใช้เฉพาะตอน “ดูวันนี้จริง” เท่านั้น
  const realToday = getTodayISO();
  if (selectedDay !== realToday) return false;

  // ✅ ต้องหลัง 22:30
  const now = new Date();
  const gate = toDT(realToday, LOOKAHEAD_SHOW_AFTER_HHMM);
  return gate && now >= gate;
}

function isLookAheadMission(m, selectedDay){
  if (!isLookAheadAllowed(selectedDay)) return false;

  const missionDay = getMissionDateISO(m);
  const dep = getDepartureHHMM(m);
  if (!missionDay || !dep) return false;

  const tomorrow = addDaysISO(selectedDay, 1);
  if (missionDay !== tomorrow) return false;

  const depDT = toDT(tomorrow, dep);
  const cutoffDT = toDT(tomorrow, LOOKAHEAD_CUTOFF_HHMM);
  if (!depDT || !cutoffDT) return false;

  // “พรุ่งนี้ < 01:00”
  return depDT < cutoffDT;
}

function isCarryOverActive(m, selectedDay){
  const st = normStatusX(getRawStatusLocal(m));
  if (!isActiveOpsStatus(st)) return false;

  const missionDay = getMissionDateISO(m);
  if (!missionDay) return false;

  // carry-over = วันก่อนหน้า (หรือเก่ากว่า) และยัง active
  return missionDay < selectedDay;
}

function shouldBeInToday(m, selectedDay){
  if (!m) return false;

  const st = normStatusX(getRawStatusLocal(m));
  if (st === "Aborted") return false;

  const missionDay = getMissionDateISO(m);
  if (!missionDay) return false;

  // Done show only on “done day”
  if (st === "Completed" || st === "Cancelled"){
    const changedDay = getStatusChangedDayISO(m) || missionDay;
    return changedDay === selectedDay;
  }

  // carry-over active
  if (isCarryOverActive(m, selectedDay)) return true;

  // look-ahead (tomorrow <01:00 after 22:30)
  if (isLookAheadMission(m, selectedDay)) return true;

  // normal day
  return missionDay === selectedDay;
}

function shouldBeInFollowUp(m, selectedDay){
  if (!m) return false;

  const st = normStatusX(getRawStatusLocal(m));
  if (isDoneStatusStrict(st)) return false; // ✅ no Completed/Cancelled/Aborted ever

  const missionDay = getMissionDateISO(m);
  if (!missionDay) return false;

  // follow-up = only missions from previous days
  if (missionDay >= selectedDay) return false;

  // ✅ “ไม่ใช่ทุกเคสย้อนหลัง”: เอาเฉพาะ “ค้าง/overdue signals”
  // 1) Activated/Delayed จากวันก่อนหน้า
  if (st === "Activated" || st === "Delayed") return true;

  // 2) Overdue by schedule day (ถ้ามี scheduledAt)
  const dt = getScheduledAtDateObj(m);
  if (dt){
    const schedDay = toISODateLocal(dt);
    if (schedDay && schedDay < selectedDay) return true;
  }

  // 3) Active status อื่นๆของวันก่อน (carry-over จริงๆ)
  if (isActiveOpsStatus(st)) return true;

  return false;
}

function shouldSuppressFollowUpBecauseAction(m, selectedDay){
  // ✅ หลัง stamp / reschedule / cancel (manual action) -> ให้เหลือ Today ที่เดียว
  // เราตัด follow-up เมื่อ:
  // - mission อยู่ Today (ด้วยกฎ ops) และ
  // - มี manual action ใน selectedDay
  if (!shouldBeInToday(m, selectedDay)) return false;
  return hasManualActionOnDay(m, selectedDay);
}
function getCountDayISO(m){
  // นิยาม “วันนับสถิติ”:
  // - Completed/Cancelled -> นับตามวันเปลี่ยนสถานะ (statusChangedDay) ถ้ามี
  // - อย่างอื่น -> นับตาม missionDay
  const st = normStatusX(getRawStatusLocal(m));
  const missionDay = getMissionDateISO(m);

  if (st === "Completed" || st === "Cancelled"){
    return getStatusChangedDayISO(m) || missionDay || "";
  }
  return missionDay || "";
}

async function render(){

  // ✅ source-of-truth
  allMissions = (window.DATA_SOURCE === "firestore")
    ? (window.FIRESTORE_MISSIONS || [])
    : readMissions();

  // ✅ exclude deleted missions
  allMissions = (Array.isArray(allMissions) ? allMissions : []).filter(m => !isDeletedMission(m));

  const selectedDay = getSelectedDayISO();
  const realToday = getTodayISO();
const isOperationalView = (selectedDay === realToday); 
// ✅ true = วันนี้จริง -> ใช้ carry-over + look-ahead + follow-up
// ✅ false = ดูวันอื่น -> strict day (แสดงเฉพาะงานวันนั้น)


  // ==============================
  // ✅ Today table (Operational view) — FINAL (A–D)
  // ==============================
  // ==============================
// ✅ Today table (2-mode)
// - Schedule view (selectedDay != realToday): show ONLY that day
// - Operational view (today only): include carry-over + look-ahead
// - Completed/Cancelled: show only on statusChangedDay (same as your rule)
// ==============================
// ==============================
// ✅ Today table (2-mode)
// - Schedule view (selectedDay != realToday): show ONLY that day
// - Operational view (today only): include carry-over + look-ahead
// - Completed/Cancelled: show only on statusChangedDay (same as your rule)
// ==============================
const todayMissions = allMissions.filter(m => {
  if (!m) return false;

  const st = normStatusX(getRawStatusLocal(m));
  if (st === "Aborted") return false;

  const missionDay = getMissionDateISO(m);
  if (!missionDay) return false;

  // Done statuses: show ONLY on "statusChangedDay" (fallback missionDay)
  if (st === "Completed" || st === "Cancelled"){
    const changedDay = getStatusChangedDayISO(m) || missionDay;
    return changedDay === selectedDay;
  }

  // ✅ Schedule view: STRICT day only (no carry-over / no look-ahead)
  if (!isOperationalView){
    return missionDay === selectedDay;
  }

  // ✅ Operational view (today only): carry-over + look-ahead + today's missions
  if (isCarryOverActive(m, selectedDay)) return true;
  if (isLookAheadMission(m, selectedDay)) return true;

  return missionDay === selectedDay;
});


// ==============================
// ✅ Follow-up table (2-mode)
// - Schedule view: OFF (avoid confusion + stop accumulation problem)
// - Operational view (today only): your previous-day follow-up rules
// ==============================
const followMissions = (() => {
  if (!isOperationalView) return []; // ✅ ปิด follow-up เมื่อดูวันอนาคต/อดีต

  const prevDay = addDaysISO(selectedDay, -1);

  return allMissions.filter(m => {
    if (!m) return false;

    // ✅ never include done in follow-up
    if (isDoneMission(m)) return false;

    const st = normStatusX(getRawStatusLocal(m));
    if (st === "Aborted") return false;

    const missionDay = getMissionDateISO(m);
    if (!missionDay) return false;

    // ✅ Follow-up = “เมื่อวานเท่านั้น”
    if (missionDay !== prevDay) return false;

    // ✅ ต้องยัง active
    if (!isActiveOpsStatus(st)) return false;

    // ✅ ถ้ามี manual action ใน selectedDay และ mission อยู่ Today แล้ว -> ตัดออกจาก follow-up
    if (shouldSuppressFollowUpBecauseAction(m, selectedDay)) return false;

    return true;
  });
})();


  // ==============================
// ✅ TOP STATS (SINGLE SOURCE OF TRUTH — same logic everywhere)
// Total (Year)   = count by getCountDayISO within selectedYear (exclude deleted already done)
// Total (Today)  = operational rows (todayMissions.length)
// Active         = todayMissions where has stamp >=1 step AND not done
// Remaining      = todayMissions effective status is Scheduled or Delayed
// Completed/Cancelled = todayMissions effective status equals Completed/Cancelled
// ==============================

// --- helpers (local to this block) ---
function getEffectiveStatusForUI_(m){
  const raw = normStatusX(getRawStatusLocal(m));
  if (raw === "Scheduled" || raw === "Preparing" || raw === "Delayed"){
    return normStatusX(getAutoStatusForDisplay(m)); // ✅ use display status for these 3
  }
  return raw;
}
function hasAnyStampStep_(m){
  const steps = m?.details?.OperationStamp?.steps;
  return Array.isArray(steps) && steps.length > 0;
}
function isDoneEff_(eff){
  const s = normStatusX(eff);
  return s === "Completed" || s === "Cancelled" || s === "Aborted";
}

// --- Year total (by count-day) ---
const selectedYear = String(selectedDay || "").slice(0, 4);

const yearRows = allMissions.filter(m => {
  const day = getCountDayISO(m);
  return day && String(day).slice(0,4) === selectedYear;
});

// --- Today totals (operational rows) ---
const totalToday = Array.isArray(todayMissions) ? todayMissions.length : 0;

// --- Active / Remaining / Done counts (based on effective status) ---
const activeCount = (todayMissions || []).filter(m => {
  const eff = getEffectiveStatusForUI_(m);
  if (isDoneEff_(eff)) return false;
  return hasAnyStampStep_(m);
}).length;

const remainingCount = (todayMissions || []).filter(m => {
  const eff = getEffectiveStatusForUI_(m);
  return (eff === "Scheduled" || eff === "Delayed");
}).length;

const completedToday = (todayMissions || []).filter(m => getEffectiveStatusForUI_(m) === "Completed").length;
const cancelledToday = (todayMissions || []).filter(m => getEffectiveStatusForUI_(m) === "Cancelled").length;

// --- write to UI ---
if (total) total.innerText = String(yearRows.length);
if (todayTotal) todayTotal.innerText = String(totalToday);
if (activeToday) activeToday.innerText = String(activeCount);
if (remainingScheduled) remainingScheduled.innerText = String(remainingCount);
if (completedN) completedN.innerText = String(completedToday);
if (cancelledN) cancelledN.innerText = String(cancelledToday);

// --- Title (unchanged) ---
if (tableTitle){
  const titleDate = new Date(selectedDay + "T00:00:00");
  tableTitle.innerText =
    `Today Missions: ${titleDate.toLocaleDateString("th-TH", { year:"numeric", month:"short", day:"numeric" })}`;
}


  // ==============================
  // ✅ Today Missions sorting + render
  // ==============================
  let todayRows = applyCommonFilters(todayMissions);

  todayRows.sort((a,b)=>{
    const ra = statusRankToday(getRawStatus(a));
    const rb = statusRankToday(getRawStatus(b));
    if (ra !== rb) return ra - rb;

    const ta = timeKeyHHMM(a);
    const tb = timeKeyHHMM(b);
    if (ta !== tb) return ta.localeCompare(tb);

    return String(a.id ?? "").localeCompare(String(b.id ?? ""));
  });

  if (!todayRows.length){
    if (missionBody) missionBody.innerHTML = `<tr><td colspan="8" class="muted">No missions found.</td></tr>`;
    if (countNote) countNote.innerText = "";
  } else {
    if (missionBody){
      missionBody.innerHTML = todayRows.map(m => {
        const typeShort = getTypeLabelForTable(m);
        const ft = getFromTo(m);
        const s = getAutoStatusForDisplay(m);
        const isLookAhead = isLookAheadMission(m, selectedDay);
      const rowClass = isLookAhead ? "lookAheadRow" : "";

        return `
          <tr>
            <td><strong>${escapeHtml(m.id ?? "-")}</strong></td>
            <td>${escapeHtml(getMissionDateISO(m) || "-")}</td>
            <td>${formatDepartureCell(m, selectedDay)}</td>

            <td class="col-type">
              <div class="clamp2" title="${escapeHtml(typeShort)}">
                ${escapeHtml(typeShort)}
              </div>
            </td>

            <td class="col-from">
              <div class="clamp2" title="${escapeHtml(ft.from || "-")}">
                ${escapeHtml(ft.from || "-")}
              </div>
            </td>

            <td class="col-to">
              <div class="clamp2" title="${escapeHtml(ft.to || "-")}">
                ${escapeHtml(ft.to || "-")}
              </div>
            </td>

            <td>
              <div class="statusCell">
                <span class="badge ${badgeClassFromStatus(s)}">${escapeHtml(s)}</span>
                ${getStatusIconsHTML(s)}
              </div>
            </td>

            <td>
              <button class="btn light" type="button"
                      onclick="openDetails('${escapeHtml(m.id)}')">
                Details
              </button>
            </td>
          </tr>
        `;
      }).join("");
    }

    if (countNote) countNote.innerText = `Showing ${todayRows.length} mission(s)`;
  }

  // ==============================
  // ✅ Follow-Up sorting + render
  // - ไม่มี “กันซ้ำถาวร”
  // - ซ้ำกับ Today ได้ก่อน action
  // ==============================
  let followRows = applyCommonFilters(followMissions).filter(m => !isDoneMission(m));

  followRows.sort((a,b)=> {
    const ka = followSortKey(a);
    const kb = followSortKey(b);
    if (ka.day !== kb.day) return String(ka.day).localeCompare(String(kb.day));
    return String(ka.time).localeCompare(String(kb.time));
  });

  if (!followRows.length){
    if (followBody) followBody.innerHTML = `<tr><td colspan="8" class="muted">No follow-up missions.</td></tr>`;
    if (followCountNote) followCountNote.innerText = "";
  } else {
    if (followBody){
      followBody.innerHTML = followRows.map(m => {
        const typeShort = getTypeLabelForTable(m);
        const ft = getFromTo(m);
        const s = normStatusX(getRawStatus(m));

        const dt = getScheduledAtDateObj(m);
        const schedTxt = dt
          ? `${toISODateLocal(dt)} ${getScheduledAtTimeHHMM(m) || ""}`.trim()
          : null;

        return `
          <tr>
            <td>
              <strong style="cursor:pointer;"
                      onclick="openDetails('${escapeHtml(m.id)}')">
                ${escapeHtml(m.id ?? "-")}
              </strong>
            </td>

            <td>${escapeHtml(getRequestDateISO(m) || "-")}</td>

            <td>
              ${schedTxt ? escapeHtml(schedTxt) : `<span class="muted">-</span>`}
            </td>

            <td class="col-type">
              <div class="clamp2" title="${escapeHtml(typeShort)}">
                ${escapeHtml(typeShort)}
              </div>
            </td>

            <td class="col-from">
              <div class="clamp2" title="${escapeHtml(ft.from || "-")}">
                ${escapeHtml(ft.from || "-")}
              </div>
            </td>

            <td class="col-to">
              <div class="clamp2" title="${escapeHtml(ft.to || "-")}">
                ${escapeHtml(ft.to || "-")}
              </div>
            </td>

            <td>
              <div class="statusCell">
                <span class="badge ${badgeClassFromStatus(m)}">${escapeHtml(s)}</span>
                ${getStatusIconsHTML(s)}
              </div>
            </td>

            <td>
              <div style="display:flex; gap:8px; flex-wrap:wrap;">
                <button class="btn danger tiny" type="button"
                        onclick="openCancelFromFollowUp('${escapeHtml(m.id)}')">
                  Cancel
                </button>
                <button class="btn secondary tiny" type="button"
                        onclick="openRescheduleFromFollowUp('${escapeHtml(m.id)}')">
                  Reschedule
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join("");
    }

    if (followCountNote) followCountNote.innerText = `Showing ${followRows.length} follow-up mission(s)`;
  }
}

function safeRender(){
  try{ return render(); }catch(e){ console.error(e); }
}
window.safeRender = safeRender;



/* =======================
   ✅ Details modal control
======================= */
function openDetails(id){
  const m = allMissions.find(x => String(x.id) === String(id));
  if (!m) return;

  currentMissionId = m.id;
  window.__detailMission = m;

  if (modalTitle) modalTitle.textContent = `Mission ${m.id}`;

  const dep = (m.details||{}).departureFromHospital || (m.details||{}).departureOriginal || "";
  const sub = [
    `${getMissionDateISO(m) || "-"} ${dep||""}`.trim(),
    (m.typeDisplay || m.type || "").trim()
  ].filter(Boolean).join(" • ");
  if (modalSub) modalSub.textContent = sub;

  if (modalBody) modalBody.innerHTML = renderDetails(m);
  if (modalOverlay) modalOverlay.style.display = "flex";

  // ✅ allow reschedule for almost all (including Activated)
  const st = normStatusX(getRawStatus(m));
  const allow = !["Completed","Cancelled","Aborted"].includes(st);

  if (editTimeBtn){
    editTimeBtn.disabled = !allow;
    editTimeBtn.style.opacity = allow ? "1" : "0.45";
    editTimeBtn.style.cursor = allow ? "pointer" : "not-allowed";
    editTimeBtn.title = allow ? "" : "Not allowed for Completed/Cancelled/Aborted";
  }
}

function closeModal(){
  if (modalOverlay) modalOverlay.style.display = "none";
  if (modalBody) modalBody.innerHTML = "";
  currentMissionId = null;
  window.__detailMission = null;
}

if (closeModalBtn) closeModalBtn.addEventListener("click", closeModal);

if (modalOverlay){
  modalOverlay.addEventListener("click", (e) => { if (e.target === modalOverlay) closeModal(); });
}

document.addEventListener("keydown", (e) => {
  if (e.key !== "Escape") return;

  if (editOverlay && editOverlay.style.display === "flex"){
    closeEditModal();
  } else if (modalOverlay && modalOverlay.style.display === "flex"){
    closeModal();
  }
});

/* =======================
   ✅ Detail modal footer buttons
======================= */
if (editBtn){
  editBtn.addEventListener("click", () => {
    if (!currentMissionId) return;
    location.href = `form.html?edit=${encodeURIComponent(currentMissionId)}`;
  });
}

if (deleteBtn){
  deleteBtn.addEventListener("click", async () => {
    if (!currentMissionId) return;
    if (!confirm(`ยืนยันลบ mission ${currentMissionId} ใช่ไหม?`)) return;

    await fsDeleteMission(currentMissionId);
    closeModal();
  });
}

/* =======================
   ✅ Edit departure modal logic (เดิม + Firestore persist)
======================= */
let editTargetId = null;

function openEditDeparture(id){
  const missions = readMissions();
  const m = missions.find(x => String(x.id) === String(id));
  if (!m) return;

  if (!canEditDeparture(m)){
    alert("แก้เวลาได้เฉพาะ status: Scheduled / Preparing / Delayed");
    return;
  }

  editTargetId = m.id;

  const p = m.details || {};
  const cur = p.departureFromHospital || p.departureOriginal || "";
  if (newDeparture) newDeparture.value = cur || "";
  if (reportedBy) reportedBy.value = "";

  if (editTitle) editTitle.textContent = `Edit Departure Time`;
  if (editSub) editSub.textContent = `Mission ${m.id} • Status: ${normStatusX(m.status)}`;

  if (editOverlay) editOverlay.style.display = "flex";
}

function closeEditModal(){
  if (editOverlay) editOverlay.style.display = "none";
  editTargetId = null;
  if (reportedBy) reportedBy.value = "";
}

if (closeEditBtn) closeEditBtn.addEventListener("click", closeEditModal);
if (cancelEditBtn) cancelEditBtn.addEventListener("click", closeEditModal);

if (editOverlay){
  editOverlay.addEventListener("click", (e)=>{ if (e.target === editOverlay) closeEditModal(); });
}

if (saveEditBtn){
  saveEditBtn.addEventListener("click", async () => {
    if (!editTargetId) return;

    const newTime = String(newDeparture?.value || "").trim();
    const who = String(reportedBy?.value || "").trim();

    if (!newTime){
      alert("กรุณาใส่เวลาใหม่");
      return;
    }
    if (!who){
      alert("กรุณาใส่ 'รับแจ้งจากใคร'");
      return;
    }

    const missions = readMissions();
    const idx = missions.findIndex(x => String(x.id) === String(editTargetId));
    if (idx < 0) return;

    const m = missions[idx];
    if (!canEditDeparture(m)){
      alert("แก้เวลาได้เฉพาะ status: Scheduled / Preparing / Delayed");
      closeEditModal();
      return;
    }

    m.details = m.details || {};
    const cur = m.details.departureFromHospital || m.details.departureOriginal || "";

    if (!m.details.departureOriginal && cur){
      m.details.departureOriginal = cur;
    }
    if (!m.details.departureOriginal && !cur){
      m.details.departureOriginal = newTime;
    }

    if (!Array.isArray(m.details.departureChangeLog)){
      m.details.departureChangeLog = [];
    }

    m.details.departureFromHospital = newTime;

    if (cur !== newTime){
      m.details.departureChangeLog.push({
        from: cur || "",
        to: newTime,
        reportedBy: who,
        at: nowISO()
      });
    } else {
      alert("เวลาใหม่เหมือนเดิม (ไม่มีการเปลี่ยนแปลง)");
      return;
    }

    // ✅ also write into Status Change Log as an activity note
    if (!Array.isArray(m.details.statusChangeLog)) m.details.statusChangeLog = [];
    m.details.statusChangeLog.push({
      from: normStatusX(getRawStatus(m) || m.status || m.details.status || ""),
      to:   normStatusX(getRawStatus(m) || m.status || m.details.status || ""),
      at:   nowISO(),
      by:   who,
      source: "departure_edit",
      note: `Departure changed: ${cur || "-"} → ${newTime}`
    });

    // ✅ Firestore: update 1 mission + add event
    try{
      await fsUpdateMission(
        m.id,
        "DEPARTURE_EDIT",
        who,
        `Departure changed: ${cur || "-"} → ${newTime}`,
        {
          details: m.details,
          date: getMissionDateISO(m),
          missionDateISO: getMissionDateISO(m),
          statusCurrent: m.status,
          status: m.status
        }
      );
    }catch(err){
      console.error(err);
      alert("บันทึกเข้า Firestore ไม่สำเร็จ (ตรวจเน็ต/สิทธิ์) กรุณาลองใหม่");
      return;
    }

    closeEditModal();

    // ✅ refresh detail modal immediately (optional)
    if (modalOverlay && modalOverlay.style.display === "flex" && currentMissionId){
      if (typeof refreshOpenDetailsIfAny === "function") refreshOpenDetailsIfAny();
    }
  });
}

/* =======================
   ✅ Reschedule button in detail modal
======================= */
if (editTimeBtn){
  editTimeBtn.addEventListener("click", () => {
    if (!currentMissionId) return;
    openRescheduleFromFollowUp(currentMissionId);
  });
}

/* =======================
   ✅ Controls
======================= */
if (search) search.addEventListener("input", render);
if (statusFilter) statusFilter.addEventListener("change", render);
if (dateFilter) dateFilter.addEventListener("change", render);

if (exportMonthBtn) exportMonthBtn.addEventListener("click", () => exportCSV("month"));
if (exportYearBtn)  exportYearBtn.addEventListener("click", () => exportCSV("year"));


/* =======================
   ✅ MIDNIGHT AUTO ROLLOVER (Day change watcher)
   - If user is viewing "today", auto-switch to new day at midnight
   - If user selected another date, do nothing
======================= */
(function setupDayRollover(){
  const dateEl = document.getElementById("dateFilter");
  if (!dateEl) return;

  // remember the day when page started (local TH time)
  let lastDay = toISODateLocal(new Date());

  // check every 20s (lightweight)
  setInterval(() => {
    const nowDay = toISODateLocal(new Date());
    if (nowDay === lastDay) return;

    // day changed!
    const currentPicked = String(dateEl.value || "").trim();

    // ✅ only auto-advance if user was viewing lastDay (i.e., "today")
    // or if date is empty
    if (!currentPicked || currentPicked === lastDay){
      dateEl.value = nowDay;
      safeRender();
    }

    lastDay = nowDay;
  }, 20000);
})();

/* =======================
   ✅ Realtime listener (operation.html will notify)
======================= */
onSyncMessage(async () => {
  // ✅ reload source-of-truth ก่อนทุกครั้งที่มี sync ping
  window.CURRENT_MISSIONS = await readMissionsSourceOfTruth();

  await render();

  if (modalOverlay && modalOverlay.style.display === "flex"){
    refreshOpenDetailsIfAny();
  }
});

console.log("fsUpdateMission ready:", typeof fsUpdateMission);

/* =======================
   ✅ First boot
======================= */
(async function boot(){
  // set default date filter once
  const todayISO = toISODateLocal(new Date());
  if (dateFilter && !dateFilter.value) dateFilter.value = todayISO;

  window.CURRENT_MISSIONS = await readMissionsSourceOfTruth();
  await render();
})();

/* =========================================================
   ✅ LOOK-AHEAD AUTO REFRESH (22:30 gate + midnight drop)
   - ensures "+1" appears after 22:30 and disappears after midnight
   - works for both index.html and operation.html
========================================================= */

(function setupLookAheadWatcher(){
  const dateEl = document.getElementById("dateFilter"); // may not exist in operation.html
  const GATE_HHMM = "22:30";

  function pad2(n){ return String(n).padStart(2,"0"); }
  function toISODateLocal(d){
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }
  function toDT(dayISO, hhmm){
    const m = /^(\d{2}):(\d{2})$/.exec(String(hhmm||"").trim());
    if(!m) return null;
    const d = new Date(dayISO + "T00:00:00");
    d.setHours(Number(m[1]), Number(m[2]), 0, 0);
    return d;
  }
  function getSelectedDay(){
    // if no date filter, assume "today view"
    if (!dateEl) return toISODateLocal(new Date());
    return String(dateEl.value || "").slice(0,10) || toISODateLocal(new Date());
  }

  function fireRender(){
    try{
      if (typeof window.safeRender === "function") window.safeRender();
      else if (typeof window.render === "function") window.render();
    }catch(e){
      console.error(e);
    }
  }

  // --- state tracking ---
  let lastNowDay = toISODateLocal(new Date());
  let lastGateOpen = null; // null = unknown

  function computeGateOpen(){
    const now = new Date();
    const todayISO = toISODateLocal(now);
    const selectedDay = getSelectedDay();

    // gate only matters when user views "today"
    if (selectedDay !== todayISO) return false;

    const gateDT = toDT(todayISO, GATE_HHMM);
    return gateDT ? (now >= gateDT) : false;
  }

  function tick(){
    const now = new Date();
    const nowDay = toISODateLocal(now);
    const selectedDay = getSelectedDay();

    // 1) midnight: day changed -> if user is viewing "today", advance dateFilter and rerender
    if (nowDay !== lastNowDay){
      if (dateEl){
        const picked = String(dateEl.value || "").slice(0,10);
        // if user was viewing previous "today" (or empty), auto-advance
        if (!picked || picked === lastNowDay){
          dateEl.value = nowDay;
        }
      }
      fireRender(); // ✅ drop +1 immediately after midnight
      lastNowDay = nowDay;

      // recompute gate state for new day
      lastGateOpen = computeGateOpen();
      return;
    }

    // 2) 22:30 gate: when it flips, rerender so +1 appears (or disappears if user changes date)
    const gateOpen = computeGateOpen();
    if (lastGateOpen === null) lastGateOpen = gateOpen;

    if (gateOpen !== lastGateOpen){
      fireRender();
      lastGateOpen = gateOpen;
    }
  }

  // tick frequently but light
  setInterval(tick, 15 * 1000);
  tick(); // run once
})();

</script>



<script type="module">
  // =========================================================
  // ✅ SINGLE SOURCE OF TRUTH (BY-YEAR)
  // - Expose low-level Firestore functions for non-module scripts
  // - Expose stable DB bridge APIs (save/update/load/listenByYear)
  // - Listen missions by selected year ONLY (no 48h listener)
  // =========================================================

  import {
    addEventAndUpdateMission,
    deleteMission
  } from "./firebase_db.js";

  import {
    saveMission,
    updateMission,
    loadAllMissions,
    listenMissionsByYear
  } from "./firestore_bridge.js";

  // ✅ expose ให้ script ธรรมดาเรียกใช้ได้ (ที่คุณใช้ใน fsUpdateMission / fsDeleteMission)
  window.__addEventAndUpdateMission = addEventAndUpdateMission;
  window.__deleteMission = deleteMission;

  // ✅ expose stable APIs (bridge)
  window.DB = {
    saveMission,
    updateMission,
    loadAllMissions,
    listenMissionsByYear
  };

  console.log("DB bridge ready:", Object.keys(window.DB));

  /* =========================
     Canonical helpers (กันซ้ำ + normalize)
  ========================= */
  function normalizeId(x){
    return String(x ?? "").trim();
  }

  function normStatus(s){
    const raw = String(s ?? "").trim();
    if (!raw) return "Scheduled";
    const k = raw.toLowerCase();
    if (k === "activated") return "Activated";
    if (k === "scheduled") return "Scheduled";
    if (k === "preparing") return "Preparing";
    if (k === "delayed") return "Delayed";
    if (k === "transporting") return "Transporting";
    if (k === "returning") return "Returning";
    if (k === "completed") return "Completed";
    if (k === "cancelled" || k === "canceled") return "Cancelled";
    if (k === "aborted") return "Aborted";
    if (k === "pending") return "Pending";
    return raw;
  }

  // ✅ map for index: ทำให้ schema เสถียร + status/date มาจากที่ถูกต้อง
  function mapForIndex(m){
    const details = m?.details || {};

    // canonical id
    const canonical = normalizeId(m?.id || m?.missionId || details?.id);

    // status priority: details.status -> statusCurrent -> status -> details.Status
    const stRaw =
      details?.status ?? m?.statusCurrent ?? m?.status ?? details?.Status ?? "";

    // date priority (YYYY-MM-DD)
    const dateRaw =
      m?.missionDateISO ?? m?.date ?? details?.missionDateISO ?? details?.dateISO ?? details?.date ?? "";

    // ✅ keep details.status synced for old UI functions
    const st = normStatus(stRaw);

    return {
      ...m,
      id: canonical,
      missionId: canonical,
      details: { ...details, id: canonical, status: st },
      status: st,
      date: String(dateRaw || "").slice(0,10),
      // keep missionDateISO if exists / derive from date
      missionDateISO: String(m?.missionDateISO || dateRaw || "").slice(0,10)
    };
  }

  // ✅ dedupe array by id (keep last write)
  function dedupeById(arr){
    const byId = new Map();
    for (const m of (arr || [])){
      const id = normalizeId(m?.id);
      if (!id) continue;
      byId.set(id, m);
    }
    return [...byId.values()];
  }

  // ✅ helper: pick year from dateFilter (if exists)
  function getSelectedYear(){
    const df = document.getElementById("dateFilter");
    const sel = (df && df.value) ? String(df.value).slice(0,10) : "";
    if (sel && /^\d{4}-\d{2}-\d{2}$/.test(sel)) return sel.slice(0,4);
    return String(new Date().getFullYear());
  }

  function triggerRender(){
    if (typeof window.safeRender === "function") window.safeRender();
    else if (typeof window.render === "function") window.render();
  }

  function applyData(arr){
    const mapped = (Array.isArray(arr) ? arr : []).map(mapForIndex);
    const unique = dedupeById(mapped);

    window.DATA_SOURCE = "firestore";
    window.FIRESTORE_MISSIONS = unique;

    triggerRender();
  }

  // =========================================================
  // ✅ Start BY-YEAR listener (single source of truth)
  // =========================================================
  function startYearListener(year){
    const y = String(year || "").slice(0,4);
    if (!/^\d{4}$/.test(y)) return;

    // stop old
    if (window.__FS_UNSUB__) { try{ window.__FS_UNSUB__(); }catch{} }

    window.__FS_YEAR__ = y;
    window.__FS_UNSUB__ = window.DB.listenMissionsByYear(
      y,
      (arr)=> applyData(arr),
      (err)=> console.warn("listenMissionsByYear error:", err)
    );

    console.log("Firestore listening year:", y);
  }

  // boot
  startYearListener(getSelectedYear());

  // switch year when dateFilter changes
  const df = document.getElementById("dateFilter");
  df?.addEventListener("change", ()=>{
    const y2 = getSelectedYear();
    if (y2 === window.__FS_YEAR__) return;
    startYearListener(y2);
  });
</script>



</body>
</html>